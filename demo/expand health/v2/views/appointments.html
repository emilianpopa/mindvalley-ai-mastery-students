<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Appointments - ExpandHealth</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cline x1='20' y1='20' x2='80' y2='80' stroke='%230F766E' stroke-width='12' stroke-linecap='round'/%3E%3Cline x1='80' y1='20' x2='20' y2='80' stroke='%230F766E' stroke-width='12' stroke-linecap='round'/%3E%3C/svg%3E">
  <link rel="stylesheet" href="/css/main.css">
  <script src="/js/feature-flags.js"></script>
  <script src="/js/nav.js"></script>
  <style>
    .appointments-page {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* Top Header */
    .appointments-header {
      display: flex;
      flex-direction: column;
      background: white;
      border-bottom: 1px solid var(--gray-200);
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 24px;
    }

    .header-row:first-child {
      padding-top: 16px;
    }

    .header-row:last-child {
      padding-bottom: 12px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .business-name {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .location-icon {
      width: 20px;
      height: 20px;
      color: var(--teal-500);
      cursor: pointer;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Global Utility Bar */
    .global-utility-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 8px 24px;
      background: white;
      border-bottom: 1px solid var(--gray-200);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .utility-bar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .utility-bar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Business selector */
    .business-selector {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: transparent;
      border: none;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
    }

    .business-selector:hover {
      background: var(--gray-100);
    }

    .business-selector svg {
      width: 14px;
      height: 14px;
      color: var(--gray-400);
    }

    /* Search box */
    .utility-search {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      min-width: 200px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .utility-search:hover {
      border-color: var(--gray-300);
    }

    .utility-search svg {
      width: 16px;
      height: 16px;
      color: var(--gray-400);
    }

    .utility-search-text {
      font-size: 0.8125rem;
      color: var(--gray-500);
      flex: 1;
    }

    .utility-search-shortcut {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 4px;
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--gray-500);
    }

    .utility-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: transparent;
      border: none;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
    }

    .utility-btn:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .utility-btn svg {
      width: 16px;
      height: 16px;
    }

    .utility-btn.feedback-btn {
      color: var(--purple-600);
    }

    .utility-btn.feedback-btn:hover {
      background: var(--purple-50);
    }

    .utility-btn.active {
      background: var(--purple-600);
      color: white;
    }

    .utility-btn.active:hover {
      background: var(--purple-700);
    }

    .utility-divider {
      width: 1px;
      height: 20px;
      background: var(--gray-200);
    }

    .utility-add-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .utility-add-label {
      font-size: 0.8125rem;
      color: var(--gray-500);
    }

    .utility-add-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: transparent;
      border: 1px solid var(--gray-300);
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-700);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
    }

    .utility-add-btn:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    .utility-add-btn svg {
      width: 14px;
      height: 14px;
    }

    .utility-notification-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: transparent;
      border: none;
      color: var(--gray-500);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
    }

    .utility-notification-btn:hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .utility-notification-btn svg {
      width: 18px;
      height: 18px;
    }

    .utility-user-menu {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      background: transparent;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
    }

    .utility-user-menu:hover {
      background: var(--gray-100);
    }

    .utility-user-avatar {
      width: 28px;
      height: 28px;
      background: var(--purple-100);
      color: var(--purple-700);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .utility-user-name {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-700);
    }

    .utility-user-menu svg {
      width: 14px;
      height: 14px;
      color: var(--gray-400);
    }

    /* User dropdown */
    .utility-user-dropdown {
      position: relative;
    }

    .user-dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      min-width: 200px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      padding: 8px 0;
    }

    .user-dropdown-menu.show {
      display: block;
    }

    .user-dropdown-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
      transition: background 0.15s;
      text-decoration: none;
    }

    .user-dropdown-item:hover {
      background: var(--gray-50);
    }

    .user-dropdown-item-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-dropdown-item svg {
      width: 16px;
      height: 16px;
      color: var(--gray-500);
    }

    .user-dropdown-item .chevron-right {
      width: 14px;
      height: 14px;
      color: var(--gray-400);
    }

    .user-dropdown-item .flag-icon {
      width: 18px;
      height: 14px;
      border-radius: 2px;
    }

    .user-dropdown-divider {
      height: 1px;
      background: var(--gray-200);
      margin: 8px 0;
    }

    /* Switch dashboard sub-item */
    .user-dropdown-dashboard {
      padding: 12px 16px;
      border-bottom: 1px solid var(--gray-100);
    }

    .user-dropdown-dashboard-email {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-900);
      margin-bottom: 2px;
    }

    .user-dropdown-dashboard-label {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .btn-checkout {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: white;
      border: 1px solid var(--purple-600);
      color: var(--purple-600);
      font-size: 0.875rem;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-checkout:hover {
      background: var(--purple-50);
    }

    /* Checkout dropdown */
    .checkout-dropdown {
      position: relative;
    }

    .checkout-dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      min-width: 200px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      padding: 4px 0;
    }

    .checkout-dropdown-menu.show {
      display: block;
    }

    .checkout-dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
      transition: background 0.15s;
      text-decoration: none;
    }

    .checkout-dropdown-item:hover {
      background: var(--gray-50);
    }

    .checkout-dropdown-item svg {
      width: 16px;
      height: 16px;
      color: var(--gray-500);
    }

    .btn-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: var(--purple-600);
      color: white;
      border: none;
      font-size: 0.875rem;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
    }

    .btn-actions:hover {
      background: var(--purple-700);
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px 24px;
      background: white;
      border-bottom: 1px solid var(--gray-200);
    }

    .toolbar-row {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .toolbar-row-between {
      justify-content: space-between;
    }

    /* Day/Week Toggle */
    .view-toggle {
      display: inline-flex;
      background: var(--gray-100);
      border-radius: 8px;
      padding: 4px;
    }

    .view-toggle-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: transparent;
      border: none;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-600);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .view-toggle-btn.active {
      background: white;
      color: var(--gray-900);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .view-toggle-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Week Navigation */
    .week-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .week-nav-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      cursor: pointer;
      color: var(--gray-600);
    }

    .week-nav-btn:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    .week-display {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
    }

    .week-display svg {
      width: 16px;
      height: 16px;
      color: var(--gray-400);
    }

    /* Filter Dropdowns */
    .filter-dropdown {
      position: relative;
    }

    .filter-dropdown-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
      min-width: 180px;
    }

    .filter-dropdown-btn:hover {
      border-color: var(--gray-400);
    }

    .filter-dropdown-btn svg {
      width: 16px;
      height: 16px;
      color: var(--gray-400);
    }

    .filter-dropdown-btn .chevron {
      margin-left: auto;
    }

    .filter-dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      min-width: 220px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 100;
      max-height: 300px;
      overflow-y: auto;
    }

    .filter-dropdown-menu.show {
      display: block;
    }

    .filter-dropdown-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
      transition: background 0.15s;
    }

    .filter-dropdown-item:hover {
      background: var(--gray-50);
    }

    .filter-dropdown-item.selected {
      background: var(--purple-50);
      color: var(--purple-700);
    }

    /* Staff/Venues Toggle */
    .staff-venues-toggle {
      display: inline-flex;
      background: var(--gray-100);
      border-radius: 8px;
      padding: 4px;
    }

    .staff-venues-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      background: transparent;
      border: none;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-600);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .staff-venues-btn.active {
      background: white;
      color: var(--gray-900);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .staff-venues-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Zoom buttons */
    .zoom-buttons {
      display: flex;
      gap: 4px;
    }

    .zoom-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      cursor: pointer;
      color: var(--gray-600);
    }

    .zoom-btn:hover {
      background: var(--gray-50);
    }

    .zoom-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Options/Filters buttons */
    .toolbar-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .toolbar-btn:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    .toolbar-btn.active {
      background: var(--purple-600);
      border-color: var(--purple-600);
      color: white;
    }

    .toolbar-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Dropdown menus */
    .dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      min-width: 280px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 100;
      padding: 8px 0;
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
      transition: background 0.15s;
    }

    .dropdown-checkbox-item:hover {
      background: var(--gray-50);
    }

    .dropdown-checkbox-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--purple-600);
    }

    .dropdown-action-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
      transition: background 0.15s;
    }

    .dropdown-action-item:hover {
      background: var(--gray-50);
    }

    .dropdown-action-item svg {
      width: 16px;
      height: 16px;
      color: var(--gray-500);
    }

    /* Calendar Grid */
    .calendar-container {
      flex: 1;
      overflow: auto;
      background: white;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: 60px repeat(7, 1fr);
      min-height: 100%;
    }

    /* Calendar Header */
    .calendar-header {
      display: contents;
    }

    .calendar-header-corner {
      position: sticky;
      top: 0;
      left: 0;
      background: white;
      z-index: 20;
      border-bottom: 1px solid var(--gray-200);
      border-right: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 0.75rem;
      color: var(--gray-400);
    }

    .calendar-header-corner svg {
      width: 14px;
      height: 14px;
    }

    .calendar-header-day {
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
      padding: 12px 8px;
      text-align: center;
      border-bottom: 1px solid var(--gray-200);
      border-right: 1px solid var(--gray-100);
    }

    .calendar-header-day:last-child {
      border-right: none;
    }

    .day-full-date {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-700);
    }

    .day-full-date.today {
      color: var(--purple-600);
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .day-full-date.weekend {
      color: var(--gray-400);
    }

    .day-name {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--gray-500);
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .day-date {
      font-size: 0.9375rem;
      font-weight: 500;
      color: var(--gray-900);
    }

    .day-date.today {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: var(--purple-600);
      color: white;
      border-radius: 50%;
    }

    .day-date.weekend {
      color: var(--gray-400);
    }

    /* Time Column */
    .time-column {
      display: contents;
    }

    .time-slot-label {
      position: sticky;
      left: 0;
      background: white;
      z-index: 5;
      padding: 0 8px;
      font-size: 0.75rem;
      color: var(--gray-500);
      text-align: right;
      border-right: 1px solid var(--gray-200);
      height: 60px;
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
      padding-top: 0;
      transform: translateY(-8px);
    }

    /* Day Columns */
    .day-column {
      display: contents;
    }

    .time-slot {
      border-bottom: 1px solid var(--gray-100);
      border-right: 1px solid var(--gray-100);
      height: 80px; /* Taller slots like Momence */
      position: relative;
      cursor: pointer;
    }

    .time-slot:hover {
      background: var(--gray-50);
    }

    .time-slot.weekend {
      background: var(--gray-50);
    }

    .time-slot.weekend:hover {
      background: var(--gray-100);
    }

    /* Venues Mode Header */
    .venue-header {
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
      padding: 8px;
      text-align: center;
      border-bottom: 1px solid var(--gray-200);
      border-right: 1px solid var(--gray-100);
      min-width: 120px;
    }

    .venue-name {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-900);
      margin-bottom: 4px;
    }

    .venue-color {
      height: 3px;
      border-radius: 2px;
      margin-top: 4px;
    }

    /* Toolbar right group */
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Clock Status Toast */
    .clock-status-toast {
      position: fixed;
      bottom: 16px;
      left: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      min-width: 140px;
    }

    .clock-status-toast.clocked-in {
      border-left: 4px solid var(--green-500);
    }

    .clock-status-toast.clocked-out {
      border-left: 4px solid var(--teal-500);
    }

    .clock-status-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .clock-status-icon.clocked-in svg {
      color: var(--green-500);
    }

    .clock-status-icon.clocked-out svg {
      color: var(--teal-500);
    }

    .clock-status-text {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-700);
      flex: 1;
    }

    .clock-status-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      background: transparent;
      border: none;
      color: var(--gray-400);
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s;
    }

    .clock-status-close:hover {
      background: var(--gray-100);
      color: var(--gray-600);
    }

    .clock-status-close svg {
      width: 14px;
      height: 14px;
    }

    .clock-status-toast.hidden {
      display: none;
    }

    /* Appointment Detail Slide Panel */
    .appointment-panel-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .appointment-panel-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .appointment-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 480px;
      height: 100vh;
      background: white;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .appointment-panel.show {
      transform: translateX(0);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-200);
    }

    .panel-header-left {
      flex: 1;
    }

    .panel-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 2px;
    }

    .panel-id {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .panel-header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .panel-status-badge {
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .panel-status-badge.scheduled {
      background: var(--blue-100);
      color: var(--blue-700);
    }

    .panel-status-badge.paid {
      background: var(--green-100);
      color: var(--green-700);
    }

    .panel-status-badge.completed {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .panel-status-badge.cancelled {
      background: var(--red-100);
      color: var(--red-700);
    }

    .panel-close-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: var(--gray-400);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
    }

    .panel-close-btn:hover {
      background: var(--gray-100);
      color: var(--gray-600);
    }

    .panel-close-btn svg {
      width: 18px;
      height: 18px;
    }

    /* Signups Section */
    .panel-signups {
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-200);
    }

    .panel-signups-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .panel-signups-badge {
      padding: 4px 10px;
      background: var(--blue-100);
      color: var(--blue-700);
      font-size: 0.75rem;
      font-weight: 500;
      border-radius: 4px;
    }

    .panel-checkin-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8125rem;
      color: var(--gray-600);
    }

    .panel-signup-card {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: var(--gray-50);
      border-radius: 8px;
    }

    .panel-signup-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .panel-signup-avatar svg {
      width: 18px;
      height: 18px;
      color: var(--gray-500);
    }

    .panel-signup-info {
      flex: 1;
      min-width: 0;
    }

    .panel-signup-name {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--teal-600);
      margin-bottom: 2px;
    }

    .panel-signup-contact {
      font-size: 0.75rem;
      color: var(--gray-600);
      line-height: 1.4;
    }

    .panel-signup-badges {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
    }

    .panel-mini-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.6875rem;
      font-weight: 500;
    }

    .panel-mini-badge.price {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .panel-mini-badge.paid {
      background: var(--green-100);
      color: var(--green-700);
    }

    .panel-mini-badge.free {
      background: var(--gray-100);
      color: var(--gray-600);
    }

    .panel-signup-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .panel-toggle {
      width: 40px;
      height: 22px;
      background: var(--gray-200);
      border-radius: 11px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .panel-toggle.active {
      background: var(--green-500);
    }

    .panel-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }

    .panel-toggle.active::after {
      transform: translateX(18px);
    }

    .panel-checkin-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-checkin-time {
      font-size: 0.75rem;
      color: var(--gray-500);
      white-space: nowrap;
      display: none;
    }

    .panel-checkin-time.show {
      display: inline;
    }

    .panel-more-btn {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      color: var(--gray-400);
      cursor: pointer;
      border-radius: 4px;
    }

    .panel-more-btn:hover {
      background: var(--gray-100);
      color: var(--gray-600);
    }

    .panel-more-wrapper {
      position: relative;
    }

    .panel-signup-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      min-width: 200px;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.15s ease;
    }

    .panel-signup-menu.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(4px);
    }

    .panel-signup-menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 12px 16px;
      background: none;
      border: none;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
      text-align: left;
      transition: background 0.15s;
    }

    .panel-signup-menu-item:first-child {
      border-radius: 8px 8px 0 0;
    }

    .panel-signup-menu-item:last-child {
      border-radius: 0 0 8px 8px;
    }

    .panel-signup-menu-item:hover {
      background: var(--gray-50);
    }

    .panel-signup-menu-item svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .panel-signup-menu-item.cancel {
      color: var(--red-600);
    }

    .panel-signup-menu-item.cancel:hover {
      background: var(--red-50);
    }

    /* Add Customer Button */
    .panel-add-customer {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 10px;
      margin-top: 12px;
      background: white;
      border: 1px dashed var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.15s;
    }

    .panel-add-customer:hover {
      border-color: var(--gray-400);
      color: var(--gray-700);
    }

    .panel-add-customer svg {
      width: 16px;
      height: 16px;
    }

    /* Panel Tabs */
    .panel-tabs {
      display: flex;
      gap: 20px;
      padding: 0 20px;
      border-bottom: 1px solid var(--gray-200);
    }

    .panel-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 12px 0;
      border: none;
      background: transparent;
      font-size: 0.875rem;
      color: var(--gray-500);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all 0.15s;
    }

    .panel-tab:hover {
      color: var(--gray-700);
    }

    .panel-tab.active {
      color: var(--purple-600);
      border-bottom-color: var(--purple-600);
    }

    .panel-tab svg {
      width: 16px;
      height: 16px;
    }

    /* Panel Content */
    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .panel-section {
      margin-bottom: 20px;
    }

    .panel-section-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--gray-500);
      margin-bottom: 12px;
    }

    .panel-info-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }

    .panel-info-row:last-child {
      margin-bottom: 0;
    }

    .panel-info-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: var(--purple-100);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .panel-info-icon svg {
      width: 16px;
      height: 16px;
      color: var(--purple-600);
    }

    .panel-info-icon.gray {
      background: var(--gray-100);
    }

    .panel-info-icon.gray svg {
      color: var(--gray-600);
    }

    .panel-info-icon.teal {
      background: var(--teal-100);
    }

    .panel-info-icon.teal svg {
      color: var(--teal-600);
    }

    .panel-info-icon.green {
      background: var(--green-100);
    }

    .panel-info-icon.green svg {
      color: var(--green-600);
    }

    .panel-info-content {
      flex: 1;
    }

    .panel-info-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-900);
    }

    .panel-info-sublabel {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 2px;
    }

    .panel-info-link {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--purple-600);
      text-decoration: none;
    }

    .panel-info-link:hover {
      text-decoration: underline;
    }

    /* Practitioner Row - Side by Side */
    .panel-practitioner-row {
      display: flex;
      align-items: flex-start;
      gap: 24px;
    }

    .panel-practitioner-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Pricing Section */
    .panel-pricing-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .panel-price-label {
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    .panel-price-value {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .panel-price-credits {
      font-size: 0.75rem;
      color: var(--gray-500);
      font-weight: 400;
    }

    .panel-price-type {
      display: inline-block;
      margin-top: 8px;
      padding: 4px 10px;
      background: var(--blue-100);
      color: var(--blue-700);
      font-size: 0.75rem;
      font-weight: 500;
      border-radius: 4px;
    }

    /* Service Section */
    .panel-service-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .panel-service-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: var(--green-500);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .panel-service-icon svg {
      width: 16px;
      height: 16px;
      color: white;
    }

    .panel-service-name {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--purple-600);
    }

    .panel-service-board {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .panel-service-row-clickable {
      cursor: pointer;
      border-radius: 8px;
      padding: 8px;
      margin: -8px;
      transition: background-color 0.15s;
    }

    .panel-service-row-clickable:hover {
      background-color: var(--gray-50);
    }

    .panel-service-row-clickable .panel-service-name {
      text-decoration: none;
    }

    .panel-service-row-clickable:hover .panel-service-name {
      text-decoration: underline;
    }

    /* Add to Calendar */
    .panel-add-calendar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 12px;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.15s;
      margin-top: 16px;
    }

    .panel-add-calendar:hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .panel-add-calendar svg {
      width: 18px;
      height: 18px;
    }

    /* Panel Footer */
    .panel-footer {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--gray-200);
      background: white;
    }

    .panel-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .panel-btn svg {
      width: 16px;
      height: 16px;
    }

    .panel-btn-cancel {
      background: var(--red-500);
      border: none;
      color: white;
    }

    .panel-btn-cancel:hover {
      background: var(--red-600);
    }

    .panel-btn-edit {
      background: var(--purple-600);
      border: none;
      color: white;
    }

    .panel-btn-edit:hover {
      background: var(--purple-700);
    }

    .panel-btn-paid {
      background: white;
      border: 1px solid var(--green-500);
      color: var(--green-600);
    }

    .panel-btn-paid:hover {
      background: var(--green-50);
    }

    /* Add Customer Modal */
    .add-customer-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .add-customer-modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .add-customer-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      z-index: 2001;
      width: 480px;
      max-width: 90vw;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .add-customer-modal.show {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    .add-customer-modal-header {
      display: flex;
      align-items: center;
      padding: 20px 20px 12px 20px;
      gap: 12px;
    }

    .add-customer-modal-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .modal-header-spacer {
      flex: 1;
    }

    .modal-limit-badge {
      background: #FEE2E2;
      color: #DC2626;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .modal-close-btn {
      background: none;
      border: none;
      padding: 4px;
      cursor: pointer;
      color: var(--gray-500);
      border-radius: 4px;
    }

    .modal-close-btn:hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .modal-close-btn svg {
      width: 20px;
      height: 20px;
    }

    .add-customer-modal-body {
      padding: 0 20px 20px 20px;
    }

    .modal-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    .modal-select-row {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .modal-select {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-700);
      background: white;
      cursor: pointer;
    }

    .modal-select:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }

    .modal-add-new-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      cursor: pointer;
      color: var(--gray-600);
      transition: all 0.15s;
    }

    .modal-add-new-btn:hover {
      background: var(--gray-200);
      color: var(--gray-800);
    }

    .modal-add-new-btn svg {
      width: 18px;
      height: 18px;
    }

    .modal-checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
    }

    .modal-checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--purple-600);
    }

    .modal-actions-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 16px;
      gap: 16px;
    }

    .modal-buttons {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .modal-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .modal-btn-cancel {
      background: white;
      border: 1px solid var(--gray-300);
      color: var(--gray-700);
    }

    .modal-btn-cancel:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }

    .modal-btn-add {
      background: #2563eb;
      border: 1px solid #2563eb;
      color: white;
    }

    .modal-btn-add:hover {
      background: #1d4ed8;
      border-color: #1d4ed8;
    }

    .modal-btn-add:disabled {
      background: var(--gray-300);
      border-color: var(--gray-300);
      cursor: not-allowed;
    }

    /* Create Customer Modal */
    .create-customer-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2100;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .create-customer-modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .create-customer-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      z-index: 2101;
      width: 360px;
      max-width: 90vw;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .create-customer-modal.show {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    .create-customer-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 20px 16px 20px;
    }

    .create-customer-modal-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .create-customer-modal-body {
      padding: 0 20px 20px 20px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-600);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-800);
      background: white;
      box-sizing: border-box;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }

    .phone-input-row {
      display: flex;
      gap: 8px;
    }

    .country-code-select {
      width: 100px;
      padding: 10px 8px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-800);
      background: white;
      cursor: pointer;
    }

    .country-code-select:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }

    .phone-input {
      flex: 1;
    }

    .create-customer-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--gray-200);
    }

    .modal-btn-create {
      background: var(--purple-600);
      border: 1px solid var(--purple-600);
      color: white;
    }

    .modal-btn-create:hover {
      background: var(--purple-700);
      border-color: var(--purple-700);
    }

    /* Edit Appointment Modal */
    .edit-apt-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .edit-apt-modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .edit-apt-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      z-index: 2001;
      width: 600px;
      max-width: 90vw;
      max-height: 90vh;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
    }

    .edit-apt-modal.show {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    .edit-apt-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
    }

    .edit-apt-modal-header h3 {
      margin: 0;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .edit-apt-modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .edit-apt-form-row {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      gap: 16px;
    }

    .edit-apt-form-row-top {
      align-items: flex-start;
    }

    .edit-apt-form-label {
      width: 140px;
      flex-shrink: 0;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
    }

    .edit-apt-form-value {
      font-size: 0.875rem;
      color: var(--gray-900);
    }

    .edit-apt-form-control {
      flex: 1;
    }

    .edit-apt-form-control-with-btn {
      display: flex;
      gap: 8px;
    }

    .edit-apt-form-input,
    .edit-apt-form-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-900);
      background: white;
    }

    .edit-apt-form-input:focus,
    .edit-apt-form-select:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .edit-apt-form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-900);
      resize: vertical;
      font-family: inherit;
    }

    .edit-apt-form-textarea:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .edit-apt-form-hint {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: -12px;
      margin-bottom: 20px;
      padding-left: 156px;
    }

    .edit-apt-add-btn {
      width: 40px;
      height: 40px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 1.25rem;
      color: var(--gray-600);
      cursor: pointer;
    }

    .edit-apt-add-btn:hover {
      background: var(--gray-200);
    }

    .edit-apt-duration-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .edit-apt-duration-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .edit-apt-duration-input {
      width: 70px;
      text-align: center;
    }

    .edit-apt-duration-label {
      font-size: 0.7rem;
      color: var(--gray-500);
      text-align: center;
    }

    .edit-apt-duration-unit {
      font-size: 0.875rem;
      color: var(--gray-600);
      align-self: center;
      padding-top: 10px;
    }

    .edit-apt-price-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .edit-apt-currency {
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    .edit-apt-price-input {
      width: 120px;
    }

    .edit-apt-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      border-top: 1px solid var(--gray-200);
      background: white;
    }

    .edit-apt-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .edit-apt-btn-cancel {
      background: white;
      border: 1px solid var(--gray-300);
      color: var(--gray-700);
    }

    .edit-apt-btn-cancel:hover {
      background: var(--gray-50);
    }

    .edit-apt-btn-save {
      background: var(--purple-600);
      border: none;
      color: white;
    }

    .edit-apt-btn-save:hover {
      background: var(--purple-700);
    }

    /* New Appointment Modal */
    .new-apt-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .new-apt-modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .new-apt-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      z-index: 2001;
      width: 480px;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .new-apt-modal.show {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    .new-apt-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 20px 16px 20px;
      border-bottom: 1px solid var(--gray-200);
    }

    .new-apt-modal-header h3 {
      margin: 0;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .new-apt-modal-body {
      padding: 20px;
    }

    .apt-type-toggle {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
      border: 2px solid var(--purple-500);
      border-radius: 8px;
      overflow: hidden;
    }

    .apt-type-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      border: none;
      background: white;
      font-size: 0.875rem;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.15s;
    }

    .apt-type-btn.active {
      background: var(--purple-500);
      color: white;
    }

    .apt-type-btn svg {
      width: 18px;
      height: 18px;
    }

    .apt-form-row {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
      gap: 16px;
    }

    .apt-form-label {
      width: 100px;
      flex-shrink: 0;
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    .apt-form-control {
      flex: 1;
    }

    .apt-form-select,
    .apt-form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-800);
      background: white;
      cursor: pointer;
    }

    .apt-form-select:focus,
    .apt-form-input:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }

    .apt-toggle-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .apt-toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--gray-200);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .apt-toggle.active {
      background: var(--purple-500);
    }

    .apt-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      pointer-events: none;
    }

    .apt-toggle.active::after {
      transform: translateX(20px);
    }

    .apt-toggle-label {
      font-size: 0.875rem;
      color: var(--gray-700);
    }

    .recurring-options {
      display: none;
    }

    .recurring-options.show {
      display: block;
    }

    .repeat-every-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .repeat-input {
      width: 80px !important;
      text-align: center;
    }

    .repeat-unit {
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    .ends-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ends-option {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ends-radio-btn {
      width: 20px;
      height: 20px;
      border: 2px solid var(--gray-300);
      border-radius: 50%;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      flex-shrink: 0;
    }

    .ends-radio-btn.active {
      border-color: var(--purple-500);
    }

    .ends-radio-btn .radio-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: transparent;
    }

    .ends-radio-btn.active .radio-dot {
      background: var(--purple-500);
    }

    .ends-label {
      font-size: 0.875rem;
      color: var(--gray-700);
      min-width: 40px;
    }

    .ends-date-input {
      width: 150px !important;
    }

    .ends-count-input {
      width: 70px !important;
      text-align: center;
    }

    .ends-unit {
      font-size: 0.75rem;
      color: var(--gray-500);
      text-transform: uppercase;
    }

    .customer-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .customer-row .apt-form-select {
      flex: 1;
    }

    .add-customer-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      color: var(--gray-600);
    }

    .add-customer-btn:hover {
      background: var(--gray-50);
    }

    .add-customer-btn svg {
      width: 18px;
      height: 18px;
    }

    .add-more-customer-btn {
      width: 100%;
      padding: 10px;
      border: 1px dashed var(--gray-300);
      border-radius: 8px;
      background: white;
      font-size: 0.875rem;
      color: var(--gray-600);
      cursor: pointer;
      margin-bottom: 16px;
    }

    .add-more-customer-btn:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    .duration-buffers-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .buffer-field {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .buffer-field input {
      width: 70px;
      padding: 10px 8px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      text-align: center;
    }

    .buffer-field input:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }

    .buffer-label {
      font-size: 0.6875rem;
      color: var(--gray-500);
      text-align: center;
    }

    .buffer-unit {
      font-size: 0.875rem;
      color: var(--gray-600);
      align-self: center;
      padding-top: 6px;
    }

    .price-input-row {
      display: flex;
      align-items: center;
      gap: 0;
    }

    .price-currency {
      padding: 10px 12px;
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-right: none;
      border-radius: 8px 0 0 8px;
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    .price-input-row input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 0 8px 8px 0;
      font-size: 0.875rem;
    }

    .price-note {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 6px;
    }

    .apt-form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }

    .apt-form-textarea:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }

    .new-apt-modal-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-top: 1px solid var(--gray-200);
    }

    .send-confirmation-check {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
      color: var(--gray-700);
    }

    .send-confirmation-check input {
      width: 18px;
      height: 18px;
      accent-color: var(--purple-500);
    }

    .modal-footer-buttons {
      display: flex;
      gap: 12px;
    }

    .apt-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .apt-btn-cancel {
      background: white;
      border: 1px solid var(--gray-300);
      color: var(--gray-700);
    }

    .apt-btn-cancel:hover {
      background: var(--gray-50);
    }

    .apt-btn-book-pay {
      background: white;
      border: 1px solid var(--gray-300);
      color: var(--gray-700);
    }

    .apt-btn-book-pay:hover {
      background: var(--gray-50);
    }

    .apt-btn-book {
      background: var(--purple-600);
      border: 1px solid var(--purple-600);
      color: white;
    }

    .apt-btn-book:hover {
      background: var(--purple-700);
      border-color: var(--purple-700);
    }

    .modal-btn-create:disabled {
      background: var(--gray-300);
      border-color: var(--gray-300);
      cursor: not-allowed;
    }

    /* Appointment Block Styles - Momence-style green with indicator */
    .appointment-block {
      position: relative;
      transition: filter 0.1s, box-shadow 0.1s;
      background: #4ade80 !important;
    }

    .appointment-block:hover {
      filter: brightness(0.95);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
    }

    /* Hover Tooltip - Momence-style (appears ABOVE the appointment) */
    .apt-tooltip {
      display: none;
      position: absolute;
      left: 0;
      bottom: calc(100% + 4px);
      min-width: 240px;
      max-width: 280px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15), 0 0 1px rgba(0,0,0,0.1);
      padding: 0;
      z-index: 1000;
      font-size: 0.8125rem;
      overflow: visible;
    }

    .appointment-block:hover .apt-tooltip {
      display: block;
    }

    /* Tooltip header with payment status */
    .apt-tooltip-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }

    .apt-tooltip-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .apt-tooltip-status-dot.paid {
      background: #22c55e;
    }

    .apt-tooltip-status-dot.unpaid {
      background: #ef4444;
    }

    .apt-tooltip-status-dot.confirmed {
      background: #eab308;
    }

    .apt-tooltip-status-text {
      font-size: 0.75rem;
      font-weight: 500;
      color: #64748b;
    }

    /* Tooltip body */
    .apt-tooltip-body {
      padding: 12px;
    }

    .apt-tooltip-service {
      font-weight: 600;
      color: #1e293b;
      font-size: 0.875rem;
      margin-bottom: 8px;
    }

    .apt-tooltip-client {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .apt-tooltip-client-name {
      font-weight: 500;
      color: #334155;
      font-size: 0.8125rem;
    }

    .apt-tooltip-client-email {
      font-size: 0.75rem;
      color: #64748b;
      margin-bottom: 10px;
    }

    .apt-tooltip-divider {
      height: 1px;
      background: #e2e8f0;
      margin: 10px 0;
    }

    .apt-tooltip-details {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .apt-tooltip-detail {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: #64748b;
    }

    .apt-tooltip-detail svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
      color: #94a3b8;
    }

    .apt-tooltip-detail-value {
      color: #475569;
    }

    /* Status indicator on appointment block */
    .apt-status-indicator {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      border: 1.5px solid white;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .apt-status-indicator.paid {
      background: #22c55e;
    }

    .apt-status-indicator.unpaid {
      background: #ef4444;
    }

    .apt-status-indicator.confirmed {
      background: #a855f7;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <svg class="logo-icon" width="28" height="28" viewBox="0 0 24 24" fill="none">
            <path d="M4 4L11 12L4 20" stroke="#0F766E" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M20 4L13 12L20 20" stroke="#0F766E" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div class="logo-text">
            <span class="logo-expand">EXPAND</span>
            <span class="logo-health">HEALTH</span>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section-title">AI</div>
        <a href="/" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
          <span>Dashboard</span>
        </a>
        <a href="/clients" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          <span>Clients</span>
        </a>

        <div class="nav-section-title">AI ADMIN</div>
        <a href="/forms" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
          <span>Forms</span>
        </a>
        <a href="/protocol-templates" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
          <span>Protocol Templates</span>
        </a>
        <a href="/admin" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
          <span>Admin Settings</span>
        </a>
        <a href="/kb-admin" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
          <span>AI Knowledge Base</span>
        </a>

        <div class="nav-section booking-nav">
          <div class="nav-section-title">BOOKING</div>
          <a href="/schedule" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>
            <span>Dashboard</span>
          </a>
          <a href="/inbox" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
            <span>Inbox</span>
          </a>
          <a href="/pos" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
            <span>Point of sale</span>
          </a>
          <div class="nav-dropdown">
            <div class="nav-dropdown-trigger">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              <span>Classes</span>
              <svg class="nav-dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </div>
            <div class="nav-dropdown-menu">
              <div class="nav-dropdown-header">CLASSES</div>
              <div class="nav-dropdown-section">SCHEDULING</div>
              <a href="/classes" class="nav-dropdown-item">Schedule</a>
              <a href="/class-templates" class="nav-dropdown-item">Class templates</a>
              <div class="nav-dropdown-section">PRACTITIONERS</div>
              <a href="/substitution-requests" class="nav-dropdown-item">Substitution requests</a>
            </div>
          </div>
          <div class="nav-dropdown">
            <div class="nav-dropdown-trigger active">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              <span>Appointments</span>
              <svg class="nav-dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </div>
            <div class="nav-dropdown-menu">
              <div class="nav-dropdown-header">APPOINTMENTS</div>
              <a href="/appointments" class="nav-dropdown-item active">Schedule</a>
              <a href="/reservations" class="nav-dropdown-item">Reservations</a>
              <a href="/services" class="nav-dropdown-item">Services & add-ons</a>
              <a href="/boards" class="nav-dropdown-item">Boards</a>
            </div>
          </div>
          <a href="/community" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            <span>Community</span>
          </a>
          <a href="/on-demand" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            <span>On-Demand</span>
          </a>
          <a href="/memberships" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <span>Memberships</span>
          </a>
          <a href="/discounts" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
            <span>Discount codes</span>
          </a>
          <a href="/customers" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            <span>Customers</span>
          </a>
          <a href="/leads" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
            <span>Marketing</span>
          </a>
          <a href="/analytics" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
            <span>Analytics</span>
          </a>
          <a href="/financials" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
            <span>Financials</span>
          </a>
        </div>

        <div class="nav-section booking-nav">
          <div class="nav-section-title">STUDIO SET-UP</div>
          <a href="/studio/practitioners" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            <span>Practitioners</span>
          </a>
          <a href="/services" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
            <span>Services</span>
          </a>
          <a href="/studio/locations" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
            <span>Locations</span>
          </a>
          <a href="/settings/attendance-rules" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
            <span>Attendance Rules</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="appointments-page">
        <!-- Global Utility Bar -->
        <div class="global-utility-bar">
          <div class="utility-bar-left">
            <!-- Business Selector -->
            <button class="business-selector">
              Expand Health (...
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
          </div>

          <div class="utility-bar-right">
            <button class="utility-btn feedback-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              Feedback
            </button>
            <div class="utility-divider"></div>
            <div class="utility-add-group">
              <span class="utility-add-label">Add:</span>
              <button class="utility-add-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="8.5" cy="7" r="4"></circle>
                  <line x1="20" y1="8" x2="20" y2="14"></line>
                  <line x1="23" y1="11" x2="17" y2="11"></line>
                </svg>
                Customer
              </button>
              <button class="utility-add-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="8.5" cy="7" r="4"></circle>
                  <polyline points="17 11 19 13 23 9"></polyline>
                </svg>
                Lead
              </button>
            </div>
            <div class="utility-divider"></div>
            <a href="/pos" class="utility-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                <line x1="8" y1="21" x2="16" y2="21"></line>
                <line x1="12" y1="17" x2="12" y2="21"></line>
              </svg>
              POS
            </a>
            <a href="/appointments" class="utility-btn active">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              Schedule
            </a>
            <div class="utility-divider"></div>
            <button class="utility-notification-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
              </svg>
            </button>
            <div class="utility-user-dropdown">
              <button class="utility-user-menu" onclick="toggleUserMenu()">
                <div class="utility-user-avatar">EP</div>
                <span class="utility-user-name">Emilian P.</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
              <div class="user-dropdown-menu" id="userDropdownMenu">
              <a href="/account" class="user-dropdown-item">
                <div class="user-dropdown-item-left">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                  Manage account
                </div>
              </a>
              <div class="user-dropdown-item">
                <div class="user-dropdown-item-left">
                  <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 30'%3E%3Crect fill='%23002868' width='60' height='30'/%3E%3Cg fill='%23fff'%3E%3Crect y='3.5' width='60' height='2.3'/%3E%3Crect y='9.2' width='60' height='2.3'/%3E%3Crect y='14.9' width='60' height='2.3'/%3E%3Crect y='20.6' width='60' height='2.3'/%3E%3Crect y='26.3' width='60' height='2.3'/%3E%3C/g%3E%3Crect fill='%23002868' width='24' height='16'/%3E%3C/svg%3E" class="flag-icon" alt="US">
                  English
                </div>
                <svg class="chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </div>
              <div class="user-dropdown-item">
                <div class="user-dropdown-item-left">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                  </svg>
                  Switch dashboard
                </div>
                <svg class="chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </div>
              <div class="user-dropdown-dashboard">
                <div class="user-dropdown-dashboard-email">emilian@expand.health</div>
                <div class="user-dropdown-dashboard-label">Customer dashboard</div>
              </div>
              <div class="user-dropdown-item" onclick="toggleClockStatus()">
                <div class="user-dropdown-item-left">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                  <span id="clockMenuItem">Clock in</span>
                </div>
              </div>
              <div class="user-dropdown-divider"></div>
              <a href="https://support.momence.com" target="_blank" class="user-dropdown-item">
                <div class="user-dropdown-item-left">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                  </svg>
                  Support
                </div>
              </a>
              <div class="user-dropdown-item" onclick="signOut()">
                <div class="user-dropdown-item-left">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                  </svg>
                  Sign Out
                </div>
              </div>
            </div>
            </div>
          </div>
        </div>

        <!-- Header -->
        <div class="appointments-header">
          <!-- Single row: Business name + Checkout/Actions + Staff/Venues toggle -->
          <div class="header-row">
            <div class="header-left">
              <h1 class="business-name">Expand Health</h1>
              <svg class="location-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
            </div>
            <div class="header-right">
              <div class="checkout-dropdown">
                <button class="btn-checkout" onclick="toggleCheckoutMenu()">
                  Checkout
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                  </svg>
                </button>
                <div class="checkout-dropdown-menu" id="checkoutMenu">
                  <a href="/single-reservation" class="checkout-dropdown-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6"></line>
                      <line x1="8" y1="2" x2="8" y2="6"></line>
                      <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    Single reservation flow
                  </a>
                  <a href="/multi-reservation" class="checkout-dropdown-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6"></line>
                      <line x1="8" y1="2" x2="8" y2="6"></line>
                      <line x1="3" y1="10" x2="21" y2="10"></line>
                      <line x1="9" y1="14" x2="15" y2="14"></line>
                      <line x1="9" y1="18" x2="15" y2="18"></line>
                    </svg>
                    Multi reservation flow
                  </a>
                </div>
              </div>
              <div class="filter-dropdown">
                <button class="btn-actions" onclick="toggleActionsMenu()">
                  Actions
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="19" cy="12" r="1"></circle>
                    <circle cx="5" cy="12" r="1"></circle>
                  </svg>
                </button>
                <div class="dropdown-menu" id="actionsMenu">
                  <div class="dropdown-action-item" onclick="editBoard()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Edit board
                  </div>
                  <div class="dropdown-action-item" onclick="openAppointmentSettings()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="3"></circle>
                      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    Appointment settings
                  </div>
                </div>
              </div>
              <!-- Staff/Venues Toggle -->
              <div class="staff-venues-toggle">
                <button class="staff-venues-btn active" data-mode="staff" onclick="setMode('staff')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                  Staff
                </button>
                <button class="staff-venues-btn" data-mode="venues" onclick="setMode('venues')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                  Venues
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
          <div class="toolbar-row toolbar-row-between">
            <div class="toolbar-left">
              <!-- Day/Week Toggle -->
              <div class="view-toggle">
                <button class="view-toggle-btn" data-view="day" onclick="setView('day')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                  Day
                </button>
                <button class="view-toggle-btn active" data-view="week" onclick="setView('week')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                  Week
                </button>
              </div>

              <!-- Week Navigation -->
              <div class="week-nav">
                <button class="week-nav-btn" onclick="prevWeek()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                  </svg>
                </button>
                <div class="week-display">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                  <span id="weekDisplay">Week 2, 2026</span>
                </div>
                <button class="week-nav-btn" onclick="nextWeek()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </button>
              </div>

              <!-- Location Dropdown (Main business location) -->
              <div class="filter-dropdown">
                <button class="filter-dropdown-btn" onclick="toggleDropdown('locationDropdown')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>
                  <span id="selectedLocation">Expand Health</span>
                  <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div class="filter-dropdown-menu" id="locationDropdown">
                  <div class="filter-dropdown-item selected" onclick="selectLocation('Expand Health')">Expand Health</div>
                </div>
              </div>

              <!-- Staff Dropdown (shown when Staff mode) -->
              <div class="filter-dropdown" id="staffDropdownContainer">
                <button class="filter-dropdown-btn" onclick="toggleDropdown('staffDropdown')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                  <span id="selectedStaff">All Staff</span>
                  <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div class="filter-dropdown-menu" id="staffDropdown">
                  <div class="filter-dropdown-item selected" onclick="selectStaff('All Staff')">All Staff</div>
                  <div class="filter-dropdown-item" onclick="selectStaff('Avela Jafta')">Avela Jafta</div>
                  <div class="filter-dropdown-item" onclick="selectStaff('Chantel Newmark')">Chantel Newmark</div>
                  <div class="filter-dropdown-item" onclick="selectStaff('Dr Melody Fourie')">Dr Melody Fourie</div>
                  <div class="filter-dropdown-item" onclick="selectStaff('Emilian Popa')">Emilian Popa</div>
                  <div class="filter-dropdown-item" onclick="selectStaff('Jack Harland')">Jack Harland</div>
                  <div class="filter-dropdown-item" onclick="selectStaff('Karrin Bamber')">Karrin Bamber</div>
                </div>
              </div>

              <!-- Venue/Room Dropdown (shown when Venues mode) -->
              <div class="filter-dropdown" id="venueDropdownContainer" style="display: none;">
                <button class="filter-dropdown-btn" onclick="toggleDropdown('venueDropdown')" style="border-color: var(--purple-300);">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                  <span id="selectedVenue">Compression boot location</span>
                  <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div class="filter-dropdown-menu" id="venueDropdown">
                  <div class="filter-dropdown-item" onclick="selectVenue('36457')">36457</div>
                  <div class="filter-dropdown-item selected" onclick="selectVenue('Compression boot location')">Compression boot location</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('Consult Room 1')">Consult Room 1</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('Consult Room 2')">Consult Room 2</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('Consult Room 3')">Consult Room 3</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('Drip Location')">Drip Location</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('Event Space')">Event Space</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('HBOT')">HBOT</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('Hocatt + Massage')">Hocatt + Massage</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('Ice bath 1')">Ice bath 1</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('Ice bath 2')">Ice bath 2</div>
                </div>
              </div>
            </div>

            <div class="toolbar-right">
              <!-- Zoom buttons -->
              <div class="zoom-buttons">
                <button class="zoom-btn" onclick="zoomOut()" title="Zoom out">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                </button>
                <button class="zoom-btn" onclick="zoomIn()" title="Zoom in">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                </button>
              </div>

              <!-- Options button -->
              <div class="filter-dropdown">
                <button class="toolbar-btn" onclick="toggleDropdown('optionsMenu')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                  Options
                </button>
                <div class="dropdown-menu" id="optionsMenu">
                  <label class="dropdown-checkbox-item">
                    <input type="checkbox" id="optCropHours" checked>
                    Crop all hours outside of available times
                  </label>
                  <label class="dropdown-checkbox-item">
                    <input type="checkbox" id="optCropEmpty">
                    Crop empty hours outside of first & last item
                  </label>
                  <label class="dropdown-checkbox-item">
                    <input type="checkbox" id="optSwapColors" checked>
                    Swap colors of background & status
                  </label>
                  <label class="dropdown-checkbox-item">
                    <input type="checkbox" id="optShowCustomFields">
                    Show contents of custom fields
                  </label>
                  <label class="dropdown-checkbox-item">
                    <input type="checkbox" id="optShowPrepFinish">
                    Show prep & finish parts of reservations
                  </label>
                  <label class="dropdown-checkbox-item">
                    <input type="checkbox" id="optShowBuffer">
                    Show buffer & overlap times of reservations
                  </label>
                </div>
              </div>

              <!-- Filters button -->
              <div class="filter-dropdown">
                <button class="toolbar-btn" onclick="toggleDropdown('filtersMenu')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                  Filters
                </button>
                <div class="dropdown-menu" id="filtersMenu">
                  <label class="dropdown-checkbox-item">
                    <input type="checkbox" id="filterCancelled">
                    Show cancelled appointments
                  </label>
                  <label class="dropdown-checkbox-item">
                    <input type="checkbox" id="filterLateCancelled" checked>
                    Show late cancelled appointments
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Calendar Grid -->
        <div class="calendar-container">
          <div class="calendar-grid" id="calendarGrid">
            <!-- Header row -->
            <div class="calendar-header-corner">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <span>GMT+2</span>
            </div>
            <div class="calendar-header-day" id="dayHeader0">
              <span class="day-full-date">Sun, Jan 4</span>
            </div>
            <div class="calendar-header-day" id="dayHeader1">
              <span class="day-full-date">Mon, Jan 5</span>
            </div>
            <div class="calendar-header-day" id="dayHeader2">
              <span class="day-full-date today">Tue, Jan 6</span>
            </div>
            <div class="calendar-header-day" id="dayHeader3">
              <span class="day-full-date">Wed, Jan 7</span>
            </div>
            <div class="calendar-header-day" id="dayHeader4">
              <span class="day-full-date">Thu, Jan 8</span>
            </div>
            <div class="calendar-header-day" id="dayHeader5">
              <span class="day-full-date">Fri, Jan 9</span>
            </div>
            <div class="calendar-header-day" id="dayHeader6">
              <span class="day-full-date weekend">Sat, Jan 10</span>
            </div>

            <!-- Time slots will be generated by JavaScript -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const token = localStorage.getItem('auth_token');
    if (!token) {
      window.location.href = '/login';
    }

    // State
    // Check for date parameter in URL (e.g., /appointments?date=2024-11-04)
    const urlParams = new URLSearchParams(window.location.search);
    const dateParam = urlParams.get('date');
    let currentDate = dateParam ? new Date(dateParam + 'T12:00:00') : new Date();
    let currentView = 'week';
    let slotHeight = 80; // Taller slots like Momence for better visibility
    let appointments = [];
    let selectedAppointment = null;
    let isCheckedIn = false;
    let clients = [];

    // New appointment modal state
    let newAptServices = [];
    let newAptStaffList = [];
    let newAptVenues = [];
    let newAptCustomers = [];
    let isRecurring = false;
    let endsMode = 'on';
    let aptType = 'appointment';

    // Toggle functions (defined early for onclick handlers)
    function toggleRecurring() {
      isRecurring = !isRecurring;
      document.getElementById('recurringToggle').classList.toggle('active', isRecurring);
      document.getElementById('recurringLabel').textContent = isRecurring ? 'Yes' : 'No';
      document.getElementById('recurringOptions').classList.toggle('show', isRecurring);
    }

    function setEndsMode(mode) {
      endsMode = mode;
      document.getElementById('endsOnBtn').classList.toggle('active', mode === 'on');
      document.getElementById('endsAfterBtn').classList.toggle('active', mode === 'after');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      updateWeekDisplay();
      generateTimeSlots();
      await loadAppointments();
    });

    // Load appointments from API
    async function loadAppointments() {
      try {
        const startOfWeek = getStartOfWeek(currentDate);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(endOfWeek.getDate() + 6); // Saturday (6 days after Sunday)
        endOfWeek.setHours(23, 59, 59, 999); // End of Saturday

        const startDate = startOfWeek.toISOString().split('T')[0];
        // Use end of Saturday to include all Saturday appointments
        const endDate = endOfWeek.toISOString();

        const data = await apiRequest(`/api/appointments/calendar?start=${startDate}&end=${endDate}`);

        // API returns array directly, not wrapped in { events: [...] }
        if (data && Array.isArray(data)) {
          appointments = data;
          renderAppointments();
        } else if (data && data.events) {
          appointments = data.events;
          renderAppointments();
        }
      } catch (error) {
        console.error('Failed to load appointments:', error);
      }
    }

    // Render appointments on the calendar grid
    function renderAppointments() {
      // Clear existing appointment blocks
      document.querySelectorAll('.appointment-block').forEach(el => el.remove());

      const startOfWeek = getStartOfWeek(currentDate);
      const grid = document.getElementById('calendarGrid');

      appointments.forEach(apt => {
        // Parse times - treat database times as local times (not UTC)
        // Remove 'Z' suffix if present to prevent UTC conversion
        const startStr = apt.start.replace('Z', '').replace('+00:00', '');
        const endStr = apt.end.replace('Z', '').replace('+00:00', '');
        const start = new Date(startStr);
        const end = new Date(endStr);

        // Calculate which day column (0-6) using local dates to avoid timezone issues
        const startLocal = new Date(start.getFullYear(), start.getMonth(), start.getDate());
        const weekStartLocal = new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate());
        const dayDiff = Math.round((startLocal - weekStartLocal) / (1000 * 60 * 60 * 24));
        if (dayDiff < 0 || dayDiff > 6) return; // Skip if outside current week

        // Calculate position within the day
        const startHour = start.getHours();
        const startMinutes = start.getMinutes();
        const endHour = end.getHours();
        const endMinutes = end.getMinutes();

        // Calculate duration in hours
        const durationHours = (end - start) / (1000 * 60 * 60);

        // Find the time slot for this hour and day
        const timeSlots = grid.querySelectorAll('.time-slot');
        const slotIndex = startHour * 7 + dayDiff;
        const targetSlot = timeSlots[slotIndex];

        if (!targetSlot) return;

        // Determine payment/status for color coding
        const isPaid = apt.extendedProps?.paymentStatus === 'paid' || apt.extendedProps?.status === 'completed';
        const isUnpaid = apt.extendedProps?.paymentStatus === 'unpaid' || apt.extendedProps?.paymentStatus === 'pending';
        const status = apt.extendedProps?.status || 'confirmed';

        // Momence-style: Green background for all appointments
        // Small colored square indicator for payment status
        // Green square = paid, Red square = unpaid, Yellow/Orange square = confirmed/pending
        let indicatorColor;
        if (isPaid) {
          indicatorColor = '#22c55e'; // Green
        } else if (isUnpaid) {
          indicatorColor = '#ef4444'; // Red
        } else {
          indicatorColor = '#eab308'; // Yellow/amber for confirmed
        }

        // Create appointment block - Momence green style
        const block = document.createElement('div');
        block.className = `appointment-block ${isPaid ? 'paid' : isUnpaid ? 'unpaid' : 'confirmed'}`;
        block.style.cssText = `
          position: absolute;
          top: ${(startMinutes / 60) * slotHeight}px;
          left: 2px;
          right: 2px;
          height: ${Math.max(durationHours * slotHeight - 4, 24)}px;
          background: #4ade80;
          border-radius: 4px;
          padding: 4px 6px 4px 8px;
          font-size: 0.75rem;
          overflow: visible;
          cursor: pointer;
          z-index: 100;
          box-sizing: border-box;
          display: flex;
          gap: 6px;
        `;

        // Format times
        const timeStr = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const endTimeStr = end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const timeRange = `${timeStr} - ${endTimeStr}`;

        // Get details from extendedProps
        const clientName = apt.extendedProps?.clientName || 'No client';
        const clientEmail = apt.extendedProps?.clientEmail || '';
        const serviceName = apt.extendedProps?.serviceName || apt.title || 'Appointment';
        const staffName = apt.extendedProps?.staffName || '';
        const locationType = apt.extendedProps?.locationType || 'in_person';
        const price = apt.extendedProps?.price || 0;

        // Payment status text and class
        const paymentStatusText = isPaid ? 'Paid' : isUnpaid ? 'Not paid' : 'Confirmed';
        const statusClass = isPaid ? 'paid' : isUnpaid ? 'unpaid' : 'confirmed';

        block.innerHTML = `
          <!-- Payment status indicator square -->
          <div style="width: 10px; height: 10px; min-width: 10px; background: ${indicatorColor}; border-radius: 2px; margin-top: 2px;"></div>
          <!-- Appointment content -->
          <div style="flex: 1; min-width: 0; overflow: hidden;">
            <div style="font-weight: 600; color: #166534; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${serviceName}</div>
            <div style="color: #166534; font-size: 0.6875rem; opacity: 0.9;">${clientName}</div>
            <div style="color: #166534; font-size: 0.6875rem; opacity: 0.8;">${timeStr}</div>
          </div>

          <!-- Hover Tooltip - Momence style -->
          <div class="apt-tooltip">
            <div class="apt-tooltip-header">
              <div class="apt-tooltip-status-dot ${statusClass}"></div>
              <span class="apt-tooltip-status-text">${paymentStatusText}</span>
            </div>

            <div class="apt-tooltip-body">
              <div class="apt-tooltip-service">${serviceName}</div>

              <div class="apt-tooltip-client">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                <span class="apt-tooltip-client-name">${clientName}</span>
              </div>
              ${clientEmail ? `<div class="apt-tooltip-client-email">${clientEmail}</div>` : ''}

              <div class="apt-tooltip-divider"></div>

              <div class="apt-tooltip-details">
                <div class="apt-tooltip-detail">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                  <span class="apt-tooltip-detail-value">${timeRange}</span>
                </div>

                ${staffName ? `
                <div class="apt-tooltip-detail">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                  <span class="apt-tooltip-detail-value">${staffName}</span>
                </div>
                ` : ''}

                <div class="apt-tooltip-detail">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  <span class="apt-tooltip-detail-value">${locationType === 'in_person' ? 'In Person' : locationType === 'virtual' ? 'Virtual' : locationType}</span>
                </div>

                ${price > 0 ? `
                <div class="apt-tooltip-detail">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                  <span class="apt-tooltip-detail-value">$${price.toFixed(2)}</span>
                </div>
                ` : ''}
              </div>
            </div>
          </div>
        `;

        block.addEventListener('click', (e) => {
          e.stopPropagation();
          e.preventDefault();
          console.log('Appointment clicked:', apt);
          openAppointmentPanel(apt);
        });

        // Position relative to the slot
        targetSlot.style.position = 'relative';
        targetSlot.appendChild(block);
      });
    }

    // API helper
    async function apiRequest(url, options = {}) {
      const response = await fetch(url, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers
        }
      });

      if (response.status === 401) {
        window.location.href = '/login';
        return;
      }

      return response.json();
    }

    function updateWeekDisplay() {
      const weekNum = getWeekNumber(currentDate);
      const year = currentDate.getFullYear();
      document.getElementById('weekDisplay').textContent = `Week ${weekNum}, ${year}`;

      // Update day headers with format "Sun, Jan 4"
      const startOfWeek = getStartOfWeek(currentDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(date.getDate() + i);

        const dayHeader = document.getElementById(`dayHeader${i}`);
        if (!dayHeader) continue;

        const dayName = dayNames[date.getDay()];
        const monthName = monthNames[date.getMonth()];
        const dayNum = date.getDate();

        const dateStr = `${dayName}, ${monthName} ${dayNum}`;

        // Build class string
        let classes = 'day-full-date';
        if (date.getTime() === today.getTime()) {
          classes += ' today';
        }
        if (i === 0 || i === 6) {
          classes += ' weekend';
        }

        dayHeader.innerHTML = `<span class="${classes}">${dateStr}</span>`;
      }
    }

    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function getStartOfWeek(date) {
      const d = new Date(date);
      const day = d.getDay();
      d.setDate(d.getDate() - day);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function generateTimeSlots() {
      const grid = document.getElementById('calendarGrid');

      // Clear existing time slots (keep header)
      const headers = grid.querySelectorAll('.calendar-header-corner, .calendar-header-day');
      grid.innerHTML = '';
      headers.forEach(h => grid.appendChild(h));

      // Generate time slots from 12 AM to 11 PM
      for (let hour = 0; hour < 24; hour++) {
        // Time label
        const timeLabel = document.createElement('div');
        timeLabel.className = 'time-slot-label';
        timeLabel.textContent = formatHour(hour);
        grid.appendChild(timeLabel);

        // Day slots
        for (let day = 0; day < 7; day++) {
          const slot = document.createElement('div');
          slot.className = 'time-slot';
          if (day === 0 || day === 6) {
            slot.classList.add('weekend');
          }
          slot.style.height = `${slotHeight}px`;
          slot.dataset.hour = hour;
          slot.dataset.day = day;
          slot.onclick = (e) => {
            // Don't trigger if clicking on an appointment block
            if (e.target.closest('.appointment-block')) return;
            handleSlotClick(day, hour);
          };
          grid.appendChild(slot);
        }
      }
    }

    function formatHour(hour) {
      if (hour === 0) return '12 AM';
      if (hour === 12) return '12 PM';
      if (hour < 12) return `${hour} AM`;
      return `${hour - 12} PM`;
    }

    function handleSlotClick(day, hour) {
      console.log('Slot clicked:', { day, hour });
      const startOfWeek = getStartOfWeek(currentDate);
      const date = new Date(startOfWeek);
      date.setDate(date.getDate() + day);
      date.setHours(hour, 0, 0, 0);
      console.log('Opening modal for date:', date);
      openNewAptModal(date);
    }

    // Navigation
    async function prevWeek() {
      currentDate.setDate(currentDate.getDate() - 7);
      updateWeekDisplay();
      await loadAppointments();
    }

    async function nextWeek() {
      currentDate.setDate(currentDate.getDate() + 7);
      updateWeekDisplay();
      await loadAppointments();
    }

    function setView(view) {
      currentView = view;
      document.querySelectorAll('.view-toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      // Regenerate calendar for day view
    }

    // Zoom
    function zoomIn() {
      slotHeight = Math.min(slotHeight + 15, 120);
      document.querySelectorAll('.time-slot').forEach(slot => {
        slot.style.height = `${slotHeight}px`;
      });
      renderAppointments(); // Re-render with new slot height
    }

    function zoomOut() {
      slotHeight = Math.max(slotHeight - 15, 30);
      document.querySelectorAll('.time-slot').forEach(slot => {
        slot.style.height = `${slotHeight}px`;
      });
      renderAppointments(); // Re-render with new slot height
    }

    // Dropdowns
    function toggleDropdown(id) {
      const menu = document.getElementById(id);
      const wasOpen = menu.classList.contains('show');

      // Close all dropdowns first
      document.querySelectorAll('.filter-dropdown-menu, .dropdown-menu').forEach(m => {
        m.classList.remove('show');
      });

      if (!wasOpen) {
        menu.classList.add('show');
      }
    }

    function toggleActionsMenu() {
      toggleDropdown('actionsMenu');
    }

    // Checkout menu
    function toggleCheckoutMenu() {
      const menu = document.getElementById('checkoutMenu');
      const wasOpen = menu.classList.contains('show');

      // Close all dropdowns first
      document.querySelectorAll('.filter-dropdown-menu, .dropdown-menu, .user-dropdown-menu, .checkout-dropdown-menu').forEach(m => {
        m.classList.remove('show');
      });

      if (!wasOpen) {
        menu.classList.add('show');
      }
    }

    // User menu
    function toggleUserMenu() {
      const menu = document.getElementById('userDropdownMenu');
      const wasOpen = menu.classList.contains('show');

      // Close all dropdowns first
      document.querySelectorAll('.filter-dropdown-menu, .dropdown-menu, .user-dropdown-menu').forEach(m => {
        m.classList.remove('show');
      });

      if (!wasOpen) {
        menu.classList.add('show');
      }
    }

    function signOut() {
      localStorage.removeItem('auth_token');
      window.location.href = '/login';
    }

    function selectLocation(name) {
      document.getElementById('selectedLocation').textContent = name;
      document.getElementById('locationDropdown').classList.remove('show');
    }

    function selectVenue(name) {
      document.getElementById('selectedVenue').textContent = name;
      // Update selection state
      document.querySelectorAll('#venueDropdown .filter-dropdown-item').forEach(item => {
        item.classList.toggle('selected', item.textContent === name);
      });
      document.getElementById('venueDropdown').classList.remove('show');
      // Filter appointments by venue
    }

    function selectStaff(name) {
      document.getElementById('selectedStaff').textContent = name;
      // Update selection state
      document.querySelectorAll('#staffDropdown .filter-dropdown-item').forEach(item => {
        item.classList.toggle('selected', item.textContent === name);
      });
      document.getElementById('staffDropdown').classList.remove('show');
      // Filter appointments by staff
    }

    // Staff/Venues mode toggle
    let currentMode = 'staff';
    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.staff-venues-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      // Show/hide appropriate dropdown
      document.getElementById('staffDropdownContainer').style.display = mode === 'staff' ? 'block' : 'none';
      document.getElementById('venueDropdownContainer').style.display = mode === 'venues' ? 'block' : 'none';
    }

    // Actions
    function editBoard() {
      window.location.href = '/boards/edit';
    }

    function openAppointmentSettings() {
      window.location.href = '/settings/appointments';
    }

    // Search functionality
    function openSearch() {
      // TODO: Open search modal or focus search input
      console.log('Open search...');
    }

    // Keyboard shortcut for search
    document.addEventListener('keydown', (e) => {
      if (e.key === 's' && !e.ctrlKey && !e.metaKey && !e.altKey &&
          !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
        e.preventDefault();
        openSearch();
      }
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.filter-dropdown') && !e.target.closest('.toolbar-btn') && !e.target.closest('.utility-user-dropdown') && !e.target.closest('.checkout-dropdown')) {
        document.querySelectorAll('.filter-dropdown-menu, .dropdown-menu, .user-dropdown-menu, .checkout-dropdown-menu').forEach(m => {
          m.classList.remove('show');
        });
      }
    });

    // Clock in/out functionality
    let isClockedIn = localStorage.getItem('clock_status') === 'in';

    function updateClockStatus() {
      const toast = document.getElementById('clockStatusToast');
      const icon = toast.querySelector('.clock-status-icon');
      const text = toast.querySelector('.clock-status-text');
      const menuItem = document.getElementById('clockMenuItem');

      if (isClockedIn) {
        toast.classList.remove('clocked-out');
        toast.classList.add('clocked-in');
        icon.classList.remove('clocked-out');
        icon.classList.add('clocked-in');
        icon.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>`;
        text.textContent = 'Clocked in!';
        if (menuItem) menuItem.textContent = 'Clock out';
      } else {
        toast.classList.remove('clocked-in');
        toast.classList.add('clocked-out');
        icon.classList.remove('clocked-in');
        icon.classList.add('clocked-out');
        icon.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>`;
        text.textContent = 'Clocked out!';
        if (menuItem) menuItem.textContent = 'Clock in';
      }
      toast.classList.remove('hidden');
    }

    function toggleClockStatus() {
      isClockedIn = !isClockedIn;
      localStorage.setItem('clock_status', isClockedIn ? 'in' : 'out');
      updateClockStatus();
    }

    function hideClockToast() {
      document.getElementById('clockStatusToast').classList.add('hidden');
    }

    // Initialize clock status on load
    updateClockStatus();

    // =====================
    // Appointment Detail Panel
    // =====================

    function openAppointmentPanel(apt) {
      selectedAppointment = apt;
      isCheckedIn = apt.extendedProps?.status === 'in_progress';

        // Update panel content
        document.getElementById('panelTitle').textContent = apt.title || 'Appointment reservation';
        document.getElementById('panelId').textContent = `ID: ${apt.id}`;

      // Status badge
      const statusBadge = document.getElementById('panelStatusBadge');
      const status = apt.extendedProps?.status || 'scheduled';
      const displayStatus = status === 'in_progress' ? 'Paid' : status.charAt(0).toUpperCase() + status.slice(1);
      statusBadge.textContent = displayStatus;
      statusBadge.className = `panel-status-badge ${status === 'in_progress' ? 'paid' : status}`;

      // Date/time
      const start = new Date(apt.start);
      const end = new Date(apt.end);
      const dateStr = start.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
      const startTime = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      const endTime = end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      const durationMins = Math.round((end - start) / (1000 * 60));

      document.getElementById('panelDateTime').textContent = `${dateStr} ${startTime} - ${endTime}`;
      document.getElementById('panelDuration').textContent = `takes ${durationMins} minutes`;

      // Practitioner
      const staffName = apt.extendedProps?.staffName || 'Not assigned';
      const staffId = apt.extendedProps?.staffId;
      const staffLink = document.getElementById('panelStaffName');
      staffLink.textContent = staffName;
      if (staffId) {
        staffLink.href = `/practitioner-detail?id=${staffId}`;
        staffLink.onclick = null;
      } else {
        staffLink.href = '#';
        staffLink.onclick = (e) => e.preventDefault();
      }

      // Location
      const locationType = apt.extendedProps?.locationType || 'in_person';
      document.getElementById('panelLocation').textContent = locationType === 'in_person' ? 'Event Space' : 'Virtual';

      // Client / Signups section
      const clientName = apt.extendedProps?.clientName;
      const signupCard = document.getElementById('panelSignupCard');
      if (clientName) {
        signupCard.style.display = 'flex';
        document.getElementById('panelClientName').textContent = clientName;
      } else {
        signupCard.style.display = 'flex';
        document.getElementById('panelClientName').textContent = 'No client assigned';
      }

      // Update check-in toggle and timestamp
      const toggle = document.getElementById('panelCheckinToggle');
      const checkinTime = document.getElementById('panelCheckinTime');
      toggle.classList.toggle('active', isCheckedIn);

      if (isCheckedIn && apt.extendedProps?.checkedInAt) {
        const checkinDate = new Date(apt.extendedProps.checkedInAt);
        const dateStr = checkinDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        const timeStr = checkinDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        checkinTime.textContent = `${dateStr}, ${timeStr}`;
        checkinTime.classList.add('show');
      } else if (isCheckedIn) {
        // Fallback if no timestamp but status says checked in
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        checkinTime.textContent = `${dateStr}, ${timeStr}`;
        checkinTime.classList.add('show');
      } else {
        checkinTime.textContent = '';
        checkinTime.classList.remove('show');
      }

      // Service name (clickable link to service detail)
      const serviceNameEl = document.getElementById('panelServiceName');
      serviceNameEl.textContent = apt.title || 'Service';
      const serviceId = apt.extendedProps?.serviceId;
      if (serviceId) {
        serviceNameEl.href = `/service-detail?id=${serviceId}`;
      } else {
        serviceNameEl.href = '#';
        serviceNameEl.onclick = (e) => e.preventDefault();
      }

      // Price
      const price = apt.extendedProps?.price || 0;
      const priceEl = document.getElementById('panelPrice');
      priceEl.innerHTML = `ZAR ${price.toFixed(2)} <span class="panel-price-credits">or 0 credits</span>`;

      // Show panel
      document.getElementById('appointmentPanelOverlay').classList.add('show');
      document.getElementById('appointmentPanel').classList.add('show');
    }

    function closeAppointmentPanel() {
      document.getElementById('appointmentPanelOverlay').classList.remove('show');
      document.getElementById('appointmentPanel').classList.remove('show');
      selectedAppointment = null;
    }

    async function cancelAppointment() {
      if (!selectedAppointment) return;

      const apt = selectedAppointment;
      const confirmCancel = confirm(`Are you sure you want to cancel this appointment?\n\n${apt.title || 'Appointment'}\n${apt.client_name || ''}`);

      if (!confirmCancel) return;

      try {
        const response = await fetch(`/api/appointments/${apt.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            status: 'cancelled'
          })
        });

        if (response.ok) {
          closeAppointmentPanel();
          loadAppointments();
        } else {
          const error = await response.json();
          alert('Error cancelling appointment: ' + (error.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error cancelling appointment:', error);
        alert('Error cancelling appointment. Please try again.');
      }
    }

    function navigateToSchedule() {
      // Navigate to the appointments schedule page
      // The current page IS the schedule, so we just close the panel
      // and scroll to the calendar view if needed
      closeAppointmentPanel();

      // Scroll to top where the calendar is
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function addToCalendar() {
      if (!selectedAppointment) return;

      const apt = selectedAppointment;

      // Format dates for Google Calendar (YYYYMMDDTHHmmssZ format)
      const startDate = new Date(apt.start_time);
      const endDate = new Date(apt.end_time);

      const formatDate = (date) => {
        return date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
      };

      const startStr = formatDate(startDate);
      const endStr = formatDate(endDate);

      // Build event title
      const title = apt.title || 'Appointment';

      // Build description
      let description = '';
      if (apt.client_name) {
        description += `Client: ${apt.client_name}\n`;
      }
      if (apt.staff_name) {
        description += `Practitioner: ${apt.staff_name}\n`;
      }
      if (apt.notes) {
        description += `\nNotes: ${apt.notes}`;
      }

      // Location (use clinic name if available)
      const location = 'Expand Health';

      // Build Google Calendar URL
      const googleCalUrl = new URL('https://calendar.google.com/calendar/render');
      googleCalUrl.searchParams.set('action', 'TEMPLATE');
      googleCalUrl.searchParams.set('text', title);
      googleCalUrl.searchParams.set('dates', `${startStr}/${endStr}`);
      googleCalUrl.searchParams.set('details', description);
      googleCalUrl.searchParams.set('location', location);

      // Open in new tab
      window.open(googleCalUrl.toString(), '_blank');
    }

    function showPanelTab(tab) {
      document.querySelectorAll('.panel-tab').forEach((t, i) => {
        t.classList.toggle('active', (tab === 'details' && i === 0) || (tab === 'timing' && i === 1));
      });
      // TODO: Switch content based on tab
    }

    // =====================
    // Edit Appointment Modal
    // =====================

    async function openEditAppointmentModal() {
      if (!selectedAppointment) return;

      const apt = selectedAppointment;

      // Populate the form with current appointment data
      document.getElementById('editAptBoard').textContent = 'Expand Health';

      // Set starts at datetime
      if (apt.start_time) {
        const startDate = new Date(apt.start_time);
        const localDateTime = new Date(startDate.getTime() - startDate.getTimezoneOffset() * 60000)
          .toISOString()
          .slice(0, 16);
        document.getElementById('editAptStartsAt').value = localDateTime;
      }

      // Load and populate services dropdown
      await loadServicesForEdit();
      if (apt.service_id) {
        document.getElementById('editAptService').value = apt.service_id;
      }

      // Load and populate staff dropdown
      await loadStaffForEdit();
      if (apt.staff_id) {
        document.getElementById('editAptStaff').value = apt.staff_id;
      }

      // Set duration (calculate from start/end time or use default)
      if (apt.start_time && apt.end_time) {
        const start = new Date(apt.start_time);
        const end = new Date(apt.end_time);
        const durationMinutes = Math.round((end - start) / (1000 * 60));
        document.getElementById('editAptDuration').value = durationMinutes;
      } else {
        document.getElementById('editAptDuration').value = 45;
      }

      // Set buffers (default values)
      document.getElementById('editAptBufferStart').value = 5;
      document.getElementById('editAptBufferEnd').value = 5;

      // Set price
      if (apt.price) {
        document.getElementById('editAptPrice').value = apt.price;
      } else {
        document.getElementById('editAptPrice').value = 0;
      }

      // Set notes
      document.getElementById('editAptNotes').value = apt.notes || '';

      // Show modal
      document.getElementById('editAptModalOverlay').classList.add('show');
      document.getElementById('editAptModal').classList.add('show');
    }

    function closeEditAppointmentModal() {
      document.getElementById('editAptModalOverlay').classList.remove('show');
      document.getElementById('editAptModal').classList.remove('show');
    }

    async function loadServicesForEdit() {
      try {
        const response = await fetch('/api/services', {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const services = await response.json();
          const select = document.getElementById('editAptService');
          select.innerHTML = '<option value="">Select service...</option>';

          services.forEach(service => {
            const option = document.createElement('option');
            option.value = service.id;
            option.textContent = service.name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading services:', error);
      }
    }

    async function loadStaffForEdit() {
      try {
        const response = await fetch('/api/staff', {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const staff = await response.json();
          const select = document.getElementById('editAptStaff');
          select.innerHTML = '<option value="">Select staff...</option>';

          (staff.staff || staff).forEach(member => {
            const option = document.createElement('option');
            option.value = member.id;
            option.textContent = `${member.first_name} ${member.last_name}`;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading staff:', error);
      }
    }

    async function saveAppointmentChanges() {
      if (!selectedAppointment) return;

      const apt = selectedAppointment;

      // Gather form data
      const startDateTime = document.getElementById('editAptStartsAt').value;
      const serviceId = document.getElementById('editAptService').value;
      const staffId = document.getElementById('editAptStaff').value;
      const duration = parseInt(document.getElementById('editAptDuration').value) || 45;
      const price = parseFloat(document.getElementById('editAptPrice').value) || 0;
      const notes = document.getElementById('editAptNotes').value;

      // Calculate end time based on duration
      const startDate = new Date(startDateTime);
      const endDate = new Date(startDate.getTime() + duration * 60 * 1000);

      try {
        const response = await fetch(`/api/appointments/${apt.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            start_time: startDate.toISOString(),
            end_time: endDate.toISOString(),
            service_id: serviceId || null,
            staff_id: staffId || null,
            price: price,
            notes: notes
          })
        });

        if (response.ok) {
          closeEditAppointmentModal();
          closeAppointmentPanel();
          // Refresh the calendar view
          loadAppointments();
        } else {
          const error = await response.json();
          alert('Error saving changes: ' + (error.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error saving appointment:', error);
        alert('Error saving changes. Please try again.');
      }
    }

    // =====================
    // Add Customer Modal
    // =====================

    async function loadClients() {
      try {
        console.log('Loading clients...');
        const response = await fetch('/api/clients?limit=500', {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        console.log('Clients response status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Clients API error:', response.status, errorText);
          return;
        }

        const data = await response.json();
        console.log('Clients data:', data);

        if (data && data.clients) {
          clients = data.clients;
          console.log('Loaded', clients.length, 'clients');
        } else {
          console.log('No clients array in response');
        }
      } catch (error) {
        console.error('Failed to load clients:', error);
      }
    }

    async function openAddCustomerModal() {
      if (!selectedAppointment) {
        console.log('No selected appointment');
        return;
      }

      // Always reload clients to get fresh data
      await loadClients();

      // Populate the dropdown
      const select = document.getElementById('customerSelect');
      select.innerHTML = '<option value="">Select customer...</option>';

      if (clients.length === 0) {
        select.innerHTML = '<option value="">No customers found</option>';
      } else {
        clients.forEach(client => {
          const option = document.createElement('option');
          option.value = client.id;
          option.textContent = `${client.first_name} ${client.last_name}`;
          if (client.email) {
            option.textContent += ` (${client.email})`;
          }
          select.appendChild(option);
        });
      }

      // Show modal
      document.getElementById('addCustomerModalOverlay').classList.add('show');
      document.getElementById('addCustomerModal').classList.add('show');
    }

    function closeAddCustomerModal() {
      document.getElementById('addCustomerModalOverlay').classList.remove('show');
      document.getElementById('addCustomerModal').classList.remove('show');
    }

    async function assignCustomer() {
      if (!selectedAppointment) return;

      const select = document.getElementById('customerSelect');
      const clientId = select.value;

      if (!clientId) {
        alert('Please select a customer');
        return;
      }

      try {
        const response = await apiRequest(`/api/appointments/${selectedAppointment.id}`, {
          method: 'PUT',
          body: JSON.stringify({ client_id: parseInt(clientId) })
        });

        if (response) {
          // Find the client name
          const client = clients.find(c => c.id === parseInt(clientId));
          const clientName = client ? `${client.first_name} ${client.last_name}` : 'Client assigned';

          // Update the panel
          document.getElementById('panelClientName').textContent = clientName;
          document.getElementById('panelSignupCard').style.display = 'flex';

          // Close modal and refresh appointments
          closeAddCustomerModal();
          await loadAppointments();
        }
      } catch (error) {
        console.error('Failed to assign customer:', error);
        alert('Failed to assign customer');
      }
    }

    // =====================
    // Create Customer Modal
    // =====================
    function openCreateCustomerModal() {
      // Clear form
      document.getElementById('newCustomerFirstName').value = '';
      document.getElementById('newCustomerLastName').value = '';
      document.getElementById('newCustomerEmail').value = '';
      document.getElementById('newCustomerPhone').value = '';
      document.getElementById('newCustomerCountryCode').value = '+27';

      // Show modal
      document.getElementById('createCustomerModalOverlay').classList.add('show');
      document.getElementById('createCustomerModal').classList.add('show');

      // Focus first field
      setTimeout(() => {
        document.getElementById('newCustomerFirstName').focus();
      }, 100);
    }

    function closeCreateCustomerModal() {
      document.getElementById('createCustomerModalOverlay').classList.remove('show');
      document.getElementById('createCustomerModal').classList.remove('show');
    }

    async function createNewCustomer() {
      const firstName = document.getElementById('newCustomerFirstName').value.trim();
      const lastName = document.getElementById('newCustomerLastName').value.trim();
      const email = document.getElementById('newCustomerEmail').value.trim();
      const countryCode = document.getElementById('newCustomerCountryCode').value;
      const phone = document.getElementById('newCustomerPhone').value.trim();

      if (!firstName) {
        alert('First name is required');
        document.getElementById('newCustomerFirstName').focus();
        return;
      }

      if (!lastName) {
        alert('Last name is required');
        document.getElementById('newCustomerLastName').focus();
        return;
      }

      const fullPhone = phone ? `${countryCode}${phone}` : '';

      try {
        const response = await apiRequest('/api/clients', {
          method: 'POST',
          body: JSON.stringify({
            first_name: firstName,
            last_name: lastName,
            email: email || null,
            phone: fullPhone || null
          })
        });

        if (response) {
          // Add new client to dropdown and select it
          const select = document.getElementById('customerSelect');
          const option = document.createElement('option');
          option.value = response.id;
          option.textContent = `${response.first_name} ${response.last_name}${response.email ? ` (${response.email})` : ''}`;
          select.appendChild(option);
          select.value = response.id;

          // Add to clients array
          clients.push(response);

          // Close create modal
          closeCreateCustomerModal();
        }
      } catch (error) {
        console.error('Failed to create customer:', error);
        alert('Failed to create customer');
      }
    }

    async function toggleCheckin() {
      if (!selectedAppointment) return;

      const toggle = document.getElementById('panelCheckinToggle');
      const checkinTime = document.getElementById('panelCheckinTime');
      isCheckedIn = !isCheckedIn;
      toggle.classList.toggle('active', isCheckedIn);

      if (isCheckedIn) {
        // Show check-in timestamp
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        checkinTime.textContent = `${dateStr}, ${timeStr}`;
        checkinTime.classList.add('show');
        await checkInAppointment();
      } else {
        // Hide check-in timestamp
        checkinTime.textContent = '';
        checkinTime.classList.remove('show');
      }
    }

    // =====================
    // Signup Menu (3 dots)
    // =====================
    function toggleSignupMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('signupMenu');
      menu.classList.toggle('show');

      // Close menu when clicking outside
      if (menu.classList.contains('show')) {
        setTimeout(() => {
          document.addEventListener('click', closeSignupMenuOnClickOutside);
        }, 0);
      }
    }

    function closeSignupMenuOnClickOutside(event) {
      const menu = document.getElementById('signupMenu');
      if (!event.target.closest('.panel-more-wrapper')) {
        menu.classList.remove('show');
        document.removeEventListener('click', closeSignupMenuOnClickOutside);
      }
    }

    function closeSignupMenu() {
      document.getElementById('signupMenu').classList.remove('show');
      document.removeEventListener('click', closeSignupMenuOnClickOutside);
    }

    function addTaskToCustomer() {
      closeSignupMenu();
      alert('Add task to customer - Feature coming soon');
    }

    function sellProducts() {
      closeSignupMenu();
      alert('Sell products - Feature coming soon');
    }

    function cancelReservation() {
      closeSignupMenu();
      cancelAppointment();
    }

    function contactCustomer() {
      closeSignupMenu();
      if (!selectedAppointment) return;

      const clientName = selectedAppointment.extendedProps?.clientName;
      if (!clientName) {
        alert('No customer assigned to this appointment');
        return;
      }
      alert('Contact customer - Feature coming soon');
    }

    async function cancelAppointment() {
      if (!selectedAppointment) return;
      if (!confirm('Are you sure you want to cancel this appointment?')) return;

      try {
        const response = await apiRequest(`/api/appointments/${selectedAppointment.id}/cancel`, {
          method: 'POST',
          body: JSON.stringify({ reason: 'Cancelled by staff' })
        });

        if (response) {
          closeAppointmentPanel();
          await loadAppointments();
        }
      } catch (error) {
        console.error('Failed to cancel appointment:', error);
        alert('Failed to cancel appointment');
      }
    }

    async function checkInAppointment() {
      if (!selectedAppointment) return;

      try {
        const response = await apiRequest(`/api/appointments/${selectedAppointment.id}/check-in`, {
          method: 'POST'
        });

        if (response) {
          // Update status badge
          const statusBadge = document.getElementById('panelStatusBadge');
          statusBadge.textContent = 'Paid';
          statusBadge.className = 'panel-status-badge paid';
        }
      } catch (error) {
        console.error('Failed to check in:', error);
        alert('Failed to check in');
      }
    }

    async function markAsPaid() {
      if (!selectedAppointment) return;

      try {
        const response = await apiRequest(`/api/appointments/${selectedAppointment.id}/complete`, {
          method: 'POST'
        });

        if (response) {
          closeAppointmentPanel();
          await loadAppointments();
        }
      } catch (error) {
        console.error('Failed to mark as paid:', error);
        alert('Failed to mark as paid');
      }
    }

    // =====================
    // New Appointment Modal
    // =====================

    async function openNewAptModal(date) {
      try {
        // Show modal immediately
        document.getElementById('newAptModalOverlay').classList.add('show');
        document.getElementById('newAptModal').classList.add('show');

        // Set the start date/time
        const dateStr = date.toISOString().slice(0, 16);
        document.getElementById('newAptStartsAt').value = dateStr;

        // Set default end date for recurring (1 week later)
        const endDate = new Date(date);
        endDate.setDate(endDate.getDate() + 7);
        document.getElementById('endsOnDate').value = endDate.toISOString().slice(0, 10);

        // Load dropdowns in parallel (don't block modal display)
        Promise.all([
          loadNewAptServices(),
          loadNewAptStaff(),
          loadNewAptVenues(),
          loadNewAptCustomers()
        ]).catch(err => console.error('Error loading dropdown data:', err));
      } catch (error) {
        console.error('Error opening new appointment modal:', error);
      }
    }

    function closeNewAptModal() {
      document.getElementById('newAptModalOverlay').classList.remove('show');
      document.getElementById('newAptModal').classList.remove('show');
      resetNewAptForm();
    }

    function resetNewAptForm() {
      document.getElementById('newAptService').value = '';
      document.getElementById('newAptStaff').value = '';
      document.getElementById('newAptVenue').value = '';
      document.getElementById('newAptCustomer').value = '';
      document.getElementById('newAptDuration').value = 60;
      document.getElementById('newAptBufferStart').value = 10;
      document.getElementById('newAptBufferEnd').value = 10;
      document.getElementById('newAptPrice').value = 0;
      document.getElementById('newAptNote').value = '';
      document.getElementById('sendConfirmation').checked = true;

      // Reset recurring
      isRecurring = false;
      document.getElementById('recurringToggle').classList.remove('active');
      document.getElementById('recurringLabel').textContent = 'No';
      document.getElementById('recurringOptions').classList.remove('show');
      document.getElementById('repeatEvery').value = 7;
      document.getElementById('endsAfterCount').value = 4;
      setEndsMode('on');

      // Reset type
      aptType = 'appointment';
      document.querySelectorAll('.apt-type-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i === 0);
      });
    }

    async function loadNewAptServices() {
      try {
        const token = localStorage.getItem('auth_token');
        // Remove active_only filter to show all services
        const response = await fetch('/api/services', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          newAptServices = await response.json();
          console.log('Loaded services:', newAptServices);
          const select = document.getElementById('newAptService');
          select.innerHTML = '<option value="">Select...</option>';
          newAptServices.forEach(service => {
            const option = document.createElement('option');
            option.value = service.id;
            option.textContent = service.name;
            option.dataset.duration = service.duration_minutes || 60;
            option.dataset.price = service.price || 0;
            option.dataset.bufferBefore = service.buffer_before_minutes || 10;
            option.dataset.bufferAfter = service.buffer_after_minutes || 10;
            select.appendChild(option);
          });
        } else {
          console.error('Services API error:', response.status);
        }
      } catch (error) {
        console.error('Failed to load services:', error);
      }
    }

    async function loadNewAptStaff() {
      try {
        const token = localStorage.getItem('auth_token');
        const response = await fetch('/api/staff?active_only=true', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          newAptStaffList = await response.json();
          const select = document.getElementById('newAptStaff');
          select.innerHTML = '<option value="">Select...</option>';
          newAptStaffList.forEach(staff => {
            const option = document.createElement('option');
            option.value = staff.id;
            option.textContent = `${staff.first_name} ${staff.last_name}`;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Failed to load staff:', error);
      }
    }

    async function loadNewAptVenues() {
      try {
        const token = localStorage.getItem('auth_token');
        const response = await fetch('/api/locations', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          newAptVenues = await response.json();
          const select = document.getElementById('newAptVenue');
          select.innerHTML = '<option value="">Select...</option>';
          newAptVenues.forEach(venue => {
            const option = document.createElement('option');
            option.value = venue.id;
            option.textContent = venue.name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Failed to load venues:', error);
      }
    }

    async function loadNewAptCustomers() {
      try {
        const token = localStorage.getItem('auth_token');
        const response = await fetch('/api/clients?limit=100', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          newAptCustomers = data.clients || data;
          const select = document.getElementById('newAptCustomer');
          select.innerHTML = '<option value="">Select customer...</option>';
          newAptCustomers.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.id;
            option.textContent = `${customer.first_name} ${customer.last_name}`;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Failed to load customers:', error);
      }
    }

    function setAptType(type) {
      aptType = type;
      document.querySelectorAll('.apt-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().includes(type === 'appointment' ? 'appointment' : 'time block'));
      });
    }

    function onServiceChange() {
      const select = document.getElementById('newAptService');
      const selectedOption = select.options[select.selectedIndex];
      if (selectedOption && selectedOption.value) {
        const duration = selectedOption.dataset.duration || 60;
        const price = selectedOption.dataset.price || 0;
        const bufferBefore = selectedOption.dataset.bufferBefore || 10;
        const bufferAfter = selectedOption.dataset.bufferAfter || 10;
        document.getElementById('newAptDuration').value = duration;
        document.getElementById('newAptPrice').value = parseFloat(price).toFixed(2);
        document.getElementById('newAptBufferStart').value = bufferBefore;
        document.getElementById('newAptBufferEnd').value = bufferAfter;
      }
    }

    function addAnotherCustomer() {
      // For now just show a message - multi-customer support can be added later
      alert('Multi-customer booking coming soon');
    }

    async function bookAppointment() {
      const token = localStorage.getItem('auth_token');
      const startsAt = document.getElementById('newAptStartsAt').value;
      const serviceId = document.getElementById('newAptService').value;
      const staffId = document.getElementById('newAptStaff').value;
      const customerId = document.getElementById('newAptCustomer').value;
      const duration = parseInt(document.getElementById('newAptDuration').value) || 60;
      const price = parseFloat(document.getElementById('newAptPrice').value) || 0;
      const note = document.getElementById('newAptNote').value;

      if (!startsAt) {
        alert('Please select a start time');
        return;
      }

      const startTime = new Date(startsAt);
      const endTime = new Date(startTime.getTime() + duration * 60000);

      // Get service name for title
      const serviceSelect = document.getElementById('newAptService');
      const serviceName = serviceSelect.options[serviceSelect.selectedIndex]?.textContent || 'Appointment';

      const appointmentData = {
        service_type_id: serviceId || null,
        staff_id: staffId || null,
        client_id: customerId || null,
        title: serviceName,
        start_time: startTime.toISOString(),
        end_time: endTime.toISOString(),
        price: price,
        status: 'scheduled',
        location_type: 'in_person',
        client_notes: note
      };

      try {
        // If recurring, create multiple appointments
        if (isRecurring) {
          const repeatEvery = parseInt(document.getElementById('repeatEvery').value) || 7;
          const appointments = [appointmentData];

          if (endsMode === 'on') {
            const endDate = new Date(document.getElementById('endsOnDate').value);
            let currentDate = new Date(startTime);
            currentDate.setDate(currentDate.getDate() + repeatEvery);

            while (currentDate <= endDate) {
              const apt = { ...appointmentData };
              apt.start_time = new Date(currentDate).toISOString();
              apt.end_time = new Date(currentDate.getTime() + duration * 60000).toISOString();
              appointments.push(apt);
              currentDate.setDate(currentDate.getDate() + repeatEvery);
            }
          } else {
            const occurrences = parseInt(document.getElementById('endsAfterCount').value) || 4;
            let currentDate = new Date(startTime);

            for (let i = 1; i < occurrences; i++) {
              currentDate.setDate(currentDate.getDate() + repeatEvery);
              const apt = { ...appointmentData };
              apt.start_time = new Date(currentDate).toISOString();
              apt.end_time = new Date(currentDate.getTime() + duration * 60000).toISOString();
              appointments.push(apt);
            }
          }

          // Create all appointments
          for (const apt of appointments) {
            await fetch('/api/appointments', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(apt)
            });
          }
        } else {
          // Single appointment
          const response = await fetch('/api/appointments', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(appointmentData)
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to create appointment');
          }
        }

        closeNewAptModal();
        await loadAppointments();
      } catch (error) {
        console.error('Failed to book appointment:', error);
        alert(error.message || 'Failed to book appointment');
      }
    }

    function bookAndPay() {
      // Book the appointment first, then redirect to payment
      bookAppointment().then(() => {
        // Payment flow would go here
      });
    }
  </script>

  <!-- Appointment Detail Panel -->
  <div class="appointment-panel-overlay" id="appointmentPanelOverlay" onclick="closeAppointmentPanel()"></div>
  <div class="appointment-panel" id="appointmentPanel">
    <!-- Header -->
    <div class="panel-header">
      <div class="panel-header-left">
        <div class="panel-title" id="panelTitle">Appointment reservation</div>
        <div class="panel-id" id="panelId">ID: 0</div>
      </div>
      <div class="panel-header-right">
        <span class="panel-status-badge paid" id="panelStatusBadge">Paid</span>
        <button class="panel-close-btn" onclick="closeAppointmentPanel()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>

    <!-- Signups Section -->
    <div class="panel-signups" id="panelSignupsSection">
      <div class="panel-signups-header">
        <span class="panel-signups-badge">Signups</span>
        <span class="panel-checkin-label">
          Check-in
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </span>
      </div>
      <div class="panel-signup-card" id="panelSignupCard">
        <div class="panel-signup-avatar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
        <div class="panel-signup-info">
          <div class="panel-signup-name" id="panelClientName">No client assigned</div>
        </div>
        <div class="panel-signup-actions">
          <div class="panel-checkin-row">
            <div class="panel-toggle" id="panelCheckinToggle" onclick="toggleCheckin()"></div>
            <span class="panel-checkin-time" id="panelCheckinTime"></span>
          </div>
          <div class="panel-more-wrapper">
            <button class="panel-more-btn" onclick="toggleSignupMenu(event)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="12" cy="5" r="1"></circle>
                <circle cx="12" cy="19" r="1"></circle>
              </svg>
            </button>
            <div class="panel-signup-menu" id="signupMenu">
              <button class="panel-signup-menu-item" onclick="addTaskToCustomer()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <path d="M9 12l2 2 4-4"></path>
                </svg>
                Add task to customer
              </button>
              <button class="panel-signup-menu-item" onclick="sellProducts()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                  <line x1="3" y1="6" x2="21" y2="6"></line>
                  <path d="M16 10a4 4 0 0 1-8 0"></path>
                </svg>
                Sell products
              </button>
              <button class="panel-signup-menu-item cancel" onclick="cancelReservation()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18"></path>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Cancel reservation
              </button>
              <button class="panel-signup-menu-item" onclick="contactCustomer()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                </svg>
                Contact customer
              </button>
            </div>
          </div>
        </div>
      </div>
      <button class="panel-add-customer" onclick="openAddCustomerModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Add customer
      </button>
    </div>

    <!-- Tabs -->
    <div class="panel-tabs">
      <button class="panel-tab active" onclick="showPanelTab('details')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="8" y1="6" x2="21" y2="6"></line>
          <line x1="8" y1="12" x2="21" y2="12"></line>
          <line x1="8" y1="18" x2="21" y2="18"></line>
          <line x1="3" y1="6" x2="3.01" y2="6"></line>
          <line x1="3" y1="12" x2="3.01" y2="12"></line>
          <line x1="3" y1="18" x2="3.01" y2="18"></line>
        </svg>
        Details
      </button>
      <button class="panel-tab" onclick="showPanelTab('timing')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        Timing
      </button>
    </div>

    <!-- Content -->
    <div class="panel-content">
      <!-- Scheduled Section -->
      <div class="panel-section">
        <div class="panel-section-title">Scheduled</div>
        <div class="panel-info-row">
          <div class="panel-info-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </div>
          <div class="panel-info-content">
            <div class="panel-info-label" id="panelDateTime">--</div>
            <div class="panel-info-sublabel" id="panelDuration">--</div>
          </div>
        </div>
      </div>

      <!-- Practitioner & Venue Section -->
      <div class="panel-section">
        <div class="panel-section-title">Practitioner & Venue</div>
        <div class="panel-practitioner-row">
          <div class="panel-practitioner-item">
            <div class="panel-info-icon gray">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
            <a href="#" class="panel-info-link" id="panelStaffName">Not assigned</a>
          </div>
          <div class="panel-practitioner-item">
            <div class="panel-info-icon gray">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
            </div>
            <span class="panel-info-label" id="panelLocation">In Person</span>
          </div>
        </div>
      </div>

      <!-- Pricing Section -->
      <div class="panel-section">
        <div class="panel-section-title">Pricing</div>
        <div class="panel-pricing-row">
          <div class="panel-info-icon green">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
          </div>
          <div class="panel-info-content">
            <div class="panel-price-label">Total price</div>
            <div class="panel-price-value" id="panelPrice">ZAR 0.00 <span class="panel-price-credits">or 0 credits</span></div>
            <span class="panel-price-type">Flat price</span>
          </div>
        </div>
      </div>

      <!-- Service & Board Section -->
      <div class="panel-section">
        <div class="panel-section-title">Service & Board</div>
        <div class="panel-service-row panel-service-row-clickable" onclick="navigateToSchedule()">
          <div class="panel-service-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          </div>
          <div class="panel-info-content">
            <span class="panel-service-name" id="panelServiceName">Service</span>
            <div class="panel-service-board">on <span id="panelBoardName">Expand Health</span></div>
          </div>
        </div>
      </div>

      <!-- Add to Calendar -->
      <button class="panel-add-calendar" onclick="addToCalendar()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        Add to calendar
      </button>
    </div>

    <!-- Panel Footer -->
    <div class="panel-footer">
      <button class="panel-btn panel-btn-cancel" onclick="cancelAppointment()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        Cancel
      </button>
      <button class="panel-btn panel-btn-edit" onclick="openEditAppointmentModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
        </svg>
        Edit
      </button>
      <button class="panel-btn panel-btn-paid" id="panelPaidBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Paid
      </button>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div class="add-customer-modal-overlay" id="addCustomerModalOverlay" onclick="closeAddCustomerModal()"></div>
  <div class="add-customer-modal" id="addCustomerModal">
    <div class="add-customer-modal-header">
      <h3>Add customer</h3>
      <span class="modal-limit-badge" id="modalLimitBadge">Over limit</span>
      <div class="modal-header-spacer"></div>
      <button class="modal-close-btn" onclick="closeAddCustomerModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="add-customer-modal-body">
      <label class="modal-label">Customer</label>
      <div class="modal-select-row">
        <select id="customerSelect" class="modal-select">
          <option value="">Select customer...</option>
        </select>
        <button class="modal-add-new-btn" onclick="openCreateCustomerModal()" title="Create new customer">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </button>
      </div>
      <div class="modal-actions-row">
        <label class="modal-checkbox-label">
          <input type="checkbox" id="sendConfirmation" checked>
          <span>Send confirmation</span>
        </label>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" onclick="closeAddCustomerModal()">Cancel</button>
          <button class="modal-btn modal-btn-add" onclick="assignCustomer()">Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Customer Modal -->
  <div class="create-customer-modal-overlay" id="createCustomerModalOverlay" onclick="closeCreateCustomerModal()"></div>
  <div class="create-customer-modal" id="createCustomerModal">
    <div class="create-customer-modal-header">
      <h3>Create a new customer</h3>
      <button class="modal-close-btn" onclick="closeCreateCustomerModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="create-customer-modal-body">
      <div class="form-group">
        <label class="form-label">First name</label>
        <input type="text" id="newCustomerFirstName" class="form-input" placeholder="">
      </div>
      <div class="form-group">
        <label class="form-label">Last name</label>
        <input type="text" id="newCustomerLastName" class="form-input" placeholder="">
      </div>
      <div class="form-group">
        <label class="form-label">E-mail</label>
        <input type="email" id="newCustomerEmail" class="form-input" placeholder="">
      </div>
      <div class="form-group">
        <label class="form-label">Phone number</label>
        <div class="phone-input-row">
          <select id="newCustomerCountryCode" class="country-code-select">
            <option value="+1"> +1</option>
            <option value="+27" selected> +27</option>
            <option value="+44"> +44</option>
            <option value="+49"> +49</option>
            <option value="+33"> +33</option>
            <option value="+61"> +61</option>
            <option value="+91"> +91</option>
          </select>
          <input type="tel" id="newCustomerPhone" class="form-input phone-input" placeholder="">
        </div>
      </div>
    </div>
    <div class="create-customer-modal-footer">
      <button class="modal-btn modal-btn-cancel" onclick="closeCreateCustomerModal()">Cancel</button>
      <button class="modal-btn modal-btn-create" onclick="createNewCustomer()">Create</button>
    </div>
  </div>

  <!-- Edit Appointment Modal -->
  <div class="edit-apt-modal-overlay" id="editAptModalOverlay" onclick="closeEditAppointmentModal()"></div>
  <div class="edit-apt-modal" id="editAptModal">
    <div class="edit-apt-modal-header">
      <h3>Edit appointment reservation</h3>
      <button class="modal-close-btn" onclick="closeEditAppointmentModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="edit-apt-modal-body">
      <!-- Board (read-only) -->
      <div class="edit-apt-form-row">
        <label class="edit-apt-form-label">Board</label>
        <div class="edit-apt-form-value" id="editAptBoard">Expand Health</div>
      </div>

      <!-- Starts at -->
      <div class="edit-apt-form-row">
        <label class="edit-apt-form-label">Starts at</label>
        <div class="edit-apt-form-control">
          <input type="datetime-local" class="edit-apt-form-input" id="editAptStartsAt">
        </div>
      </div>

      <!-- Service -->
      <div class="edit-apt-form-row">
        <label class="edit-apt-form-label">Service</label>
        <div class="edit-apt-form-control">
          <select class="edit-apt-form-select" id="editAptService">
            <option value="">Select service...</option>
          </select>
        </div>
      </div>
      <div class="edit-apt-form-hint">Reservation with paid deposits or paid attendees can't have service changed</div>

      <!-- Staff -->
      <div class="edit-apt-form-row">
        <label class="edit-apt-form-label">Staff</label>
        <div class="edit-apt-form-control">
          <select class="edit-apt-form-select" id="editAptStaff">
            <option value="">Select staff...</option>
          </select>
        </div>
      </div>

      <!-- Venue -->
      <div class="edit-apt-form-row">
        <label class="edit-apt-form-label">Venue</label>
        <div class="edit-apt-form-control">
          <select class="edit-apt-form-select" id="editAptVenue">
            <option value="">Select venue...</option>
            <option value="event-space">Event Space</option>
            <option value="consultation-room">Consultation Room</option>
            <option value="treatment-room">Treatment Room</option>
          </select>
        </div>
      </div>

      <!-- Pay rate -->
      <div class="edit-apt-form-row">
        <label class="edit-apt-form-label">Pay rate</label>
        <div class="edit-apt-form-control edit-apt-form-control-with-btn">
          <select class="edit-apt-form-select" id="editAptPayRate">
            <option value="">Pay rate not specified</option>
          </select>
          <button class="edit-apt-add-btn" type="button">+</button>
        </div>
      </div>

      <!-- Duration & Buffers -->
      <div class="edit-apt-form-row">
        <label class="edit-apt-form-label">Duration &<br>Buffers/Overlaps</label>
        <div class="edit-apt-form-control">
          <div class="edit-apt-duration-row">
            <div class="edit-apt-duration-field">
              <input type="number" class="edit-apt-form-input edit-apt-duration-input" id="editAptBufferStart" value="5" min="0">
              <span class="edit-apt-duration-label">Buffer at start</span>
            </div>
            <div class="edit-apt-duration-field">
              <input type="number" class="edit-apt-form-input edit-apt-duration-input" id="editAptDuration" value="45" min="1">
              <span class="edit-apt-duration-label">Duration</span>
            </div>
            <div class="edit-apt-duration-field">
              <input type="number" class="edit-apt-form-input edit-apt-duration-input" id="editAptBufferEnd" value="5" min="0">
              <span class="edit-apt-duration-label">Buffer at end</span>
            </div>
            <span class="edit-apt-duration-unit">minutes</span>
          </div>
        </div>
      </div>

      <!-- Total price -->
      <div class="edit-apt-form-row">
        <label class="edit-apt-form-label">Total price</label>
        <div class="edit-apt-form-control">
          <div class="edit-apt-price-row">
            <span class="edit-apt-currency">ZAR</span>
            <input type="number" class="edit-apt-form-input edit-apt-price-input" id="editAptPrice" value="0" min="0" step="0.01">
          </div>
        </div>
      </div>
      <div class="edit-apt-form-hint">You can charge the customer or send a payment link once the appointment is created.</div>

      <!-- Additional note -->
      <div class="edit-apt-form-row edit-apt-form-row-top">
        <label class="edit-apt-form-label">Additional note</label>
        <div class="edit-apt-form-control">
          <textarea class="edit-apt-form-textarea" id="editAptNotes" rows="3" placeholder=""></textarea>
        </div>
      </div>
    </div>
    <div class="edit-apt-modal-footer">
      <button class="edit-apt-btn edit-apt-btn-cancel" onclick="closeEditAppointmentModal()">Cancel</button>
      <button class="edit-apt-btn edit-apt-btn-save" onclick="saveAppointmentChanges()">Save changes</button>
    </div>
  </div>

  <!-- New Appointment Modal -->
  <div class="new-apt-modal-overlay" id="newAptModalOverlay" onclick="closeNewAptModal()"></div>
  <div class="new-apt-modal" id="newAptModal">
    <div class="new-apt-modal-header">
      <h3>Add new</h3>
      <button class="modal-close-btn" onclick="closeNewAptModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="new-apt-modal-body">
      <!-- Appointment / Time Block Toggle -->
      <div class="apt-type-toggle">
        <button class="apt-type-btn active" onclick="setAptType('appointment')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          Appointment
        </button>
        <button class="apt-type-btn" onclick="setAptType('timeblock')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          Time block
        </button>
      </div>

      <!-- Board -->
      <div class="apt-form-row">
        <label class="apt-form-label">Board</label>
        <div class="apt-form-control">
          <select class="apt-form-select" id="newAptBoard">
            <option value="expand-health">Expand Health</option>
          </select>
        </div>
      </div>

      <!-- Starts at -->
      <div class="apt-form-row">
        <label class="apt-form-label">Starts at</label>
        <div class="apt-form-control">
          <input type="datetime-local" class="apt-form-input" id="newAptStartsAt">
        </div>
      </div>

      <!-- Book recurring -->
      <div class="apt-form-row">
        <label class="apt-form-label">Book recurring</label>
        <div class="apt-form-control">
          <div class="apt-toggle-row">
            <div class="apt-toggle" id="recurringToggle" onclick="toggleRecurring()"></div>
            <span class="apt-toggle-label" id="recurringLabel">No</span>
          </div>
        </div>
      </div>

      <!-- Recurring Options (hidden by default) -->
      <div class="recurring-options" id="recurringOptions">
        <!-- Repeat every -->
        <div class="apt-form-row">
          <label class="apt-form-label">Repeat every</label>
          <div class="apt-form-control">
            <div class="repeat-every-row">
              <input type="number" class="apt-form-input repeat-input" id="repeatEvery" value="7" min="1">
              <span class="repeat-unit">days</span>
            </div>
          </div>
        </div>

        <!-- Ends -->
        <div class="apt-form-row" style="align-items: flex-start;">
          <label class="apt-form-label" style="padding-top: 10px;">Ends</label>
          <div class="apt-form-control">
            <div class="ends-options">
              <div class="ends-option">
                <button type="button" class="ends-radio-btn active" id="endsOnBtn" onclick="setEndsMode('on')">
                  <div class="radio-dot"></div>
                </button>
                <span class="ends-label">On</span>
                <input type="date" class="apt-form-input ends-date-input" id="endsOnDate">
              </div>
              <div class="ends-option">
                <button type="button" class="ends-radio-btn" id="endsAfterBtn" onclick="setEndsMode('after')">
                  <div class="radio-dot"></div>
                </button>
                <span class="ends-label">After</span>
                <input type="number" class="apt-form-input ends-count-input" id="endsAfterCount" value="4" min="1">
                <span class="ends-unit">OCCURRENCES</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Service -->
      <div class="apt-form-row">
        <label class="apt-form-label">Service</label>
        <div class="apt-form-control">
          <select class="apt-form-select" id="newAptService" onchange="onServiceChange()">
            <option value="">Select...</option>
          </select>
        </div>
      </div>

      <!-- Staff -->
      <div class="apt-form-row">
        <label class="apt-form-label">Staff</label>
        <div class="apt-form-control">
          <select class="apt-form-select" id="newAptStaff">
            <option value="">Select...</option>
          </select>
        </div>
      </div>

      <!-- Venue -->
      <div class="apt-form-row">
        <label class="apt-form-label">Venue</label>
        <div class="apt-form-control">
          <select class="apt-form-select" id="newAptVenue">
            <option value="">Select...</option>
          </select>
        </div>
      </div>

      <!-- Pay rate -->
      <div class="apt-form-row">
        <label class="apt-form-label">Pay rate</label>
        <div class="apt-form-control">
          <div class="customer-row">
            <select class="apt-form-select" id="newAptPayRate">
              <option value="">Pay rate not specified</option>
              <option value="50-50">50 50</option>
              <option value="60-percent">60% per ticket</option>
              <option value="fixed-1500">Fixed Fee R1500</option>
              <option value="fixed-600">Fixed Fee R600</option>
            </select>
            <button class="add-customer-btn" title="Add pay rate">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Customer -->
      <div class="apt-form-row">
        <label class="apt-form-label">Customer</label>
        <div class="apt-form-control">
          <div class="customer-row">
            <select class="apt-form-select" id="newAptCustomer">
              <option value="">Select customer...</option>
            </select>
            <button class="add-customer-btn" title="Add new customer" onclick="openCreateCustomerModal()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Add Customer Button -->
      <button class="add-more-customer-btn" onclick="addAnotherCustomer()">+ Add customer</button>

      <!-- Duration & Buffers/Overlaps -->
      <div class="apt-form-row">
        <label class="apt-form-label">Duration &<br>Buffers/Overlaps</label>
        <div class="apt-form-control">
          <div class="duration-buffers-row">
            <div class="buffer-field">
              <input type="number" id="newAptBufferStart" value="10" min="0" step="5">
              <span class="buffer-label">Buffer at start</span>
            </div>
            <div class="buffer-field">
              <input type="number" id="newAptDuration" value="60" min="5" step="5">
              <span class="buffer-label">Duration</span>
            </div>
            <div class="buffer-field">
              <input type="number" id="newAptBufferEnd" value="10" min="0" step="5">
              <span class="buffer-label">Buffer at end</span>
            </div>
            <span class="buffer-unit">minutes</span>
          </div>
        </div>
      </div>

      <!-- Total price -->
      <div class="apt-form-row">
        <label class="apt-form-label">Total price</label>
        <div class="apt-form-control">
          <div class="price-input-row">
            <span class="price-currency">ZAR</span>
            <input type="number" id="newAptPrice" value="0" min="0" step="0.01">
          </div>
          <div class="price-note">You can charge the customer or send a payment link once the appointment is created.</div>
        </div>
      </div>

      <!-- Additional note -->
      <div class="apt-form-row" style="align-items: flex-start;">
        <label class="apt-form-label" style="padding-top: 10px;">Additional note</label>
        <div class="apt-form-control">
          <textarea class="apt-form-textarea" id="newAptNote" placeholder=""></textarea>
        </div>
      </div>
    </div>

    <div class="new-apt-modal-footer">
      <label class="send-confirmation-check">
        <input type="checkbox" id="sendConfirmation" checked>
        Send confirmation
      </label>
      <div class="modal-footer-buttons">
        <button class="apt-btn apt-btn-cancel" onclick="closeNewAptModal()">Cancel</button>
        <button class="apt-btn apt-btn-book-pay" onclick="bookAndPay()">Book & Pay</button>
        <button class="apt-btn apt-btn-book" onclick="bookAppointment()">Book</button>
      </div>
    </div>
  </div>

  <!-- Clock Status Toast -->
  <div class="clock-status-toast clocked-out" id="clockStatusToast">
    <div class="clock-status-icon clocked-out">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
    <span class="clock-status-text">Clocked out!</span>
    <button class="clock-status-close" onclick="hideClockToast()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>
</body>
</html>
