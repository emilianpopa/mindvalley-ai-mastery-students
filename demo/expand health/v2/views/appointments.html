<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Appointments - ExpandHealth</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cline x1='20' y1='20' x2='80' y2='80' stroke='%230F766E' stroke-width='12' stroke-linecap='round'/%3E%3Cline x1='80' y1='20' x2='20' y2='80' stroke='%230F766E' stroke-width='12' stroke-linecap='round'/%3E%3C/svg%3E">
  <link rel="stylesheet" href="/css/main.css">
  <script src="/js/feature-flags.js"></script>
  <script src="/js/nav.js"></script>
  <style>
    .appointments-page {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* Top Header */
    .appointments-header {
      display: flex;
      flex-direction: column;
      background: white;
      border-bottom: 1px solid var(--gray-200);
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 24px;
    }

    .header-row:first-child {
      padding-top: 16px;
    }

    .header-row:last-child {
      padding-bottom: 12px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .business-name {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .location-icon {
      width: 20px;
      height: 20px;
      color: var(--teal-500);
      cursor: pointer;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Global Utility Bar */
    .global-utility-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 8px 24px;
      background: white;
      border-bottom: 1px solid var(--gray-200);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .utility-bar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .utility-bar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Business selector */
    .business-selector {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: transparent;
      border: none;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
    }

    .business-selector:hover {
      background: var(--gray-100);
    }

    .business-selector svg {
      width: 14px;
      height: 14px;
      color: var(--gray-400);
    }

    /* Search box */
    .utility-search {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      min-width: 200px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .utility-search:hover {
      border-color: var(--gray-300);
    }

    .utility-search svg {
      width: 16px;
      height: 16px;
      color: var(--gray-400);
    }

    .utility-search-text {
      font-size: 0.8125rem;
      color: var(--gray-500);
      flex: 1;
    }

    .utility-search-shortcut {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 4px;
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--gray-500);
    }

    .utility-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: transparent;
      border: none;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
    }

    .utility-btn:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .utility-btn svg {
      width: 16px;
      height: 16px;
    }

    .utility-btn.feedback-btn {
      color: var(--purple-600);
    }

    .utility-btn.feedback-btn:hover {
      background: var(--purple-50);
    }

    .utility-btn.active {
      background: var(--purple-600);
      color: white;
    }

    .utility-btn.active:hover {
      background: var(--purple-700);
    }

    .utility-divider {
      width: 1px;
      height: 20px;
      background: var(--gray-200);
    }

    .utility-add-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .utility-add-label {
      font-size: 0.8125rem;
      color: var(--gray-500);
    }

    .utility-add-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: transparent;
      border: 1px solid var(--gray-300);
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-700);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
    }

    .utility-add-btn:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    .utility-add-btn svg {
      width: 14px;
      height: 14px;
    }

    .utility-notification-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: transparent;
      border: none;
      color: var(--gray-500);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
    }

    .utility-notification-btn:hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .utility-notification-btn svg {
      width: 18px;
      height: 18px;
    }

    .utility-user-menu {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      background: transparent;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
    }

    .utility-user-menu:hover {
      background: var(--gray-100);
    }

    .utility-user-avatar {
      width: 28px;
      height: 28px;
      background: var(--purple-100);
      color: var(--purple-700);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .utility-user-name {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-700);
    }

    .utility-user-menu svg {
      width: 14px;
      height: 14px;
      color: var(--gray-400);
    }

    /* User dropdown */
    .utility-user-dropdown {
      position: relative;
    }

    .user-dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      min-width: 200px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      padding: 8px 0;
    }

    .user-dropdown-menu.show {
      display: block;
    }

    .user-dropdown-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
      transition: background 0.15s;
      text-decoration: none;
    }

    .user-dropdown-item:hover {
      background: var(--gray-50);
    }

    .user-dropdown-item-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-dropdown-item svg {
      width: 16px;
      height: 16px;
      color: var(--gray-500);
    }

    .user-dropdown-item .chevron-right {
      width: 14px;
      height: 14px;
      color: var(--gray-400);
    }

    .user-dropdown-item .flag-icon {
      width: 18px;
      height: 14px;
      border-radius: 2px;
    }

    .user-dropdown-divider {
      height: 1px;
      background: var(--gray-200);
      margin: 8px 0;
    }

    /* Switch dashboard sub-item */
    .user-dropdown-dashboard {
      padding: 12px 16px;
      border-bottom: 1px solid var(--gray-100);
    }

    .user-dropdown-dashboard-email {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-900);
      margin-bottom: 2px;
    }

    .user-dropdown-dashboard-label {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .btn-checkout {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: white;
      border: 1px solid var(--purple-600);
      color: var(--purple-600);
      font-size: 0.875rem;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-checkout:hover {
      background: var(--purple-50);
    }

    /* Checkout dropdown */
    .checkout-dropdown {
      position: relative;
    }

    .checkout-dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      min-width: 200px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      padding: 4px 0;
    }

    .checkout-dropdown-menu.show {
      display: block;
    }

    .checkout-dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
      transition: background 0.15s;
      text-decoration: none;
    }

    .checkout-dropdown-item:hover {
      background: var(--gray-50);
    }

    .checkout-dropdown-item svg {
      width: 16px;
      height: 16px;
      color: var(--gray-500);
    }

    .btn-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: var(--purple-600);
      color: white;
      border: none;
      font-size: 0.875rem;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
    }

    .btn-actions:hover {
      background: var(--purple-700);
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px 24px;
      background: white;
      border-bottom: 1px solid var(--gray-200);
    }

    .toolbar-row {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .toolbar-row-between {
      justify-content: space-between;
    }

    /* Day/Week Toggle */
    .view-toggle {
      display: inline-flex;
      background: var(--gray-100);
      border-radius: 8px;
      padding: 4px;
    }

    .view-toggle-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: transparent;
      border: none;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-600);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .view-toggle-btn.active {
      background: white;
      color: var(--gray-900);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .view-toggle-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Week Navigation */
    .week-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .week-nav-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      cursor: pointer;
      color: var(--gray-600);
    }

    .week-nav-btn:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    .week-display {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
    }

    .week-display svg {
      width: 16px;
      height: 16px;
      color: var(--gray-400);
    }

    /* Filter Dropdowns */
    .filter-dropdown {
      position: relative;
    }

    .filter-dropdown-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
      min-width: 180px;
    }

    .filter-dropdown-btn:hover {
      border-color: var(--gray-400);
    }

    .filter-dropdown-btn svg {
      width: 16px;
      height: 16px;
      color: var(--gray-400);
    }

    .filter-dropdown-btn .chevron {
      margin-left: auto;
    }

    .filter-dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      min-width: 220px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 100;
      max-height: 300px;
      overflow-y: auto;
    }

    .filter-dropdown-menu.show {
      display: block;
    }

    .filter-dropdown-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
      transition: background 0.15s;
    }

    .filter-dropdown-item:hover {
      background: var(--gray-50);
    }

    .filter-dropdown-item.selected {
      background: var(--purple-50);
      color: var(--purple-700);
    }

    /* Staff/Venues Toggle */
    .staff-venues-toggle {
      display: inline-flex;
      background: var(--gray-100);
      border-radius: 8px;
      padding: 4px;
    }

    .staff-venues-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      background: transparent;
      border: none;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-600);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .staff-venues-btn.active {
      background: white;
      color: var(--gray-900);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .staff-venues-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Zoom buttons */
    .zoom-buttons {
      display: flex;
      gap: 4px;
    }

    .zoom-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      cursor: pointer;
      color: var(--gray-600);
    }

    .zoom-btn:hover {
      background: var(--gray-50);
    }

    .zoom-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Options/Filters buttons */
    .toolbar-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .toolbar-btn:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    .toolbar-btn.active {
      background: var(--purple-600);
      border-color: var(--purple-600);
      color: white;
    }

    .toolbar-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Dropdown menus */
    .dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      min-width: 280px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 100;
      padding: 8px 0;
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
      transition: background 0.15s;
    }

    .dropdown-checkbox-item:hover {
      background: var(--gray-50);
    }

    .dropdown-checkbox-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--purple-600);
    }

    .dropdown-action-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
      transition: background 0.15s;
    }

    .dropdown-action-item:hover {
      background: var(--gray-50);
    }

    .dropdown-action-item svg {
      width: 16px;
      height: 16px;
      color: var(--gray-500);
    }

    /* Calendar Grid */
    .calendar-container {
      flex: 1;
      overflow: auto;
      background: white;
      position: relative;
    }

    /* Sticky header row - fixed at top of scroll container */
    .calendar-header-row {
      display: grid;
      grid-template-columns: 60px repeat(7, 1fr);
      position: sticky;
      top: 0;
      z-index: 200;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: 60px repeat(7, 1fr);
      min-height: 100%;
    }

    /* Calendar Header */
    .calendar-header {
      display: contents;
    }

    .calendar-header-corner {
      background: white;
      border-bottom: 1px solid var(--gray-200);
      border-right: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 0.75rem;
      color: var(--gray-400);
      padding: 8px 4px;
    }

    .calendar-header-corner svg {
      width: 14px;
      height: 14px;
    }

    .calendar-header-day {
      background: white;
      padding: 12px 8px;
      text-align: center;
      border-bottom: 1px solid var(--gray-200);
      border-right: 1px solid var(--gray-100);
    }

    .calendar-header-day:last-child {
      border-right: none;
    }

    .day-full-date {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-700);
    }

    .day-full-date.today {
      color: var(--purple-600);
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .day-full-date.weekend {
      color: var(--gray-400);
    }

    .day-name {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--gray-500);
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .day-date {
      font-size: 0.9375rem;
      font-weight: 500;
      color: var(--gray-900);
    }

    .day-date.today {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: var(--purple-600);
      color: white;
      border-radius: 50%;
    }

    .day-date.weekend {
      color: var(--gray-400);
    }

    /* Time Column */
    .time-column {
      display: contents;
    }

    .time-slot-label {
      position: sticky;
      left: 0;
      background: white;
      z-index: 5;
      padding: 0 8px;
      font-size: 0.75rem;
      color: var(--gray-500);
      text-align: right;
      border-right: 1px solid var(--gray-200);
      height: 60px;
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
      padding-top: 0;
      transform: translateY(-8px);
    }

    /* Day Columns */
    .day-column {
      display: contents;
    }

    .time-slot {
      border-bottom: 1px solid var(--gray-100);
      border-right: 1px solid var(--gray-100);
      height: 80px; /* Taller slots like Momence */
      position: relative;
      cursor: pointer;
    }

    .time-slot:hover {
      background: var(--gray-50);
    }

    .time-slot.weekend {
      background: var(--gray-50);
    }

    .time-slot.weekend:hover {
      background: var(--gray-100);
    }

    /* Venues Mode Header */
    .venue-header {
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
      padding: 8px;
      text-align: center;
      border-bottom: 1px solid var(--gray-200);
      border-right: 1px solid var(--gray-100);
      min-width: 120px;
    }

    .venue-name {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-900);
      margin-bottom: 4px;
    }

    .venue-color {
      height: 3px;
      border-radius: 2px;
      margin-top: 4px;
    }

    /* Toolbar right group */
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Clock Status Toast */
    .clock-status-toast {
      position: fixed;
      bottom: 16px;
      left: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      min-width: 140px;
    }

    .clock-status-toast.clocked-in {
      border-left: 4px solid var(--green-500);
    }

    .clock-status-toast.clocked-out {
      border-left: 4px solid var(--teal-500);
    }

    .clock-status-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .clock-status-icon.clocked-in svg {
      color: var(--green-500);
    }

    .clock-status-icon.clocked-out svg {
      color: var(--teal-500);
    }

    .clock-status-text {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-700);
      flex: 1;
    }

    .clock-status-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      background: transparent;
      border: none;
      color: var(--gray-400);
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s;
    }

    .clock-status-close:hover {
      background: var(--gray-100);
      color: var(--gray-600);
    }

    .clock-status-close svg {
      width: 14px;
      height: 14px;
    }

    .clock-status-toast.hidden {
      display: none;
    }

    /* Appointment Detail Slide Panel */
    .appointment-panel-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .appointment-panel-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .appointment-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 480px;
      height: 100vh;
      background: white;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .appointment-panel.show {
      transform: translateX(0);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-200);
    }

    .panel-header-left {
      flex: 1;
    }

    .panel-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 2px;
    }

    .panel-id {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .panel-header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .panel-status-badge {
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .panel-status-badge.scheduled {
      background: var(--blue-100);
      color: var(--blue-700);
    }

    .panel-status-badge.paid {
      background: var(--green-100);
      color: var(--green-700);
    }

    .panel-status-badge.completed {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .panel-status-badge.cancelled {
      background: var(--red-100);
      color: var(--red-700);
    }

    .panel-status-badge.unpaid {
      background: #fecaca;
      color: #dc2626;
    }

    .panel-status-badge.confirmed {
      background: var(--purple-100);
      color: var(--purple-700);
    }

    .panel-close-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: var(--gray-400);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
    }

    .panel-close-btn:hover {
      background: var(--gray-100);
      color: var(--gray-600);
    }

    .panel-close-btn svg {
      width: 18px;
      height: 18px;
    }

    /* Signups Section */
    .panel-signups {
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-200);
    }

    .panel-signups-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .panel-signups-badge {
      padding: 4px 10px;
      background: var(--blue-100);
      color: var(--blue-700);
      font-size: 0.75rem;
      font-weight: 500;
      border-radius: 4px;
    }

    .panel-checkin-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8125rem;
      color: var(--gray-600);
    }

    .panel-signup-card {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: var(--gray-50);
      border-radius: 8px;
    }

    .panel-signup-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .panel-signup-avatar svg {
      width: 18px;
      height: 18px;
      color: var(--gray-500);
    }

    .panel-signup-info {
      flex: 1;
      min-width: 0;
    }

    .panel-signup-name {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--teal-600);
      margin-bottom: 2px;
    }

    .panel-signup-contact {
      font-size: 0.75rem;
      color: var(--gray-600);
      line-height: 1.4;
    }

    .panel-signup-badges {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
    }

    .panel-mini-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.6875rem;
      font-weight: 500;
    }

    .panel-mini-badge.price {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .panel-mini-badge.paid {
      background: var(--green-100);
      color: var(--green-700);
    }

    .panel-mini-badge.free {
      background: var(--gray-100);
      color: var(--gray-600);
    }

    .panel-signup-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .panel-toggle {
      width: 40px;
      height: 22px;
      background: var(--gray-200);
      border-radius: 11px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .panel-toggle.active {
      background: var(--green-500);
    }

    .panel-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }

    .panel-toggle.active::after {
      transform: translateX(18px);
    }

    .panel-checkin-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-checkin-time {
      font-size: 0.75rem;
      color: var(--gray-500);
      white-space: nowrap;
      display: none;
    }

    .panel-checkin-time.show {
      display: inline;
    }

    .panel-more-btn {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      color: var(--gray-400);
      cursor: pointer;
      border-radius: 4px;
    }

    .panel-more-btn:hover {
      background: var(--gray-100);
      color: var(--gray-600);
    }

    .panel-more-wrapper {
      position: relative;
    }

    .panel-signup-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      min-width: 200px;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.15s ease;
    }

    .panel-signup-menu.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(4px);
    }

    .panel-signup-menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 12px 16px;
      background: none;
      border: none;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
      text-align: left;
      transition: background 0.15s;
    }

    .panel-signup-menu-item:first-child {
      border-radius: 8px 8px 0 0;
    }

    .panel-signup-menu-item:last-child {
      border-radius: 0 0 8px 8px;
    }

    .panel-signup-menu-item:hover {
      background: var(--gray-50);
    }

    .panel-signup-menu-item svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .panel-signup-menu-item.cancel {
      color: var(--red-600);
    }

    .panel-signup-menu-item.cancel:hover {
      background: var(--red-50);
    }

    /* Add Customer Button */
    .panel-add-customer {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 10px;
      margin-top: 12px;
      background: white;
      border: 1px dashed var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.15s;
    }

    .panel-add-customer:hover {
      border-color: var(--gray-400);
      color: var(--gray-700);
    }

    .panel-add-customer svg {
      width: 16px;
      height: 16px;
    }

    /* Panel Tabs */
    .panel-tabs {
      display: flex;
      gap: 20px;
      padding: 0 20px;
      border-bottom: 1px solid var(--gray-200);
    }

    .panel-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 12px 0;
      border: none;
      background: transparent;
      font-size: 0.875rem;
      color: var(--gray-500);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all 0.15s;
    }

    .panel-tab:hover {
      color: var(--gray-700);
    }

    .panel-tab.active {
      color: var(--purple-600);
      border-bottom-color: var(--purple-600);
    }

    .panel-tab svg {
      width: 16px;
      height: 16px;
    }

    /* Panel Content */
    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .panel-section {
      margin-bottom: 20px;
    }

    .panel-section-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--gray-500);
      margin-bottom: 12px;
    }

    .panel-info-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }

    .panel-info-row:last-child {
      margin-bottom: 0;
    }

    .panel-info-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: var(--purple-100);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .panel-info-icon svg {
      width: 16px;
      height: 16px;
      color: var(--purple-600);
    }

    .panel-info-icon.gray {
      background: var(--gray-100);
    }

    .panel-info-icon.gray svg {
      color: var(--gray-600);
    }

    .panel-info-icon.teal {
      background: var(--teal-100);
    }

    .panel-info-icon.teal svg {
      color: var(--teal-600);
    }

    .panel-info-icon.green {
      background: var(--green-100);
    }

    .panel-info-icon.green svg {
      color: var(--green-600);
    }

    .panel-info-content {
      flex: 1;
    }

    .panel-info-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-900);
    }

    .panel-info-sublabel {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 2px;
    }

    .panel-info-link {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--purple-600);
      text-decoration: none;
    }

    .panel-info-link:hover {
      text-decoration: underline;
    }

    /* Practitioner Row - Side by Side */
    .panel-practitioner-row {
      display: flex;
      align-items: flex-start;
      gap: 24px;
    }

    .panel-practitioner-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Pricing Section */
    .panel-pricing-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .panel-price-label {
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    .panel-price-value {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .panel-price-credits {
      font-size: 0.75rem;
      color: var(--gray-500);
      font-weight: 400;
    }

    .panel-price-actions {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .panel-price-type {
      display: inline-block;
      padding: 4px 10px;
      background: var(--blue-100);
      color: var(--blue-700);
      font-size: 0.75rem;
      font-weight: 500;
      border-radius: 4px;
    }

    .panel-copy-link-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: none;
      border: none;
      color: var(--blue-600);
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.15s;
    }

    .panel-copy-link-btn:hover {
      color: var(--blue-700);
      text-decoration: underline;
    }

    /* Service Section */
    .panel-service-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .panel-service-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: var(--green-500);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .panel-service-icon svg {
      width: 16px;
      height: 16px;
      color: white;
    }

    .panel-service-name {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--purple-600);
    }

    .panel-service-board {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .panel-service-row-clickable {
      cursor: pointer;
      border-radius: 8px;
      padding: 8px;
      margin: -8px;
      transition: background-color 0.15s;
    }

    .panel-service-row-clickable:hover {
      background-color: var(--gray-50);
    }

    .panel-service-row-clickable .panel-service-name {
      text-decoration: none;
    }

    .panel-service-row-clickable:hover .panel-service-name {
      text-decoration: underline;
    }

    /* Add to Calendar */
    .panel-add-calendar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 12px;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.15s;
      margin-top: 16px;
    }

    .panel-add-calendar:hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .panel-add-calendar svg {
      width: 18px;
      height: 18px;
    }

    /* Panel Footer */
    .panel-footer {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--gray-200);
      background: white;
    }

    .panel-footer-top {
      display: flex;
      gap: 8px;
    }

    .panel-footer-bottom {
      display: flex;
      gap: 8px;
    }

    .panel-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .panel-btn svg {
      width: 16px;
      height: 16px;
    }

    .panel-btn-secondary {
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      color: var(--gray-700);
    }

    .panel-btn-secondary:hover {
      background: var(--gray-200);
    }

    .panel-btn-cancel {
      background: white;
      border: 1px solid var(--red-300);
      color: var(--red-600);
    }

    .panel-btn-cancel:hover {
      background: var(--red-50);
    }

    .panel-btn-edit {
      background: var(--purple-600);
      border: none;
      color: white;
    }

    .panel-btn-edit:hover {
      background: var(--purple-700);
    }

    .panel-btn-pay {
      background: var(--purple-600);
      border: none;
      color: white;
    }

    .panel-btn-pay:hover {
      background: var(--purple-700);
    }

    .panel-btn-pay.paid {
      background: white;
      border: 1px solid var(--green-500);
      color: var(--green-600);
    }

    .panel-btn-pay.paid:hover {
      background: var(--green-50);
    }

    .panel-btn-paid {
      background: white;
      border: 1px solid var(--green-500);
      color: var(--green-600);
    }

    .panel-btn-paid:hover {
      background: var(--green-50);
    }

    /* Add Customer Modal */
    .add-customer-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .add-customer-modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .add-customer-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      z-index: 2001;
      width: 480px;
      max-width: 90vw;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .add-customer-modal.show {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    .add-customer-modal-header {
      display: flex;
      align-items: center;
      padding: 20px 20px 12px 20px;
      gap: 12px;
    }

    .add-customer-modal-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .modal-header-spacer {
      flex: 1;
    }

    .modal-limit-badge {
      background: #FEE2E2;
      color: #DC2626;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .modal-close-btn {
      background: none;
      border: none;
      padding: 4px;
      cursor: pointer;
      color: var(--gray-500);
      border-radius: 4px;
    }

    .modal-close-btn:hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .modal-close-btn svg {
      width: 20px;
      height: 20px;
    }

    .add-customer-modal-body {
      padding: 0 20px 20px 20px;
    }

    .modal-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    .modal-select-row {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .modal-select {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-700);
      background: white;
      cursor: pointer;
    }

    .modal-select:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }

    .modal-add-new-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      cursor: pointer;
      color: var(--gray-600);
      transition: all 0.15s;
    }

    .modal-add-new-btn:hover {
      background: var(--gray-200);
      color: var(--gray-800);
    }

    .modal-add-new-btn svg {
      width: 18px;
      height: 18px;
    }

    .modal-checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
    }

    .modal-checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--purple-600);
    }

    .modal-actions-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 16px;
      gap: 16px;
    }

    .modal-buttons {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .modal-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .modal-btn-cancel {
      background: white;
      border: 1px solid var(--gray-300);
      color: var(--gray-700);
    }

    .modal-btn-cancel:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }

    .modal-btn-add {
      background: #2563eb;
      border: 1px solid #2563eb;
      color: white;
    }

    .modal-btn-add:hover {
      background: #1d4ed8;
      border-color: #1d4ed8;
    }

    /* Custom Customer Dropdown (Momence-style) */
    .customer-dropdown-container {
      position: relative;
      margin-bottom: 16px;
    }

    .customer-dropdown-row {
      display: flex;
      gap: 8px;
    }

    .customer-dropdown {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      min-height: 44px;
      transition: all 0.15s;
    }

    .customer-dropdown:hover {
      border-color: var(--gray-400);
    }

    .customer-dropdown.open {
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }

    .customer-dropdown-selected {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 0;
    }

    .dropdown-placeholder {
      color: var(--gray-500);
      font-size: 0.875rem;
    }

    .dropdown-arrow {
      width: 18px;
      height: 18px;
      color: var(--gray-400);
      flex-shrink: 0;
      transition: transform 0.2s;
    }

    .customer-dropdown.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .customer-dropdown-menu {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 48px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s ease;
    }

    .customer-dropdown-menu.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .customer-search-wrapper {
      position: relative;
      padding: 12px;
      border-bottom: 1px solid var(--gray-100);
    }

    .customer-search-icon {
      position: absolute;
      left: 22px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      color: var(--gray-400);
      pointer-events: none;
    }

    .customer-search-input {
      width: 100%;
      padding: 10px 12px 10px 36px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 0.875rem;
      color: var(--gray-900);
      background: var(--gray-50);
    }

    .customer-search-input:focus {
      outline: none;
      border-color: var(--purple-500);
      background: white;
    }

    .customer-search-input::placeholder {
      color: var(--gray-400);
    }

    .customer-list {
      max-height: 280px;
      overflow-y: auto;
      padding: 8px 0;
    }

    .customer-list::-webkit-scrollbar {
      width: 6px;
    }

    .customer-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .customer-list::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 3px;
    }

    .customer-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.1s;
    }

    .customer-item:hover {
      background: var(--gray-50);
    }

    .customer-item.selected {
      background: var(--purple-50);
    }

    .customer-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--purple-100);
      color: var(--purple-700);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 600;
      flex-shrink: 0;
      overflow: hidden;
    }

    .customer-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .customer-info {
      flex: 1;
      min-width: 0;
    }

    .customer-name {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-900);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .customer-email {
      font-size: 0.75rem;
      color: var(--gray-500);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .customer-no-results {
      padding: 20px 16px;
      text-align: center;
      color: var(--gray-500);
      font-size: 0.875rem;
    }

    /* Selected customer in dropdown trigger */
    .selected-customer-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--purple-100);
      color: var(--purple-700);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .selected-customer-info {
      flex: 1;
      min-width: 0;
    }

    .selected-customer-name {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-900);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .selected-customer-email {
      font-size: 0.75rem;
      color: var(--gray-500);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .modal-btn-add:disabled {
      background: var(--gray-300);
      border-color: var(--gray-300);
      cursor: not-allowed;
    }

    /* Create Customer Modal */
    .create-customer-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2100;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .create-customer-modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .create-customer-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      z-index: 2101;
      width: 360px;
      max-width: 90vw;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .create-customer-modal.show {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    .create-customer-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 20px 16px 20px;
    }

    .create-customer-modal-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .create-customer-modal-body {
      padding: 0 20px 20px 20px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-600);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-800);
      background: white;
      box-sizing: border-box;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }

    .phone-input-row {
      display: flex;
      gap: 8px;
    }

    .country-code-select {
      width: 100px;
      padding: 10px 8px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-800);
      background: white;
      cursor: pointer;
    }

    .country-code-select:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }

    .phone-input {
      flex: 1;
    }

    .create-customer-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--gray-200);
    }

    .modal-btn-create {
      background: var(--purple-600);
      border: 1px solid var(--purple-600);
      color: white;
    }

    .modal-btn-create:hover {
      background: var(--purple-700);
      border-color: var(--purple-700);
    }

    /* Edit Appointment Modal */
    .edit-apt-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .edit-apt-modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .edit-apt-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      z-index: 2001;
      width: 600px;
      max-width: 90vw;
      max-height: 90vh;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
    }

    .edit-apt-modal.show {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    .edit-apt-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
    }

    .edit-apt-modal-header h3 {
      margin: 0;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .edit-apt-modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .edit-apt-form-row {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      gap: 16px;
    }

    .edit-apt-form-row-top {
      align-items: flex-start;
    }

    .edit-apt-form-label {
      width: 140px;
      flex-shrink: 0;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
    }

    .edit-apt-form-value {
      font-size: 0.875rem;
      color: var(--gray-900);
    }

    .edit-apt-form-control {
      flex: 1;
    }

    .edit-apt-form-control-with-btn {
      display: flex;
      gap: 8px;
    }

    .edit-apt-form-input,
    .edit-apt-form-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-900);
      background: white;
    }

    .edit-apt-form-input:focus,
    .edit-apt-form-select:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .edit-apt-form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-900);
      resize: vertical;
      font-family: inherit;
    }

    .edit-apt-form-textarea:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .edit-apt-form-hint {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: -12px;
      margin-bottom: 20px;
      padding-left: 156px;
    }

    .edit-apt-add-btn {
      width: 40px;
      height: 40px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 1.25rem;
      color: var(--gray-600);
      cursor: pointer;
    }

    .edit-apt-add-btn:hover {
      background: var(--gray-200);
    }

    .edit-apt-duration-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .edit-apt-duration-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .edit-apt-duration-input {
      width: 70px;
      text-align: center;
    }

    .edit-apt-duration-label {
      font-size: 0.7rem;
      color: var(--gray-500);
      text-align: center;
    }

    .edit-apt-duration-unit {
      font-size: 0.875rem;
      color: var(--gray-600);
      align-self: center;
      padding-top: 10px;
    }

    .edit-apt-price-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .edit-apt-currency {
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    .edit-apt-price-input {
      width: 120px;
    }

    .edit-apt-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      border-top: 1px solid var(--gray-200);
      background: white;
    }

    .edit-apt-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .edit-apt-btn-cancel {
      background: white;
      border: 1px solid var(--gray-300);
      color: var(--gray-700);
    }

    .edit-apt-btn-cancel:hover {
      background: var(--gray-50);
    }

    .edit-apt-btn-save {
      background: var(--purple-600);
      border: none;
      color: white;
    }

    .edit-apt-btn-save:hover {
      background: var(--purple-700);
    }

    /* New Appointment Modal */
    .new-apt-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .new-apt-modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .new-apt-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      z-index: 2001;
      width: 480px;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .new-apt-modal.show {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    .new-apt-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 20px 16px 20px;
      border-bottom: 1px solid var(--gray-200);
    }

    .new-apt-modal-header h3 {
      margin: 0;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .new-apt-modal-body {
      padding: 20px;
    }

    .apt-type-toggle {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
      border: 2px solid var(--purple-500);
      border-radius: 8px;
      overflow: hidden;
    }

    .apt-type-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      border: none;
      background: white;
      font-size: 0.875rem;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.15s;
    }

    .apt-type-btn.active {
      background: var(--purple-500);
      color: white;
    }

    .apt-type-btn svg {
      width: 18px;
      height: 18px;
    }

    .apt-form-row {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
      gap: 16px;
    }

    .apt-form-label {
      width: 100px;
      flex-shrink: 0;
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    .apt-form-control {
      flex: 1;
    }

    .apt-form-select,
    .apt-form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      color: var(--gray-800);
      background: white;
      cursor: pointer;
    }

    .apt-form-select:focus,
    .apt-form-input:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }

    .apt-toggle-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .apt-toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--gray-200);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .apt-toggle.active {
      background: var(--purple-500);
    }

    .apt-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      pointer-events: none;
    }

    .apt-toggle.active::after {
      transform: translateX(20px);
    }

    .apt-toggle-label {
      font-size: 0.875rem;
      color: var(--gray-700);
    }

    .recurring-options {
      display: none;
    }

    .recurring-options.show {
      display: block;
    }

    .repeat-every-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .repeat-input {
      width: 80px !important;
      text-align: center;
    }

    .repeat-unit {
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    .ends-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ends-option {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ends-radio-btn {
      width: 20px;
      height: 20px;
      border: 2px solid var(--gray-300);
      border-radius: 50%;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      flex-shrink: 0;
    }

    .ends-radio-btn.active {
      border-color: var(--purple-500);
    }

    .ends-radio-btn .radio-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: transparent;
    }

    .ends-radio-btn.active .radio-dot {
      background: var(--purple-500);
    }

    .ends-label {
      font-size: 0.875rem;
      color: var(--gray-700);
      min-width: 40px;
    }

    .ends-date-input {
      width: 150px !important;
    }

    .ends-count-input {
      width: 70px !important;
      text-align: center;
    }

    .ends-unit {
      font-size: 0.75rem;
      color: var(--gray-500);
      text-transform: uppercase;
    }

    .customer-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .customer-row .apt-form-select {
      flex: 1;
    }

    /* Searchable Customer Dropdown - Momence Style */
    .searchable-dropdown {
      position: relative;
      flex: 1;
    }

    .searchable-dropdown-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      background: white;
      font-size: 0.875rem;
      color: var(--gray-900);
      cursor: pointer;
      transition: border-color 0.15s;
    }

    .searchable-dropdown-trigger:hover {
      border-color: var(--gray-400);
    }

    .searchable-dropdown-trigger.active {
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .searchable-dropdown-trigger .placeholder {
      color: var(--gray-400);
    }

    .searchable-dropdown-trigger .selected-customer {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .searchable-dropdown-trigger .customer-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--purple-100);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--purple-700);
    }

    .searchable-dropdown-trigger .customer-info {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .searchable-dropdown-trigger .customer-name {
      font-weight: 500;
      color: var(--gray-900);
      line-height: 1.2;
    }

    .searchable-dropdown-trigger .customer-email {
      font-size: 0.75rem;
      color: var(--gray-500);
      line-height: 1.2;
    }

    .searchable-dropdown-trigger svg {
      width: 16px;
      height: 16px;
      color: var(--gray-400);
      flex-shrink: 0;
    }

    .searchable-dropdown-menu {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      display: none;
      max-height: 350px;
      overflow: hidden;
    }

    .searchable-dropdown-menu.show {
      display: block;
    }

    .searchable-dropdown-search {
      padding: 12px;
      border-bottom: 1px solid var(--gray-100);
    }

    .searchable-dropdown-search input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      outline: none;
    }

    .searchable-dropdown-search input:focus {
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .searchable-dropdown-search input::placeholder {
      color: var(--gray-400);
    }

    .searchable-dropdown-list {
      max-height: 280px;
      overflow-y: auto;
      padding: 8px 0;
    }

    .searchable-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.1s;
    }

    .searchable-dropdown-item:hover {
      background: var(--gray-50);
    }

    .searchable-dropdown-item.selected {
      background: var(--purple-50);
    }

    .searchable-dropdown-item .customer-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-600);
      flex-shrink: 0;
    }

    .searchable-dropdown-item .customer-info {
      flex: 1;
      min-width: 0;
    }

    .searchable-dropdown-item .customer-name {
      font-weight: 500;
      color: var(--gray-900);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .searchable-dropdown-item .customer-email {
      font-size: 0.8125rem;
      color: var(--gray-500);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .searchable-dropdown-empty {
      padding: 24px 16px;
      text-align: center;
      color: var(--gray-500);
      font-size: 0.875rem;
    }

    .add-customer-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      color: var(--gray-600);
    }

    .add-customer-btn:hover {
      background: var(--gray-50);
    }

    .add-customer-btn svg {
      width: 18px;
      height: 18px;
    }

    .add-more-customer-btn {
      width: 100%;
      padding: 10px;
      border: 1px dashed var(--gray-300);
      border-radius: 8px;
      background: white;
      font-size: 0.875rem;
      color: var(--gray-600);
      cursor: pointer;
      margin-bottom: 16px;
    }

    .add-more-customer-btn:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    .duration-buffers-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .buffer-field {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .buffer-field input {
      width: 70px;
      padding: 10px 8px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      text-align: center;
    }

    .buffer-field input:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }

    .buffer-label {
      font-size: 0.6875rem;
      color: var(--gray-500);
      text-align: center;
    }

    .buffer-unit {
      font-size: 0.875rem;
      color: var(--gray-600);
      align-self: center;
      padding-top: 6px;
    }

    .price-input-row {
      display: flex;
      align-items: center;
      gap: 0;
    }

    .price-currency {
      padding: 10px 12px;
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-right: none;
      border-radius: 8px 0 0 8px;
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    .price-input-row input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 0 8px 8px 0;
      font-size: 0.875rem;
    }

    .price-note {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 6px;
    }

    .apt-form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }

    .apt-form-textarea:focus {
      outline: none;
      border-color: var(--purple-500);
      box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }

    .new-apt-modal-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-top: 1px solid var(--gray-200);
    }

    .send-confirmation-check {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
      color: var(--gray-700);
    }

    .send-confirmation-check input {
      width: 18px;
      height: 18px;
      accent-color: var(--purple-500);
    }

    .modal-footer-buttons {
      display: flex;
      gap: 12px;
    }

    .apt-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .apt-btn-cancel {
      background: white;
      border: 1px solid var(--gray-300);
      color: var(--gray-700);
    }

    .apt-btn-cancel:hover {
      background: var(--gray-50);
    }

    .apt-btn-book-pay {
      background: white;
      border: 1px solid var(--gray-300);
      color: var(--gray-700);
    }

    .apt-btn-book-pay:hover {
      background: var(--gray-50);
    }

    .apt-btn-book {
      background: var(--purple-600);
      border: 1px solid var(--purple-600);
      color: white;
    }

    .apt-btn-book:hover {
      background: var(--purple-700);
      border-color: var(--purple-700);
    }

    .modal-btn-create:disabled {
      background: var(--gray-300);
      border-color: var(--gray-300);
      cursor: not-allowed;
    }

    /* Appointment Block Styles - Color based on payment status */
    .appointment-block {
      position: relative;
      transition: filter 0.1s, box-shadow 0.1s;
    }

    .appointment-block.paid {
      background: #4ade80 !important;
    }

    .appointment-block.unpaid {
      background: #ef4444 !important;
    }

    /* Time block styling - gray like Momence */
    .appointment-block.time-block {
      background: #6b7280 !important;
      color: white !important;
    }

    .appointment-block.time-block .apt-title,
    .appointment-block.time-block .apt-time,
    .appointment-block.time-block .apt-client,
    .appointment-block.time-block .apt-practitioner {
      color: white !important;
    }

    .appointment-block:hover {
      filter: brightness(0.95);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
    }

    /* Hover Tooltip - Momence-style (appears ABOVE the appointment) */
    .apt-tooltip {
      display: none;
      position: absolute;
      left: 0;
      bottom: calc(100% + 4px);
      min-width: 240px;
      max-width: 280px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15), 0 0 1px rgba(0,0,0,0.1);
      padding: 0;
      z-index: 1000;
      font-size: 0.8125rem;
      overflow: visible;
      pointer-events: none; /* Allow clicks to pass through to appointment block */
    }

    .appointment-block:hover .apt-tooltip {
      display: block;
    }

    /* Tooltip header with payment status */
    .apt-tooltip-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }

    .apt-tooltip-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .apt-tooltip-status-dot.paid {
      background: #22c55e;
    }

    .apt-tooltip-status-dot.unpaid {
      background: #ef4444;
    }

    .apt-tooltip-status-dot.confirmed {
      background: #eab308;
    }

    .apt-tooltip-status-text {
      font-size: 0.75rem;
      font-weight: 500;
      color: #64748b;
    }

    /* Tooltip body */
    .apt-tooltip-body {
      padding: 12px;
    }

    .apt-tooltip-service {
      font-weight: 600;
      color: #1e293b;
      font-size: 0.875rem;
      margin-bottom: 8px;
    }

    .apt-tooltip-client {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .apt-tooltip-client-name {
      font-weight: 500;
      color: #334155;
      font-size: 0.8125rem;
    }

    .apt-tooltip-client-email {
      font-size: 0.75rem;
      color: #64748b;
      margin-bottom: 10px;
    }

    .apt-tooltip-divider {
      height: 1px;
      background: #e2e8f0;
      margin: 10px 0;
    }

    .apt-tooltip-details {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .apt-tooltip-detail {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: #64748b;
    }

    .apt-tooltip-detail svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
      color: #94a3b8;
    }

    .apt-tooltip-detail-value {
      color: #475569;
    }

    /* Status indicator on appointment block */
    .apt-status-indicator {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      border: 1.5px solid white;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .apt-status-indicator.paid {
      background: #22c55e;
    }

    .apt-status-indicator.unpaid {
      background: #ef4444;
    }

    .apt-status-indicator.confirmed {
      background: #a855f7;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <svg class="logo-icon" width="28" height="28" viewBox="0 0 24 24" fill="none">
            <path d="M4 4L11 12L4 20" stroke="#0F766E" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M20 4L13 12L20 20" stroke="#0F766E" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div class="logo-text">
            <span class="logo-expand">EXPAND</span>
            <span class="logo-health">HEALTH</span>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section-title">AI</div>
        <a href="/" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
          <span>Dashboard</span>
        </a>
        <a href="/clients" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          <span>Clients</span>
        </a>

        <div class="nav-section-title">AI ADMIN</div>
        <a href="/forms" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
          <span>Forms</span>
        </a>
        <a href="/protocol-templates" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
          <span>Protocol Templates</span>
        </a>
        <a href="/admin" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
          <span>Admin Settings</span>
        </a>
        <a href="/kb-admin" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
          <span>AI Knowledge Base</span>
        </a>

        <div class="nav-section booking-nav">
          <div class="nav-section-title">BOOKING</div>
          <a href="/schedule" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>
            <span>Dashboard</span>
          </a>
          <a href="/inbox" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
            <span>Inbox</span>
          </a>
          <a href="/pos" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
            <span>Point of sale</span>
          </a>
          <div class="nav-dropdown">
            <div class="nav-dropdown-trigger">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              <span>Classes</span>
              <svg class="nav-dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </div>
            <div class="nav-dropdown-menu">
              <div class="nav-dropdown-header">CLASSES</div>
              <div class="nav-dropdown-section">SCHEDULING</div>
              <a href="/classes" class="nav-dropdown-item">Schedule</a>
              <a href="/class-templates" class="nav-dropdown-item">Class templates</a>
              <div class="nav-dropdown-section">PRACTITIONERS</div>
              <a href="/substitution-requests" class="nav-dropdown-item">Substitution requests</a>
            </div>
          </div>
          <div class="nav-dropdown">
            <div class="nav-dropdown-trigger active">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              <span>Appointments</span>
              <svg class="nav-dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </div>
            <div class="nav-dropdown-menu">
              <div class="nav-dropdown-header">APPOINTMENTS</div>
              <a href="/appointments" class="nav-dropdown-item active">Schedule</a>
              <a href="/reservations" class="nav-dropdown-item">Reservations</a>
              <a href="/services" class="nav-dropdown-item">Services & add-ons</a>
              <a href="/boards" class="nav-dropdown-item">Boards</a>
            </div>
          </div>
          <a href="/community" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            <span>Community</span>
          </a>
          <a href="/on-demand" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            <span>On-Demand</span>
          </a>
          <a href="/memberships" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <span>Memberships</span>
          </a>
          <a href="/discounts" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
            <span>Discount codes</span>
          </a>
          <a href="/customers" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            <span>Customers</span>
          </a>
          <a href="/leads" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
            <span>Marketing</span>
          </a>
          <a href="/analytics" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
            <span>Analytics</span>
          </a>
          <a href="/financials" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
            <span>Financials</span>
          </a>
        </div>

        <div class="nav-section booking-nav">
          <div class="nav-section-title">STUDIO SET-UP</div>
          <a href="/studio/practitioners" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            <span>Practitioners</span>
          </a>
          <a href="/services" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
            <span>Services</span>
          </a>
          <a href="/studio/locations" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
            <span>Locations</span>
          </a>
          <a href="/settings/attendance-rules" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
            <span>Attendance Rules</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="appointments-page">
        <!-- Global Utility Bar -->
        <div class="global-utility-bar">
          <div class="utility-bar-left">
            <!-- Business Selector -->
            <button class="business-selector">
              Expand Health (...
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
          </div>

          <div class="utility-bar-right">
            <button class="utility-btn feedback-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              Feedback
            </button>
            <div class="utility-divider"></div>
            <div class="utility-add-group">
              <span class="utility-add-label">Add:</span>
              <button class="utility-add-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="8.5" cy="7" r="4"></circle>
                  <line x1="20" y1="8" x2="20" y2="14"></line>
                  <line x1="23" y1="11" x2="17" y2="11"></line>
                </svg>
                Customer
              </button>
              <button class="utility-add-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="8.5" cy="7" r="4"></circle>
                  <polyline points="17 11 19 13 23 9"></polyline>
                </svg>
                Lead
              </button>
              <button class="utility-add-btn" onclick="openNewAptModal(new Date())">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                  <line x1="12" y1="14" x2="12" y2="18"></line>
                  <line x1="10" y1="16" x2="14" y2="16"></line>
                </svg>
                Appointment
              </button>
            </div>
            <div class="utility-divider"></div>
            <a href="/pos" class="utility-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                <line x1="8" y1="21" x2="16" y2="21"></line>
                <line x1="12" y1="17" x2="12" y2="21"></line>
              </svg>
              POS
            </a>
            <a href="/appointments" class="utility-btn active">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              Schedule
            </a>
            <div class="utility-divider"></div>
            <button class="utility-notification-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
              </svg>
            </button>
            <div class="utility-user-dropdown">
              <button class="utility-user-menu" onclick="toggleUserMenu()">
                <div class="utility-user-avatar">EP</div>
                <span class="utility-user-name">Emilian P.</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
              <div class="user-dropdown-menu" id="userDropdownMenu">
              <a href="/account" class="user-dropdown-item">
                <div class="user-dropdown-item-left">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                  Manage account
                </div>
              </a>
              <div class="user-dropdown-item">
                <div class="user-dropdown-item-left">
                  <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 30'%3E%3Crect fill='%23002868' width='60' height='30'/%3E%3Cg fill='%23fff'%3E%3Crect y='3.5' width='60' height='2.3'/%3E%3Crect y='9.2' width='60' height='2.3'/%3E%3Crect y='14.9' width='60' height='2.3'/%3E%3Crect y='20.6' width='60' height='2.3'/%3E%3Crect y='26.3' width='60' height='2.3'/%3E%3C/g%3E%3Crect fill='%23002868' width='24' height='16'/%3E%3C/svg%3E" class="flag-icon" alt="US">
                  English
                </div>
                <svg class="chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </div>
              <div class="user-dropdown-item">
                <div class="user-dropdown-item-left">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                  </svg>
                  Switch dashboard
                </div>
                <svg class="chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </div>
              <div class="user-dropdown-dashboard">
                <div class="user-dropdown-dashboard-email">emilian@expand.health</div>
                <div class="user-dropdown-dashboard-label">Customer dashboard</div>
              </div>
              <div class="user-dropdown-item" onclick="toggleClockStatus()">
                <div class="user-dropdown-item-left">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                  <span id="clockMenuItem">Clock in</span>
                </div>
              </div>
              <div class="user-dropdown-divider"></div>
              <a href="https://support.momence.com" target="_blank" class="user-dropdown-item">
                <div class="user-dropdown-item-left">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                  </svg>
                  Support
                </div>
              </a>
              <div class="user-dropdown-item" onclick="signOut()">
                <div class="user-dropdown-item-left">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                  </svg>
                  Sign Out
                </div>
              </div>
            </div>
            </div>
          </div>
        </div>

        <!-- Header -->
        <div class="appointments-header">
          <!-- Single row: Business name + Checkout/Actions + Staff/Venues toggle -->
          <div class="header-row">
            <div class="header-left">
              <h1 class="business-name">Expand Health</h1>
              <svg class="location-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
            </div>
            <div class="header-right">
              <div class="checkout-dropdown">
                <button class="btn-checkout" onclick="toggleCheckoutMenu()">
                  Checkout
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                  </svg>
                </button>
                <div class="checkout-dropdown-menu" id="checkoutMenu">
                  <a href="/single-reservation" class="checkout-dropdown-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6"></line>
                      <line x1="8" y1="2" x2="8" y2="6"></line>
                      <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    Single reservation flow
                  </a>
                  <a href="/multi-reservation" class="checkout-dropdown-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6"></line>
                      <line x1="8" y1="2" x2="8" y2="6"></line>
                      <line x1="3" y1="10" x2="21" y2="10"></line>
                      <line x1="9" y1="14" x2="15" y2="14"></line>
                      <line x1="9" y1="18" x2="15" y2="18"></line>
                    </svg>
                    Multi reservation flow
                  </a>
                </div>
              </div>
              <div class="filter-dropdown">
                <button class="btn-actions" onclick="toggleActionsMenu()">
                  Actions
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="19" cy="12" r="1"></circle>
                    <circle cx="5" cy="12" r="1"></circle>
                  </svg>
                </button>
                <div class="dropdown-menu" id="actionsMenu">
                  <div class="dropdown-action-item" onclick="editBoard()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Edit board
                  </div>
                  <div class="dropdown-action-item" onclick="openAppointmentSettings()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="3"></circle>
                      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    Appointment settings
                  </div>
                </div>
              </div>
              <!-- Staff/Venues Toggle -->
              <div class="staff-venues-toggle">
                <button class="staff-venues-btn active" data-mode="staff" onclick="setMode('staff')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                  Staff
                </button>
                <button class="staff-venues-btn" data-mode="venues" onclick="setMode('venues')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                  Venues
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
          <div class="toolbar-row toolbar-row-between">
            <div class="toolbar-left">
              <!-- Day/Week Toggle -->
              <div class="view-toggle">
                <button class="view-toggle-btn" data-view="day" onclick="setView('day')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                  Day
                </button>
                <button class="view-toggle-btn active" data-view="week" onclick="setView('week')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                  Week
                </button>
              </div>

              <!-- Week Navigation -->
              <div class="week-nav">
                <button class="week-nav-btn" onclick="prevWeek()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                  </svg>
                </button>
                <div class="week-display">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                  <span id="weekDisplay">Week 2, 2026</span>
                </div>
                <button class="week-nav-btn" onclick="nextWeek()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </button>
              </div>

              <!-- Location Dropdown (Main business location) -->
              <div class="filter-dropdown">
                <button class="filter-dropdown-btn" onclick="toggleDropdown('locationDropdown')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>
                  <span id="selectedLocation">Expand Health</span>
                  <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div class="filter-dropdown-menu" id="locationDropdown">
                  <div class="filter-dropdown-item selected" onclick="selectLocation('Expand Health')">Expand Health</div>
                </div>
              </div>

              <!-- Staff Dropdown (shown when Staff mode) -->
              <div class="filter-dropdown" id="staffDropdownContainer">
                <button class="filter-dropdown-btn" onclick="toggleDropdown('staffDropdown')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                  <span id="selectedStaff">All Staff</span>
                  <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div class="filter-dropdown-menu" id="staffDropdown">
                  <div class="filter-dropdown-item selected" onclick="selectStaff('All Staff')">All Staff</div>
                  <div class="filter-dropdown-item" onclick="selectStaff('Avela Jafta')">Avela Jafta</div>
                  <div class="filter-dropdown-item" onclick="selectStaff('Chantel Newmark')">Chantel Newmark</div>
                  <div class="filter-dropdown-item" onclick="selectStaff('Dr Melody Fourie')">Dr Melody Fourie</div>
                  <div class="filter-dropdown-item" onclick="selectStaff('Emilian Popa')">Emilian Popa</div>
                  <div class="filter-dropdown-item" onclick="selectStaff('Jack Harland')">Jack Harland</div>
                  <div class="filter-dropdown-item" onclick="selectStaff('Karrin Bamber')">Karrin Bamber</div>
                </div>
              </div>

              <!-- Venue/Room Dropdown (shown when Venues mode) -->
              <div class="filter-dropdown" id="venueDropdownContainer" style="display: none;">
                <button class="filter-dropdown-btn" onclick="toggleDropdown('venueDropdown')" style="border-color: var(--purple-300);">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                  <span id="selectedVenue">Compression boot location</span>
                  <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div class="filter-dropdown-menu" id="venueDropdown">
                  <div class="filter-dropdown-item" onclick="selectVenue('36457')">36457</div>
                  <div class="filter-dropdown-item selected" onclick="selectVenue('Compression boot location')">Compression boot location</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('Consult Room 1')">Consult Room 1</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('Consult Room 2')">Consult Room 2</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('Consult Room 3')">Consult Room 3</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('Drip Location')">Drip Location</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('Event Space')">Event Space</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('HBOT')">HBOT</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('Hocatt + Massage')">Hocatt + Massage</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('Ice bath 1')">Ice bath 1</div>
                  <div class="filter-dropdown-item" onclick="selectVenue('Ice bath 2')">Ice bath 2</div>
                </div>
              </div>
            </div>

            <div class="toolbar-right">
              <!-- Zoom buttons -->
              <div class="zoom-buttons">
                <button class="zoom-btn" onclick="zoomOut()" title="Zoom out">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                </button>
                <button class="zoom-btn" onclick="zoomIn()" title="Zoom in">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                </button>
              </div>

              <!-- Options button -->
              <div class="filter-dropdown">
                <button class="toolbar-btn" onclick="toggleDropdown('optionsMenu')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                  Options
                </button>
                <div class="dropdown-menu" id="optionsMenu">
                  <label class="dropdown-checkbox-item">
                    <input type="checkbox" id="optCropHours" checked>
                    Crop all hours outside of available times
                  </label>
                  <label class="dropdown-checkbox-item">
                    <input type="checkbox" id="optCropEmpty">
                    Crop empty hours outside of first & last item
                  </label>
                  <label class="dropdown-checkbox-item">
                    <input type="checkbox" id="optSwapColors" checked>
                    Swap colors of background & status
                  </label>
                  <label class="dropdown-checkbox-item">
                    <input type="checkbox" id="optShowCustomFields">
                    Show contents of custom fields
                  </label>
                  <label class="dropdown-checkbox-item">
                    <input type="checkbox" id="optShowPrepFinish">
                    Show prep & finish parts of reservations
                  </label>
                  <label class="dropdown-checkbox-item">
                    <input type="checkbox" id="optShowBuffer">
                    Show buffer & overlap times of reservations
                  </label>
                </div>
              </div>

              <!-- Filters button -->
              <div class="filter-dropdown">
                <button class="toolbar-btn" onclick="toggleDropdown('filtersMenu')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                  Filters
                </button>
                <div class="dropdown-menu" id="filtersMenu">
                  <label class="dropdown-checkbox-item">
                    <input type="checkbox" id="filterCancelled">
                    Show cancelled appointments
                  </label>
                  <label class="dropdown-checkbox-item">
                    <input type="checkbox" id="filterLateCancelled" checked>
                    Show late cancelled appointments
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Calendar Grid -->
        <div class="calendar-container">
          <!-- Sticky Header Row -->
          <div class="calendar-header-row" id="calendarHeaderRow">
            <div class="calendar-header-corner">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <span>GMT+2</span>
            </div>
            <div class="calendar-header-day" id="dayHeader0">
              <span class="day-full-date">Sun, Jan 4</span>
            </div>
            <div class="calendar-header-day" id="dayHeader1">
              <span class="day-full-date">Mon, Jan 5</span>
            </div>
            <div class="calendar-header-day" id="dayHeader2">
              <span class="day-full-date today">Tue, Jan 6</span>
            </div>
            <div class="calendar-header-day" id="dayHeader3">
              <span class="day-full-date">Wed, Jan 7</span>
            </div>
            <div class="calendar-header-day" id="dayHeader4">
              <span class="day-full-date">Thu, Jan 8</span>
            </div>
            <div class="calendar-header-day" id="dayHeader5">
              <span class="day-full-date">Fri, Jan 9</span>
            </div>
            <div class="calendar-header-day" id="dayHeader6">
              <span class="day-full-date weekend">Sat, Jan 10</span>
            </div>
          </div>
          <!-- Calendar Body Grid -->
          <div class="calendar-grid" id="calendarGrid">
            <!-- Time slots will be generated by JavaScript -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const token = localStorage.getItem('auth_token');
    if (!token) {
      window.location.href = '/login';
    }

    // State
    // Check for date parameter in URL (e.g., /appointments?date=2024-11-04)
    const urlParams = new URLSearchParams(window.location.search);
    const dateParam = urlParams.get('date');
    let currentDate = dateParam ? new Date(dateParam + 'T12:00:00') : new Date();
    let currentView = 'week';
    let slotHeight = 120; // Taller slots like Momence for better visibility
    let appointments = [];
    let selectedAppointment = null;
    let isCheckedIn = false;
    let clients = [];

    // New appointment modal state
    let newAptServices = [];
    let newAptStaffList = [];
    let newAptVenues = [];
    let newAptCustomers = [];
    let isRecurring = false;
    let endsMode = 'on';
    let aptType = 'appointment';

    // Toggle functions (defined early for onclick handlers)
    function toggleRecurring() {
      isRecurring = !isRecurring;
      document.getElementById('recurringToggle').classList.toggle('active', isRecurring);
      document.getElementById('recurringLabel').textContent = isRecurring ? 'Yes' : 'No';
      document.getElementById('recurringOptions').classList.toggle('show', isRecurring);
    }

    function setEndsMode(mode) {
      endsMode = mode;
      document.getElementById('endsOnBtn').classList.toggle('active', mode === 'on');
      document.getElementById('endsAfterBtn').classList.toggle('active', mode === 'after');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      updateWeekDisplay();
      generateTimeSlots();
      await loadAppointments();
      scrollToBusinessHours();
    });

    // Scroll calendar to business hours (6 AM) or first appointment
    function scrollToBusinessHours() {
      const container = document.querySelector('.calendar-container');
      if (!container) return;

      // Find the earliest appointment hour, default to 6 AM
      let targetHour = 6;
      if (appointments && appointments.length > 0) {
        const earliestHour = Math.min(...appointments.map(apt => {
          const start = new Date(apt.start);
          return start.getHours();
        }));
        // Use earliest appointment hour if it's reasonable (between 5 AM and 10 AM)
        if (earliestHour >= 5 && earliestHour <= 10) {
          targetHour = earliestHour;
        } else if (earliestHour < 5) {
          targetHour = earliestHour; // Very early appointments, scroll there
        }
      }

      // Calculate scroll position: each hour slot is slotHeight pixels
      // Subtract 1 hour to show a bit of context above
      const scrollPosition = Math.max(0, (targetHour - 1)) * slotHeight;
      container.scrollTop = scrollPosition;
    }

    // Load appointments from API
    async function loadAppointments() {
      try {
        const startOfWeek = getStartOfWeek(currentDate);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(endOfWeek.getDate() + 6); // Saturday (6 days after Sunday)
        endOfWeek.setHours(23, 59, 59, 999); // End of Saturday

        const startDate = startOfWeek.toISOString().split('T')[0];
        // Use end of Saturday to include all Saturday appointments
        const endDate = endOfWeek.toISOString();

        const data = await apiRequest(`/api/appointments/calendar?start=${startDate}&end=${endDate}`);
        console.log('Appointments data from API:', data);
        if (data && data.length > 0) {
          console.log('First appointment extendedProps:', data[0].extendedProps);
          console.log('Payment statuses:', data.slice(0, 5).map(a => a.extendedProps?.paymentStatus));
        }

        // API returns array directly, not wrapped in { events: [...] }
        if (data && Array.isArray(data)) {
          appointments = data;
          renderAppointments();
        } else if (data && data.events) {
          appointments = data.events;
          renderAppointments();
        }
      } catch (error) {
        console.error('Failed to load appointments:', error);
      }
    }

    // Render appointments on the calendar grid
    function renderAppointments() {
      // Clear existing appointment blocks
      document.querySelectorAll('.appointment-block').forEach(el => el.remove());

      const startOfWeek = getStartOfWeek(currentDate);
      const grid = document.getElementById('calendarGrid');

      // Deduplicate appointments by ID (in case of data issues)
      const seenIds = new Set();
      const uniqueAppointments = appointments.filter(apt => {
        if (seenIds.has(apt.id)) return false;
        seenIds.add(apt.id);
        return true;
      });

      // Group appointments by day and calculate overlaps
      const appointmentsByDay = {};
      uniqueAppointments.forEach(apt => {
        const start = new Date(apt.start);
        const startLocal = new Date(start.getFullYear(), start.getMonth(), start.getDate());
        const weekStartLocal = new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate());
        const dayDiff = Math.round((startLocal - weekStartLocal) / (1000 * 60 * 60 * 24));
        if (dayDiff >= 0 && dayDiff <= 6) {
          if (!appointmentsByDay[dayDiff]) appointmentsByDay[dayDiff] = [];
          appointmentsByDay[dayDiff].push({
            ...apt,
            startTime: start,
            endTime: new Date(apt.end)
          });
        }
      });

      // For each day, calculate column positions for overlapping appointments
      // Cap at 3 columns max to keep appointments readable
      const MAX_COLUMNS = 3;

      Object.keys(appointmentsByDay).forEach(day => {
        const dayAppts = appointmentsByDay[day];
        // Sort by start time, then by end time
        dayAppts.sort((a, b) => a.startTime - b.startTime || a.endTime - b.endTime);

        // Reset column assignments
        dayAppts.forEach(apt => {
          apt.column = 0;
          apt.totalColumns = 1;
        });

        // Simple greedy algorithm: place each appointment in the leftmost column that doesn't overlap
        // Cap at MAX_COLUMNS - appointments beyond that will stack in the last column
        dayAppts.forEach(apt => {
          // Find all appointments that overlap with this one and have already been placed
          const overlapping = dayAppts.filter(other =>
            other !== apt &&
            other.column !== undefined &&
            apt.startTime < other.endTime &&
            apt.endTime > other.startTime
          );

          // Find the first available column (up to MAX_COLUMNS - 1)
          const usedColumns = new Set(overlapping.map(o => o.column));
          let col = 0;
          while (usedColumns.has(col) && col < MAX_COLUMNS - 1) col++;
          // If all columns are taken, use the last column (they'll stack)
          apt.column = Math.min(col, MAX_COLUMNS - 1);
        });

        // Calculate totalColumns for each appointment based on direct overlaps only
        dayAppts.forEach(apt => {
          // Find all appointments that directly overlap with this one
          const directOverlaps = dayAppts.filter(other =>
            other !== apt &&
            apt.startTime < other.endTime &&
            apt.endTime > other.startTime
          );

          if (directOverlaps.length === 0) {
            apt.totalColumns = 1;
          } else {
            // totalColumns = max column used by any overlapping appointment + 1, capped at MAX_COLUMNS
            const maxCol = Math.min(
              Math.max(apt.column, ...directOverlaps.map(o => o.column)),
              MAX_COLUMNS - 1
            );
            apt.totalColumns = maxCol + 1;
            // Also update the overlapping appointments to have the same totalColumns
            directOverlaps.forEach(o => {
              o.totalColumns = Math.max(o.totalColumns, maxCol + 1);
            });
          }
        });
      });

      // Flatten appointmentsByDay to render with column info
      Object.keys(appointmentsByDay).forEach(day => {
        const dayAppts = appointmentsByDay[day];
        dayAppts.forEach(apt => {
          const start = apt.startTime;
          const end = apt.endTime;
          const dayDiff = parseInt(day);

          // Calculate position within the day
          const startHour = start.getHours();
          const startMinutes = start.getMinutes();

          // Calculate duration in hours
          const durationHours = (end - start) / (1000 * 60 * 60);

          // Find the time slot for this hour and day
          const timeSlots = grid.querySelectorAll('.time-slot');
          const slotIndex = startHour * 7 + dayDiff;
          const targetSlot = timeSlots[slotIndex];

          // Get column positioning info
          const column = apt.column || 0;
          const totalColumns = apt.totalColumns || 1;

        if (!targetSlot) return;

        // Determine payment/status for color coding
        // Treat NULL/missing payment_status as unpaid (red) - this ensures imported appointments show correctly
        const paymentStatus = apt.extendedProps?.paymentStatus;
        const isPaid = paymentStatus === 'paid' || apt.extendedProps?.status === 'completed';
        // Unpaid = explicitly unpaid OR no payment status (NULL)
        const isUnpaid = paymentStatus === 'unpaid' || paymentStatus === 'pending' || (!paymentStatus && !isPaid);

        // Debug first few appointments
        if (appointments.indexOf(apt) < 3) {
          console.log(`Appointment ${apt.id}: paymentStatus="${paymentStatus}", isPaid=${isPaid}, status="${apt.extendedProps?.status}"`);
        }
        const status = apt.extendedProps?.status || 'confirmed';
        // Check if this is a time block
        const isTimeBlock = apt.extendedProps?.isTimeBlock === true;

        // Momence-style: Color based on payment status (or gray for time blocks)
        // Green = paid, Red = unpaid/unknown, Gray = time block
        let bgColor, textColor, indicatorColor;
        if (isTimeBlock) {
          // GRAY background for time blocks
          bgColor = '#6b7280';
          textColor = '#ffffff';
          indicatorColor = '#6b7280';
        } else if (isPaid) {
          // GREEN background for paid
          bgColor = '#4ade80';
          textColor = '#166534';
          indicatorColor = '#22c55e';
        } else {
          // RED background for unpaid/unknown - like Momence
          bgColor = '#ef4444';
          textColor = '#ffffff';
          indicatorColor = '#ef4444';
        }

        // Create appointment block
        const block = document.createElement('div');
        let blockClass = 'appointment-block';
        if (isTimeBlock) {
          blockClass += ' time-block';
        } else {
          blockClass += isPaid ? ' paid' : ' unpaid';
        }
        block.className = blockClass;
        // Calculate column-based positioning for overlapping appointments
        const columnWidth = (100 / totalColumns);
        const leftPercent = column * columnWidth;
        const widthPercent = columnWidth;

        block.style.cssText = `
          position: absolute;
          top: ${(startMinutes / 60) * slotHeight}px;
          left: calc(${leftPercent}% + 2px);
          width: calc(${widthPercent}% - 4px);
          height: ${Math.max(durationHours * slotHeight - 4, 24)}px;
          background: ${bgColor};
          border-radius: 4px;
          padding: 4px 6px 4px 8px;
          font-size: 0.75rem;
          overflow: visible;
          cursor: pointer;
          z-index: 100;
          box-sizing: border-box;
          display: flex;
          gap: 6px;
        `;

        // Format times
        const timeStr = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const endTimeStr = end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const timeRange = `${timeStr} - ${endTimeStr}`;

        // Get details from extendedProps
        const clientName = apt.extendedProps?.clientName || 'No client';
        const clientEmail = apt.extendedProps?.clientEmail || '';
        const serviceName = apt.extendedProps?.serviceName || apt.title || 'Appointment';
        const staffName = apt.extendedProps?.staffName || '';
        const locationType = apt.extendedProps?.locationType || 'in_person';
        const priceVal = apt.extendedProps?.price;
        const price = (priceVal !== null && priceVal !== undefined && !isNaN(Number(priceVal))) ? Number(priceVal) : 0;

        // Payment status text and class
        const paymentStatusText = isPaid ? 'Paid' : 'Not paid';
        const statusClass = isPaid ? 'paid' : 'unpaid';

        block.innerHTML = `
          <!-- Payment status indicator square -->
          <div style="width: 10px; height: 10px; min-width: 10px; background: ${isPaid ? indicatorColor : '#ffffff'}; border-radius: 2px; margin-top: 2px;"></div>
          <!-- Appointment content -->
          <div style="flex: 1; min-width: 0; overflow: hidden;">
            <div style="font-weight: 600; color: ${textColor}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${serviceName}</div>
            <div style="color: ${textColor}; font-size: 0.6875rem; opacity: 0.9;">${clientName}</div>
            <div style="color: ${textColor}; font-size: 0.6875rem; opacity: 0.8;">${timeStr}</div>
          </div>

          <!-- Hover Tooltip - Momence style -->
          <div class="apt-tooltip">
            <div class="apt-tooltip-header">
              <div class="apt-tooltip-status-dot ${statusClass}"></div>
              <span class="apt-tooltip-status-text">${paymentStatusText}</span>
            </div>

            <div class="apt-tooltip-body">
              <div class="apt-tooltip-service">${serviceName}</div>

              <div class="apt-tooltip-client">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                <span class="apt-tooltip-client-name">${clientName}</span>
              </div>
              ${clientEmail ? `<div class="apt-tooltip-client-email">${clientEmail}</div>` : ''}

              <div class="apt-tooltip-divider"></div>

              <div class="apt-tooltip-details">
                <div class="apt-tooltip-detail">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                  <span class="apt-tooltip-detail-value">${timeRange}</span>
                </div>

                ${staffName ? `
                <div class="apt-tooltip-detail">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                  <span class="apt-tooltip-detail-value">${staffName}</span>
                </div>
                ` : ''}

                <div class="apt-tooltip-detail">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  <span class="apt-tooltip-detail-value">${locationType === 'in_person' ? 'In Person' : locationType === 'virtual' ? 'Virtual' : locationType}</span>
                </div>

                ${price > 0 ? `
                <div class="apt-tooltip-detail">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                  <span class="apt-tooltip-detail-value">$${price.toFixed(0)}</span>
                </div>
                ` : ''}
              </div>
            </div>
          </div>
        `;

        block.addEventListener('click', (e) => {
          e.stopPropagation();
          e.preventDefault();
          console.log('Appointment clicked:', apt);
          try {
            openAppointmentPanel(apt);
          } catch (err) {
            console.error('Error opening appointment panel:', err);
            alert('Error opening appointment details: ' + err.message);
          }
        });

        // Position relative to the slot
        targetSlot.style.position = 'relative';
        targetSlot.appendChild(block);
        });
      });
    }

    // API helper
    async function apiRequest(url, options = {}) {
      const response = await fetch(url, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers
        }
      });

      if (response.status === 401) {
        window.location.href = '/login';
        return;
      }

      return response.json();
    }

    function updateWeekDisplay() {
      const weekNum = getWeekNumber(currentDate);
      const year = currentDate.getFullYear();
      document.getElementById('weekDisplay').textContent = `Week ${weekNum}, ${year}`;

      // Update day headers with format "Sun, Jan 4"
      const startOfWeek = getStartOfWeek(currentDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(date.getDate() + i);

        const dayHeader = document.getElementById(`dayHeader${i}`);
        if (!dayHeader) continue;

        const dayName = dayNames[date.getDay()];
        const monthName = monthNames[date.getMonth()];
        const dayNum = date.getDate();

        const dateStr = `${dayName}, ${monthName} ${dayNum}`;

        // Build class string
        let classes = 'day-full-date';
        if (date.getTime() === today.getTime()) {
          classes += ' today';
        }
        if (i === 0 || i === 6) {
          classes += ' weekend';
        }

        dayHeader.innerHTML = `<span class="${classes}">${dateStr}</span>`;
      }
    }

    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function getStartOfWeek(date) {
      const d = new Date(date);
      const day = d.getDay();
      d.setDate(d.getDate() - day);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function generateTimeSlots() {
      const grid = document.getElementById('calendarGrid');

      // Clear existing time slots (headers are now in separate row)
      grid.innerHTML = '';

      // Generate time slots from 12 AM to 11 PM
      for (let hour = 0; hour < 24; hour++) {
        // Time label
        const timeLabel = document.createElement('div');
        timeLabel.className = 'time-slot-label';
        timeLabel.textContent = formatHour(hour);
        grid.appendChild(timeLabel);

        // Day slots
        for (let day = 0; day < 7; day++) {
          const slot = document.createElement('div');
          slot.className = 'time-slot';
          if (day === 0 || day === 6) {
            slot.classList.add('weekend');
          }
          slot.style.height = `${slotHeight}px`;
          slot.dataset.hour = hour;
          slot.dataset.day = day;
          slot.onclick = (e) => {
            // Don't trigger if clicking on an appointment block
            if (e.target.closest('.appointment-block')) return;
            handleSlotClick(day, hour);
          };
          grid.appendChild(slot);
        }
      }
    }

    function formatHour(hour) {
      if (hour === 0) return '12 AM';
      if (hour === 12) return '12 PM';
      if (hour < 12) return `${hour} AM`;
      return `${hour - 12} PM`;
    }

    function handleSlotClick(day, hour) {
      console.log('Slot clicked:', { day, hour });
      const startOfWeek = getStartOfWeek(currentDate);
      const date = new Date(startOfWeek);
      date.setDate(date.getDate() + day);
      date.setHours(hour, 0, 0, 0);
      console.log('Opening modal for date:', date);
      openNewAptModal(date);
    }

    // Navigation
    async function prevWeek() {
      currentDate.setDate(currentDate.getDate() - 7);
      updateWeekDisplay();
      await loadAppointments();
      scrollToBusinessHours();
    }

    async function nextWeek() {
      currentDate.setDate(currentDate.getDate() + 7);
      updateWeekDisplay();
      await loadAppointments();
      scrollToBusinessHours();
    }

    function setView(view) {
      currentView = view;
      document.querySelectorAll('.view-toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      // Regenerate calendar for day view
    }

    // Zoom
    function zoomIn() {
      slotHeight = Math.min(slotHeight + 20, 180);
      document.querySelectorAll('.time-slot').forEach(slot => {
        slot.style.height = `${slotHeight}px`;
      });
      renderAppointments(); // Re-render with new slot height
    }

    function zoomOut() {
      slotHeight = Math.max(slotHeight - 20, 60);
      document.querySelectorAll('.time-slot').forEach(slot => {
        slot.style.height = `${slotHeight}px`;
      });
      renderAppointments(); // Re-render with new slot height
    }

    // Dropdowns
    function toggleDropdown(id) {
      const menu = document.getElementById(id);
      const wasOpen = menu.classList.contains('show');

      // Close all dropdowns first
      document.querySelectorAll('.filter-dropdown-menu, .dropdown-menu').forEach(m => {
        m.classList.remove('show');
      });

      if (!wasOpen) {
        menu.classList.add('show');
      }
    }

    function toggleActionsMenu() {
      toggleDropdown('actionsMenu');
    }

    // Checkout menu
    function toggleCheckoutMenu() {
      const menu = document.getElementById('checkoutMenu');
      const wasOpen = menu.classList.contains('show');

      // Close all dropdowns first
      document.querySelectorAll('.filter-dropdown-menu, .dropdown-menu, .user-dropdown-menu, .checkout-dropdown-menu').forEach(m => {
        m.classList.remove('show');
      });

      if (!wasOpen) {
        menu.classList.add('show');
      }
    }

    // User menu
    function toggleUserMenu() {
      const menu = document.getElementById('userDropdownMenu');
      const wasOpen = menu.classList.contains('show');

      // Close all dropdowns first
      document.querySelectorAll('.filter-dropdown-menu, .dropdown-menu, .user-dropdown-menu').forEach(m => {
        m.classList.remove('show');
      });

      if (!wasOpen) {
        menu.classList.add('show');
      }
    }

    function signOut() {
      localStorage.removeItem('auth_token');
      window.location.href = '/login';
    }

    function selectLocation(name) {
      document.getElementById('selectedLocation').textContent = name;
      document.getElementById('locationDropdown').classList.remove('show');
    }

    function selectVenue(name) {
      document.getElementById('selectedVenue').textContent = name;
      // Update selection state
      document.querySelectorAll('#venueDropdown .filter-dropdown-item').forEach(item => {
        item.classList.toggle('selected', item.textContent === name);
      });
      document.getElementById('venueDropdown').classList.remove('show');
      // Filter appointments by venue
    }

    function selectStaff(name) {
      document.getElementById('selectedStaff').textContent = name;
      // Update selection state
      document.querySelectorAll('#staffDropdown .filter-dropdown-item').forEach(item => {
        item.classList.toggle('selected', item.textContent === name);
      });
      document.getElementById('staffDropdown').classList.remove('show');
      // Filter appointments by staff
    }

    // Staff/Venues mode toggle
    let currentMode = 'staff';
    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.staff-venues-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      // Show/hide appropriate dropdown
      document.getElementById('staffDropdownContainer').style.display = mode === 'staff' ? 'block' : 'none';
      document.getElementById('venueDropdownContainer').style.display = mode === 'venues' ? 'block' : 'none';
    }

    // Actions
    function editBoard() {
      window.location.href = '/boards/edit';
    }

    function openAppointmentSettings() {
      window.location.href = '/settings/appointments';
    }

    // Search functionality
    function openSearch() {
      // TODO: Open search modal or focus search input
      console.log('Open search...');
    }

    // Keyboard shortcut for search
    document.addEventListener('keydown', (e) => {
      if (e.key === 's' && !e.ctrlKey && !e.metaKey && !e.altKey &&
          !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
        e.preventDefault();
        openSearch();
      }
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.filter-dropdown') && !e.target.closest('.toolbar-btn') && !e.target.closest('.utility-user-dropdown') && !e.target.closest('.checkout-dropdown')) {
        document.querySelectorAll('.filter-dropdown-menu, .dropdown-menu, .user-dropdown-menu, .checkout-dropdown-menu').forEach(m => {
          m.classList.remove('show');
        });
      }
    });

    // Clock in/out functionality
    let isClockedIn = localStorage.getItem('clock_status') === 'in';

    function updateClockStatus() {
      const toast = document.getElementById('clockStatusToast');
      if (!toast) return; // Exit if toast element not found
      const icon = toast.querySelector('.clock-status-icon');
      const text = toast.querySelector('.clock-status-text');
      const menuItem = document.getElementById('clockMenuItem');

      if (isClockedIn) {
        toast.classList.remove('clocked-out');
        toast.classList.add('clocked-in');
        icon.classList.remove('clocked-out');
        icon.classList.add('clocked-in');
        icon.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>`;
        text.textContent = 'Clocked in!';
        if (menuItem) menuItem.textContent = 'Clock out';
      } else {
        toast.classList.remove('clocked-in');
        toast.classList.add('clocked-out');
        icon.classList.remove('clocked-in');
        icon.classList.add('clocked-out');
        icon.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>`;
        text.textContent = 'Clocked out!';
        if (menuItem) menuItem.textContent = 'Clock in';
      }
      toast.classList.remove('hidden');
    }

    function toggleClockStatus() {
      isClockedIn = !isClockedIn;
      localStorage.setItem('clock_status', isClockedIn ? 'in' : 'out');
      updateClockStatus();
    }

    function hideClockToast() {
      document.getElementById('clockStatusToast').classList.add('hidden');
    }

    // Initialize clock status on load
    updateClockStatus();

    // =====================
    // Appointment Detail Panel
    // =====================

    function openAppointmentPanel(apt) {
      console.log('openAppointmentPanel called with:', apt);
      selectedAppointment = apt;
      isCheckedIn = apt.extendedProps?.status === 'in_progress';

      // Check if panel elements exist
      const overlay = document.getElementById('appointmentPanelOverlay');
      const panel = document.getElementById('appointmentPanel');
      console.log('Panel elements:', { overlay: !!overlay, panel: !!panel });

      // Update panel content
      document.getElementById('panelTitle').textContent = apt.title || 'Appointment reservation';
      document.getElementById('panelId').textContent = `ID: ${apt.id}`;

      // Payment Status badge (Paid / Not paid)
      // Treat NULL/missing payment_status as unpaid
      const statusBadge = document.getElementById('panelStatusBadge');
      const paymentStatus = apt.extendedProps?.paymentStatus;
      const isPaid = paymentStatus === 'paid';

      if (isPaid) {
        statusBadge.textContent = 'Paid';
        statusBadge.className = 'panel-status-badge paid';
      } else {
        // Not paid or unknown - show as Not paid
        statusBadge.textContent = 'Not paid';
        statusBadge.className = 'panel-status-badge unpaid';
      }

      // Date/time
      const start = new Date(apt.start);
      const end = new Date(apt.end);
      const dateStr = start.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
      const startTime = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      const endTime = end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      const durationMins = Math.round((end - start) / (1000 * 60));

      document.getElementById('panelDateTime').textContent = `${dateStr} ${startTime} - ${endTime}`;
      document.getElementById('panelDuration').textContent = `takes ${durationMins} minutes`;

      // Practitioner
      const staffName = apt.extendedProps?.staffName || 'Not assigned';
      const staffId = apt.extendedProps?.staffId;
      const staffLink = document.getElementById('panelStaffName');
      staffLink.textContent = staffName;
      if (staffId) {
        staffLink.href = `/practitioner-detail?id=${staffId}`;
        staffLink.onclick = null;
      } else {
        staffLink.href = '#';
        staffLink.onclick = (e) => e.preventDefault();
      }

      // Location
      const locationType = apt.extendedProps?.locationType || 'in_person';
      document.getElementById('panelLocation').textContent = locationType === 'in_person' ? 'Event Space' : 'Virtual';

      // Client / Signups section
      const clientName = apt.extendedProps?.clientName;
      const clientEmail = apt.extendedProps?.clientEmail || '';
      const clientPhone = apt.extendedProps?.clientPhone || '';
      const signupCard = document.getElementById('panelSignupCard');
      if (clientName) {
        signupCard.style.display = 'flex';
        document.getElementById('panelClientName').textContent = clientName;
        document.getElementById('panelClientEmail').textContent = clientEmail;
        document.getElementById('panelClientPhone').textContent = clientPhone;
      } else {
        signupCard.style.display = 'flex';
        document.getElementById('panelClientName').textContent = 'No client assigned';
        document.getElementById('panelClientEmail').textContent = '';
        document.getElementById('panelClientPhone').textContent = '';
      }

      // Payment tags
      const paymentTagsEl = document.getElementById('panelPaymentTags');
      const priceRaw = apt.extendedProps?.price;
      const price = (priceRaw !== null && priceRaw !== undefined && !isNaN(Number(priceRaw))) ? Number(priceRaw) : 0;
      const creditsRaw = apt.extendedProps?.credits;
      const credits = (creditsRaw !== null && creditsRaw !== undefined && !isNaN(Number(creditsRaw))) ? Number(creditsRaw) : 0;
      let tagsHtml = '';

      if (price > 0) {
        tagsHtml += `<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: #F3F4F6; border-radius: 4px; font-size: 0.75rem; color: #374151;">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
          ZAR ${price.toFixed(0)}
        </span>`;
      }

      tagsHtml += `<span style="display: inline-flex; align-items: center; padding: 4px 8px; background: ${isPaid ? '#DEF7EC' : '#FEE2E2'}; border-radius: 4px; font-size: 0.75rem; color: ${isPaid ? '#03543F' : '#991B1B'}; font-weight: 500;">
        ${isPaid ? 'Paid' : 'Not paid'}
      </span>`;

      if (credits > 0) {
        tagsHtml += `<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: #EDE9FE; border-radius: 4px; font-size: 0.75rem; color: #5B21B6;">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg>
          ${credits} credits
        </span>`;
      }

      paymentTagsEl.innerHTML = tagsHtml;

      // Update check-in toggle and timestamp
      const toggle = document.getElementById('panelCheckinToggle');
      const checkinTime = document.getElementById('panelCheckinTime');
      toggle.classList.toggle('active', isCheckedIn);

      if (isCheckedIn && apt.extendedProps?.checkedInAt) {
        const checkinDate = new Date(apt.extendedProps.checkedInAt);
        const dateStr = checkinDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        const timeStr = checkinDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        checkinTime.textContent = `${dateStr}, ${timeStr}`;
        checkinTime.classList.add('show');
      } else if (isCheckedIn) {
        // Fallback if no timestamp but status says checked in
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        checkinTime.textContent = `${dateStr}, ${timeStr}`;
        checkinTime.classList.add('show');
      } else {
        checkinTime.textContent = '';
        checkinTime.classList.remove('show');
      }

      // Service name (clickable link to service detail)
      const serviceNameEl = document.getElementById('panelServiceName');
      serviceNameEl.textContent = apt.title || 'Service';
      const serviceId = apt.extendedProps?.serviceId;
      if (serviceId) {
        serviceNameEl.href = `/service-detail?id=${serviceId}`;
      } else {
        serviceNameEl.href = '#';
        serviceNameEl.onclick = (e) => e.preventDefault();
      }

      // Price (reuse price variable from payment tags)
      const priceEl = document.getElementById('panelPrice');
      priceEl.innerHTML = `ZAR ${price.toFixed(0)} <span class="panel-price-credits">or ${credits} credits</span>`;

      // Populate Timing tab - Reservation Preview
      const bufferBefore = apt.extendedProps?.bufferBefore || 0;
      const bufferAfter = apt.extendedProps?.bufferAfter || 0;
      const locationName = apt.extendedProps?.locationDetails || apt.extendedProps?.locationType || 'Event Space';

      // Duration value
      document.getElementById('panelDurationValue').textContent = `${durationMins}m`;

      // Buffer labels
      document.getElementById('panelBufferStart').textContent = bufferBefore > 0 ? `${bufferBefore}m buffer` : 'Add Buffer time 10m';
      document.getElementById('panelBufferEnd').textContent = bufferAfter > 0 ? `${bufferAfter}m buffer` : 'Add Buffer time 10m';

      // Appointment block details
      document.getElementById('panelBlockServiceName').textContent = apt.title || 'Service';
      document.getElementById('panelBlockCustomer').textContent = ` ${clientName}`;
      document.getElementById('panelBlockLocation').textContent = ` ${locationName}`;
      document.getElementById('panelBlockStaff').textContent = ` ${staffName || 'Staff'}`;
      document.getElementById('panelBlockTime').textContent = ` ${startTime}-${endTime}`;

      // Time markers (with buffer)
      const bufferStartTime = new Date(start.getTime() - bufferBefore * 60000);
      const bufferEndTime = new Date(end.getTime() + bufferAfter * 60000);
      document.getElementById('panelTimeStart').textContent = bufferStartTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      document.getElementById('panelTimeEnd').textContent = bufferEndTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

      // Created at date
      const createdAt = apt.extendedProps?.createdAt;
      if (createdAt) {
        const createdDate = new Date(createdAt);
        document.getElementById('panelCreatedAt').textContent = createdDate.toLocaleDateString('en-US', {
          weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit'
        });
      } else {
        document.getElementById('panelCreatedAt').textContent = 'Not available';
      }

      // Populate Note tab
      const notes = apt.extendedProps?.notes || apt.notes || '';
      document.getElementById('panelNoteText').value = notes;

      // Reset to Details tab when opening
      showPanelTab('details');

      // Show panel
      document.getElementById('appointmentPanelOverlay').classList.add('show');
      document.getElementById('appointmentPanel').classList.add('show');
    }

    function closeAppointmentPanel() {
      document.getElementById('appointmentPanelOverlay').classList.remove('show');
      document.getElementById('appointmentPanel').classList.remove('show');
      selectedAppointment = null;
    }

    async function cancelAppointment() {
      if (!selectedAppointment) return;

      const apt = selectedAppointment;
      const confirmCancel = confirm(`Are you sure you want to cancel this appointment?\n\n${apt.title || 'Appointment'}\n${apt.client_name || ''}`);

      if (!confirmCancel) return;

      try {
        const response = await fetch(`/api/appointments/${apt.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            status: 'cancelled'
          })
        });

        if (response.ok) {
          closeAppointmentPanel();
          loadAppointments();
        } else {
          const error = await response.json();
          alert('Error cancelling appointment: ' + (error.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error cancelling appointment:', error);
        alert('Error cancelling appointment. Please try again.');
      }
    }

    function navigateToSchedule() {
      // Navigate to the appointments schedule page
      // The current page IS the schedule, so we just close the panel
      // and scroll to the calendar view if needed
      closeAppointmentPanel();

      // Scroll to top where the calendar is
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function addToCalendar() {
      if (!selectedAppointment) return;

      const apt = selectedAppointment;

      // Get start and end times - handle both formats (apt.start or apt.start_time)
      const startDate = new Date(apt.start || apt.start_time);
      const endDate = new Date(apt.end || apt.end_time);

      // Format dates for Google Calendar (YYYYMMDDTHHmmss format - local time)
      // Using local time format so Google Calendar doesn't ask about timezone conversion
      const formatDateLocal = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${year}${month}${day}T${hours}${minutes}${seconds}`;
      };

      const startStr = formatDateLocal(startDate);
      const endStr = formatDateLocal(endDate);

      // Build event title - include service name
      const serviceName = apt.extendedProps?.serviceName || apt.title || 'Appointment';
      const title = `${serviceName}`;

      // Build description with all relevant details
      let description = '';

      // Service info
      description += `Service: ${serviceName}\n`;

      // Client info
      const clientName = apt.extendedProps?.clientName || apt.client_name;
      if (clientName) {
        description += `Client: ${clientName}\n`;
      }

      const clientEmail = apt.extendedProps?.clientEmail;
      if (clientEmail) {
        description += `Email: ${clientEmail}\n`;
      }

      // Staff/Practitioner info
      const staffName = apt.extendedProps?.staffName || apt.staff_name;
      if (staffName) {
        description += `Practitioner: ${staffName}\n`;
      }

      // Price info
      const price = apt.extendedProps?.price;
      if (price && price > 0) {
        description += `Price: ZAR ${parseFloat(price).toFixed(0)}\n`;
      }

      // Payment status
      const paymentStatus = apt.extendedProps?.paymentStatus;
      if (paymentStatus) {
        description += `Payment: ${paymentStatus === 'paid' ? 'Paid' : 'Not paid'}\n`;
      }

      // Notes
      const notes = apt.extendedProps?.notes || apt.notes;
      if (notes) {
        description += `\nNotes: ${notes}`;
      }

      // Add link back to appointment
      description += `\n\n---\nManage this appointment:\n${window.location.origin}/appointments`;

      // Location - use location details or default to business name
      const locationDetails = apt.extendedProps?.locationDetails || apt.extendedProps?.locationType;
      const location = locationDetails || 'Expand Health (Pty) Ltd';

      // Build Google Calendar URL
      const googleCalUrl = new URL('https://calendar.google.com/calendar/render');
      googleCalUrl.searchParams.set('action', 'TEMPLATE');
      googleCalUrl.searchParams.set('text', title);
      googleCalUrl.searchParams.set('dates', `${startStr}/${endStr}`);
      googleCalUrl.searchParams.set('details', description);
      googleCalUrl.searchParams.set('location', location);
      // Set timezone to South Africa
      googleCalUrl.searchParams.set('ctz', 'Africa/Johannesburg');

      // Open in new tab
      window.open(googleCalUrl.toString(), '_blank');
    }

    function copyPaymentLink(e) {
      if (!selectedAppointment) return;

      const apt = selectedAppointment;
      // Generate a payment link based on appointment ID
      const paymentLink = `${window.location.origin}/appointment-checkout?id=${apt.id}`;

      // Try modern clipboard API first, fallback to execCommand
      const copyToClipboard = async (text) => {
        // Try navigator.clipboard first (requires HTTPS)
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return true;
        }

        // Fallback for HTTP or older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        textArea.style.top = '-9999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          document.execCommand('copy');
          return true;
        } finally {
          document.body.removeChild(textArea);
        }
      };

      copyToClipboard(paymentLink).then(() => {
        // Show a brief success message
        const btn = e ? e.target.closest('button') : document.querySelector('.panel-copy-link-btn');
        if (btn) {
          const originalText = btn.innerHTML;
          btn.innerHTML = `
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Copied!
          `;
          setTimeout(() => {
            btn.innerHTML = originalText;
          }, 2000);
        }
      }).catch(err => {
        console.error('Failed to copy payment link:', err);
        // Show the link in a prompt as fallback
        prompt('Copy this payment link:', paymentLink);
      });
    }

    async function sendPaymentLink() {
      if (!selectedAppointment) return;

      const apt = selectedAppointment;
      const clientEmail = apt.extendedProps?.clientEmail;
      const clientName = apt.extendedProps?.clientName;

      if (!clientEmail) {
        alert('No email address available for this client');
        return;
      }

      try {
        const response = await apiRequest(`/api/appointments/${apt.id}/send-payment-link`, {
          method: 'POST'
        });

        if (response) {
          alert(`Payment link sent to ${clientName} (${clientEmail})`);
        }
      } catch (error) {
        console.error('Failed to send payment link:', error);
        alert('Failed to send payment link. Please try again.');
      }
    }

    function showPanelTab(tab) {
      document.querySelectorAll('.panel-tab').forEach((t, i) => {
        t.classList.toggle('active', (tab === 'details' && i === 0) || (tab === 'timing' && i === 1) || (tab === 'note' && i === 2));
      });

      // Show/hide content sections
      const detailsContent = document.getElementById('panelDetailsContent');
      const timingContent = document.getElementById('panelTimingContent');
      const noteContent = document.getElementById('panelNoteContent');

      if (detailsContent) detailsContent.style.display = tab === 'details' ? 'block' : 'none';
      if (timingContent) timingContent.style.display = tab === 'timing' ? 'block' : 'none';
      if (noteContent) noteContent.style.display = tab === 'note' ? 'block' : 'none';
    }

    async function saveAppointmentNote() {
      if (!selectedAppointment) return;

      const noteText = document.getElementById('panelNoteText').value;
      const aptId = selectedAppointment.id;

      try {
        const response = await fetch(`/api/appointments/${aptId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            notes: noteText
          })
        });

        if (response.ok) {
          // Update the selected appointment's notes
          if (selectedAppointment.extendedProps) {
            selectedAppointment.extendedProps.notes = noteText;
          } else {
            selectedAppointment.notes = noteText;
          }
          alert('Note saved successfully!');
          loadAppointments(); // Refresh calendar
        } else {
          const error = await response.json();
          alert('Error saving note: ' + (error.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error saving appointment note:', error);
        alert('Error saving note. Please try again.');
      }
    }

    // =====================
    // Edit Appointment Modal
    // =====================

    async function openEditAppointmentModal() {
      if (!selectedAppointment) return;

      const apt = selectedAppointment;

      // Populate the form with current appointment data
      document.getElementById('editAptBoard').textContent = 'Expand Health';

      // Set starts at datetime
      if (apt.start_time) {
        const startDate = new Date(apt.start_time);
        const localDateTime = new Date(startDate.getTime() - startDate.getTimezoneOffset() * 60000)
          .toISOString()
          .slice(0, 16);
        document.getElementById('editAptStartsAt').value = localDateTime;
      }

      // Load and populate services dropdown
      await loadServicesForEdit();
      if (apt.service_id) {
        document.getElementById('editAptService').value = apt.service_id;
      }

      // Load and populate staff dropdown
      await loadStaffForEdit();
      if (apt.staff_id) {
        document.getElementById('editAptStaff').value = apt.staff_id;
      }

      // Set duration (calculate from start/end time or use default)
      if (apt.start_time && apt.end_time) {
        const start = new Date(apt.start_time);
        const end = new Date(apt.end_time);
        const durationMinutes = Math.round((end - start) / (1000 * 60));
        document.getElementById('editAptDuration').value = durationMinutes;
      } else {
        document.getElementById('editAptDuration').value = 45;
      }

      // Set buffers (default values)
      document.getElementById('editAptBufferStart').value = 5;
      document.getElementById('editAptBufferEnd').value = 5;

      // Set price
      if (apt.price) {
        document.getElementById('editAptPrice').value = apt.price;
      } else {
        document.getElementById('editAptPrice').value = 0;
      }

      // Set notes
      document.getElementById('editAptNotes').value = apt.notes || '';

      // Show modal
      document.getElementById('editAptModalOverlay').classList.add('show');
      document.getElementById('editAptModal').classList.add('show');
    }

    function closeEditAppointmentModal() {
      document.getElementById('editAptModalOverlay').classList.remove('show');
      document.getElementById('editAptModal').classList.remove('show');
    }

    async function loadServicesForEdit() {
      try {
        const response = await fetch('/api/services', {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const services = await response.json();
          const select = document.getElementById('editAptService');
          select.innerHTML = '<option value="">Select service...</option>';

          services.forEach(service => {
            const option = document.createElement('option');
            option.value = service.id;
            option.textContent = service.name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading services:', error);
      }
    }

    async function loadStaffForEdit() {
      try {
        const response = await fetch('/api/staff', {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const staff = await response.json();
          const select = document.getElementById('editAptStaff');
          select.innerHTML = '<option value="">Select staff...</option>';

          (staff.staff || staff).forEach(member => {
            const option = document.createElement('option');
            option.value = member.id;
            option.textContent = `${member.first_name} ${member.last_name}`;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading staff:', error);
      }
    }

    async function saveAppointmentChanges() {
      if (!selectedAppointment) return;

      const apt = selectedAppointment;

      // Gather form data
      const startDateTime = document.getElementById('editAptStartsAt').value;
      const serviceId = document.getElementById('editAptService').value;
      const staffId = document.getElementById('editAptStaff').value;
      const duration = parseInt(document.getElementById('editAptDuration').value) || 45;
      const price = parseFloat(document.getElementById('editAptPrice').value) || 0;
      const notes = document.getElementById('editAptNotes').value;

      // Calculate end time based on duration
      const startDate = new Date(startDateTime);
      const endDate = new Date(startDate.getTime() + duration * 60 * 1000);

      try {
        const response = await fetch(`/api/appointments/${apt.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            start_time: startDate.toISOString(),
            end_time: endDate.toISOString(),
            service_id: serviceId || null,
            staff_id: staffId || null,
            price: price,
            notes: notes
          })
        });

        if (response.ok) {
          closeEditAppointmentModal();
          closeAppointmentPanel();
          // Refresh the calendar view
          loadAppointments();
        } else {
          const error = await response.json();
          alert('Error saving changes: ' + (error.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error saving appointment:', error);
        alert('Error saving changes. Please try again.');
      }
    }

    // =====================
    // Add Customer Modal
    // =====================

    async function loadClients() {
      try {
        console.log('Loading clients... Token:', token ? 'present' : 'missing');
        // Load all clients (high limit for client-side search/filtering)
        const response = await fetch('/api/clients?limit=10000', {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        console.log('Clients response status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Clients API error:', response.status, errorText);
          clients = []; // Reset to empty on error
          return;
        }

        const data = await response.json();
        console.log('Clients API response:', JSON.stringify(data).substring(0, 500));

        if (data && Array.isArray(data.clients)) {
          clients = data.clients;
          console.log('Loaded', clients.length, 'clients. First client:', clients[0] ? JSON.stringify(clients[0]) : 'none');
        } else {
          console.log('No clients array in response, data keys:', Object.keys(data || {}));
          clients = [];
        }
      } catch (error) {
        console.error('Failed to load clients:', error);
        clients = []; // Reset to empty on error
      }
    }

    // =====================
    // Customer Dropdown Functions
    // =====================
    let selectedCustomerId = null;

    async function openAddCustomerModal() {
      if (!selectedAppointment) {
        console.log('No selected appointment');
        return;
      }

      // Reset state
      selectedCustomerId = null;
      document.getElementById('customerSelect').value = '';
      document.getElementById('addCustSearchInput').value = '';
      document.getElementById('addCustDropdownSelected').innerHTML = '<span class="dropdown-placeholder">Select customer...</span>';
      closeAddCustDropdown();

      // Always reload clients to get fresh data
      await loadClients();

      // Populate the customer list
      populateAddCustList();

      // Show modal
      document.getElementById('addCustomerModalOverlay').classList.add('show');
      document.getElementById('addCustomerModal').classList.add('show');
    }

    function closeAddCustomerModal() {
      document.getElementById('addCustomerModalOverlay').classList.remove('show');
      document.getElementById('addCustomerModal').classList.remove('show');
      closeAddCustDropdown();
    }

    async function assignCustomer() {
      if (!selectedAppointment) return;

      const clientId = document.getElementById('customerSelect').value;

      if (!clientId) {
        alert('Please select a customer');
        return;
      }

      try {
        const response = await apiRequest(`/api/appointments/${selectedAppointment.id}`, {
          method: 'PUT',
          body: JSON.stringify({ client_id: parseInt(clientId) })
        });

        if (response) {
          // Find the client name
          const client = clients.find(c => c.id === parseInt(clientId));
          const clientName = client ? `${client.first_name} ${client.last_name}` : 'Client assigned';

          // Update the panel
          document.getElementById('panelClientName').textContent = clientName;
          document.getElementById('panelSignupCard').style.display = 'flex';

          // Close modal and refresh appointments
          closeAddCustomerModal();
          await loadAppointments();
        }
      } catch (error) {
        console.error('Failed to assign customer:', error);
        alert('Failed to assign customer');
      }
    }

    // Close "Add Customer to Appointment" dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('addCustDropdown');
      const menu = document.getElementById('addCustDropdownMenu');
      if (dropdown && menu && menu.classList.contains('open')) {
        if (!dropdown.contains(event.target) && !menu.contains(event.target)) {
          closeAddCustDropdown();
        }
      }
    });

    // Functions for "Add Customer to Appointment" modal dropdown
    function toggleAddCustDropdown() {
      const dropdown = document.getElementById('addCustDropdown');
      const menu = document.getElementById('addCustDropdownMenu');
      if (menu.classList.contains('open')) {
        closeAddCustDropdown();
      } else {
        dropdown.classList.add('open');
        menu.classList.add('open');
        setTimeout(() => {
          document.getElementById('addCustSearchInput').focus();
        }, 100);
      }
    }

    function closeAddCustDropdown() {
      document.getElementById('addCustDropdown').classList.remove('open');
      document.getElementById('addCustDropdownMenu').classList.remove('open');
    }

    function filterAddCustList() {
      const searchTerm = document.getElementById('addCustSearchInput').value.toLowerCase().trim();
      const customerList = document.getElementById('addCustList');
      customerList.innerHTML = '';

      const filteredClients = clients.filter(client => {
        const fullName = `${client.first_name} ${client.last_name}`.toLowerCase();
        const email = (client.email || '').toLowerCase();
        return fullName.includes(searchTerm) || email.includes(searchTerm);
      });

      if (filteredClients.length === 0) {
        customerList.innerHTML = '<div class="customer-no-results">No customers found</div>';
        return;
      }

      filteredClients.forEach(client => {
        const item = document.createElement('div');
        item.className = 'customer-item';
        if (selectedCustomerId === client.id) {
          item.className += ' selected';
        }
        item.dataset.clientId = client.id;
        item.onclick = () => selectAddCustCustomer(client);

        const initials = getInitials(client.first_name, client.last_name);
        const fullName = `${client.first_name} ${client.last_name}`;
        const email = client.email || '';

        item.innerHTML = `
          <div class="customer-avatar">${initials}</div>
          <div class="customer-info">
            <div class="customer-name">${fullName}</div>
            <div class="customer-email">${email}</div>
          </div>
        `;
        customerList.appendChild(item);
      });
    }

    function selectAddCustCustomer(client) {
      selectedCustomerId = client.id;
      document.getElementById('customerSelect').value = client.id;

      const selected = document.getElementById('addCustDropdownSelected');
      const initials = getInitials(client.first_name, client.last_name);
      const fullName = `${client.first_name} ${client.last_name}`;
      const email = client.email || '';

      selected.innerHTML = `
        <div class="selected-customer-avatar">${initials}</div>
        <div class="selected-customer-info">
          <div class="selected-customer-name">${fullName}</div>
          <div class="selected-customer-email">${email}</div>
        </div>
      `;

      document.querySelectorAll('#addCustList .customer-item').forEach(item => {
        item.classList.remove('selected');
        if (parseInt(item.dataset.clientId) === client.id) {
          item.classList.add('selected');
        }
      });

      closeAddCustDropdown();
    }

    function populateAddCustList() {
      const customerList = document.getElementById('addCustList');
      customerList.innerHTML = '';

      if (clients.length === 0) {
        customerList.innerHTML = '<div class="customer-no-results">No customers found</div>';
        return;
      }

      clients.forEach(client => {
        const item = document.createElement('div');
        item.className = 'customer-item';
        item.dataset.clientId = client.id;
        item.onclick = () => selectAddCustCustomer(client);

        const initials = getInitials(client.first_name, client.last_name);
        const fullName = `${client.first_name} ${client.last_name}`;
        const email = client.email || '';

        item.innerHTML = `
          <div class="customer-avatar">${initials}</div>
          <div class="customer-info">
            <div class="customer-name">${fullName}</div>
            <div class="customer-email">${email}</div>
          </div>
        `;
        customerList.appendChild(item);
      });
    }

    function getInitials(firstName, lastName) {
      const first = firstName ? firstName.charAt(0).toUpperCase() : '';
      const last = lastName ? lastName.charAt(0).toUpperCase() : '';
      return first + last;
    }

    // =====================
    // Create Customer Modal
    // =====================
    function openCreateCustomerModal() {
      // Clear form
      document.getElementById('newCustomerFirstName').value = '';
      document.getElementById('newCustomerLastName').value = '';
      document.getElementById('newCustomerEmail').value = '';
      document.getElementById('newCustomerPhone').value = '';
      document.getElementById('newCustomerCountryCode').value = '+27';

      // Show modal
      document.getElementById('createCustomerModalOverlay').classList.add('show');
      document.getElementById('createCustomerModal').classList.add('show');

      // Focus first field
      setTimeout(() => {
        document.getElementById('newCustomerFirstName').focus();
      }, 100);
    }

    function closeCreateCustomerModal() {
      document.getElementById('createCustomerModalOverlay').classList.remove('show');
      document.getElementById('createCustomerModal').classList.remove('show');
    }

    async function createNewCustomer() {
      const firstName = document.getElementById('newCustomerFirstName').value.trim();
      const lastName = document.getElementById('newCustomerLastName').value.trim();
      const email = document.getElementById('newCustomerEmail').value.trim();
      const countryCode = document.getElementById('newCustomerCountryCode').value;
      const phone = document.getElementById('newCustomerPhone').value.trim();

      if (!firstName) {
        alert('First name is required');
        document.getElementById('newCustomerFirstName').focus();
        return;
      }

      if (!lastName) {
        alert('Last name is required');
        document.getElementById('newCustomerLastName').focus();
        return;
      }

      const fullPhone = phone ? `${countryCode}${phone}` : '';

      try {
        const response = await apiRequest('/api/clients', {
          method: 'POST',
          body: JSON.stringify({
            first_name: firstName,
            last_name: lastName,
            email: email || null,
            phone: fullPhone || null
          })
        });

        if (response) {
          // Add new client to dropdown and select it
          const select = document.getElementById('customerSelect');
          const option = document.createElement('option');
          option.value = response.id;
          option.textContent = `${response.first_name} ${response.last_name}${response.email ? ` (${response.email})` : ''}`;
          select.appendChild(option);
          select.value = response.id;

          // Add to clients array
          clients.push(response);

          // Close create modal
          closeCreateCustomerModal();
        }
      } catch (error) {
        console.error('Failed to create customer:', error);
        alert('Failed to create customer');
      }
    }

    async function toggleCheckin() {
      if (!selectedAppointment) return;

      const toggle = document.getElementById('panelCheckinToggle');
      const checkinTime = document.getElementById('panelCheckinTime');
      isCheckedIn = !isCheckedIn;
      toggle.classList.toggle('active', isCheckedIn);

      if (isCheckedIn) {
        // Show check-in timestamp
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        checkinTime.textContent = `${dateStr}, ${timeStr}`;
        checkinTime.classList.add('show');
        await checkInAppointment();
      } else {
        // Hide check-in timestamp
        checkinTime.textContent = '';
        checkinTime.classList.remove('show');
      }
    }

    // =====================
    // Signup Menu (3 dots)
    // =====================
    function toggleSignupMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('signupMenu');
      menu.classList.toggle('show');

      // Close menu when clicking outside
      if (menu.classList.contains('show')) {
        setTimeout(() => {
          document.addEventListener('click', closeSignupMenuOnClickOutside);
        }, 0);
      }
    }

    function closeSignupMenuOnClickOutside(event) {
      const menu = document.getElementById('signupMenu');
      if (!event.target.closest('.panel-more-wrapper')) {
        menu.classList.remove('show');
        document.removeEventListener('click', closeSignupMenuOnClickOutside);
      }
    }

    function closeSignupMenu() {
      document.getElementById('signupMenu').classList.remove('show');
      document.removeEventListener('click', closeSignupMenuOnClickOutside);
    }

    function addTaskToCustomer() {
      closeSignupMenu();
      alert('Add task to customer - Feature coming soon');
    }

    function sellProducts() {
      closeSignupMenu();
      alert('Sell products - Feature coming soon');
    }

    function cancelReservation() {
      closeSignupMenu();
      cancelAppointment();
    }

    function contactCustomer() {
      closeSignupMenu();
      if (!selectedAppointment) return;

      const clientName = selectedAppointment.extendedProps?.clientName;
      if (!clientName) {
        alert('No customer assigned to this appointment');
        return;
      }
      alert('Contact customer - Feature coming soon');
    }

    async function cancelAppointment() {
      if (!selectedAppointment) return;
      openCancelModal();
    }

    async function checkInAppointment() {
      if (!selectedAppointment) return;

      try {
        const response = await apiRequest(`/api/appointments/${selectedAppointment.id}/check-in`, {
          method: 'POST'
        });

        if (response) {
          // Update status badge
          const statusBadge = document.getElementById('panelStatusBadge');
          statusBadge.textContent = 'Paid';
          statusBadge.className = 'panel-status-badge paid';
        }
      } catch (error) {
        console.error('Failed to check in:', error);
        alert('Failed to check in');
      }
    }

    async function markAsPaid() {
      if (!selectedAppointment) return;

      try {
        const response = await apiRequest(`/api/appointments/${selectedAppointment.id}/complete`, {
          method: 'POST'
        });

        if (response) {
          closeAppointmentPanel();
          await loadAppointments();
        }
      } catch (error) {
        console.error('Failed to mark as paid:', error);
        alert('Failed to mark as paid');
      }
    }

    // =====================
    // New Appointment Modal
    // =====================

    async function openNewAptModal(date) {
      try {
        // Show modal immediately
        document.getElementById('newAptModalOverlay').classList.add('show');
        document.getElementById('newAptModal').classList.add('show');

        // Set the start date/time using LOCAL time (not UTC)
        // Format: YYYY-MM-DDTHH:MM for datetime-local input
        const formatLocalDateTime = (d) => {
          const year = d.getFullYear();
          const month = String(d.getMonth() + 1).padStart(2, '0');
          const day = String(d.getDate()).padStart(2, '0');
          const hours = String(d.getHours()).padStart(2, '0');
          const minutes = String(d.getMinutes()).padStart(2, '0');
          return `${year}-${month}-${day}T${hours}:${minutes}`;
        };

        const formatLocalDate = (d) => {
          const year = d.getFullYear();
          const month = String(d.getMonth() + 1).padStart(2, '0');
          const day = String(d.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        };

        document.getElementById('newAptStartsAt').value = formatLocalDateTime(date);

        // Set default end date for recurring (1 week later)
        const endDate = new Date(date);
        endDate.setDate(endDate.getDate() + 7);
        document.getElementById('endsOnDate').value = formatLocalDate(endDate);

        // Load dropdowns in parallel (don't block modal display)
        Promise.all([
          loadNewAptServices(),
          loadNewAptStaff(),
          loadNewAptVenues(),
          loadNewAptCustomers()
        ]).catch(err => console.error('Error loading dropdown data:', err));
      } catch (error) {
        console.error('Error opening new appointment modal:', error);
      }
    }

    function closeNewAptModal() {
      document.getElementById('newAptModalOverlay').classList.remove('show');
      document.getElementById('newAptModal').classList.remove('show');
      resetNewAptForm();
    }

    function resetNewAptForm() {
      document.getElementById('newAptService').value = '';
      document.getElementById('newAptStaff').value = '';
      document.getElementById('newAptVenue').value = '';
      document.getElementById('newAptCustomer').value = '';
      document.getElementById('newAptDuration').value = 60;
      document.getElementById('newAptBufferStart').value = 10;
      document.getElementById('newAptBufferEnd').value = 10;
      document.getElementById('newAptPrice').value = 0;
      document.getElementById('newAptNote').value = '';
      document.getElementById('sendConfirmation').checked = true;

      // Reset searchable customer dropdown
      resetCustomerDropdown();

      // Reset recurring
      isRecurring = false;
      document.getElementById('recurringToggle').classList.remove('active');
      document.getElementById('recurringLabel').textContent = 'No';
      document.getElementById('recurringOptions').classList.remove('show');
      document.getElementById('repeatEvery').value = 7;
      document.getElementById('endsAfterCount').value = 4;
      setEndsMode('on');

      // Reset type
      aptType = 'appointment';
      document.querySelectorAll('.apt-type-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i === 0);
      });
    }

    async function loadNewAptServices() {
      try {
        const token = localStorage.getItem('auth_token');
        // Remove active_only filter to show all services
        const response = await fetch('/api/services', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          newAptServices = await response.json();
          console.log('Loaded services:', newAptServices);
          const select = document.getElementById('newAptService');
          select.innerHTML = '<option value="">Select...</option>';
          newAptServices.forEach(service => {
            const option = document.createElement('option');
            option.value = service.id;
            option.textContent = service.name;
            option.dataset.duration = service.duration_minutes || 60;
            option.dataset.price = service.price || 0;
            option.dataset.bufferBefore = service.buffer_before_minutes || 10;
            option.dataset.bufferAfter = service.buffer_after_minutes || 10;
            select.appendChild(option);
          });
        } else {
          console.error('Services API error:', response.status);
        }
      } catch (error) {
        console.error('Failed to load services:', error);
      }
    }

    async function loadNewAptStaff() {
      try {
        const token = localStorage.getItem('auth_token');
        const response = await fetch('/api/staff?active_only=true', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          newAptStaffList = await response.json();
          const select = document.getElementById('newAptStaff');
          select.innerHTML = '<option value="">Select...</option>';
          newAptStaffList.forEach(staff => {
            const option = document.createElement('option');
            option.value = staff.id;
            option.textContent = `${staff.first_name} ${staff.last_name}`;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Failed to load staff:', error);
      }
    }

    async function loadNewAptVenues() {
      try {
        const token = localStorage.getItem('auth_token');
        const startTime = document.getElementById('newAptStartsAt').value;
        const duration = document.getElementById('newAptDuration').value || 60;

        // Use availability endpoint if we have a start time, otherwise use basic locations
        let url = '/api/locations';
        if (startTime) {
          url = `/api/locations/availability?start_time=${encodeURIComponent(startTime)}&duration=${duration}`;
        }

        console.log('Loading venues from:', url);
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          console.log('Loaded venues:', data);
          newAptVenues = Array.isArray(data) ? data : [];
          renderVenueDropdown();
        } else {
          console.error('Failed to load venues, status:', response.status);
          // Fallback: try basic locations endpoint
          if (startTime) {
            console.log('Falling back to /api/locations');
            const fallbackResponse = await fetch('/api/locations', {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (fallbackResponse.ok) {
              newAptVenues = await fallbackResponse.json();
              renderVenueDropdown();
            }
          }
        }
      } catch (error) {
        console.error('Failed to load venues:', error);
      }
    }

    function renderVenueDropdown() {
      const select = document.getElementById('newAptVenue');
      const currentValue = select.value;
      select.innerHTML = '<option value="">Select...</option>';

      newAptVenues.forEach(venue => {
        const option = document.createElement('option');
        option.value = venue.id;

        if (venue.is_occupied) {
          option.textContent = `${venue.name}    Occupied`;
          option.style.color = '#9ca3af';
          option.disabled = true;
        } else {
          option.textContent = venue.name;
        }

        select.appendChild(option);
      });

      // Restore selected value if still available
      if (currentValue) {
        const selectedOption = select.querySelector(`option[value="${currentValue}"]`);
        if (selectedOption && !selectedOption.disabled) {
          select.value = currentValue;
        }
      }
    }

    async function loadNewAptCustomers() {
      try {
        const token = localStorage.getItem('auth_token');
        const response = await fetch('/api/clients?limit=5000', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          newAptCustomers = data.clients || data;
          console.log(`Loaded ${newAptCustomers.length} customers for dropdown`);
          renderCustomerDropdown(newAptCustomers);
        }
      } catch (error) {
        console.error('Failed to load customers:', error);
      }
    }

    // Searchable Customer Dropdown Functions
    // Note: selectedCustomerId is declared above in Customer Dropdown Functions section

    function renderCustomerDropdown(customers) {
      const list = document.getElementById('customerDropdownList');
      if (!list) return;

      if (customers.length === 0) {
        list.innerHTML = '<div class="searchable-dropdown-empty">No customers found</div>';
        return;
      }

      list.innerHTML = customers.map(customer => {
        const fullName = `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unknown';
        const email = customer.email || '';
        const initials = fullName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const isSelected = selectedCustomerId === customer.id;

        return `
          <div class="searchable-dropdown-item ${isSelected ? 'selected' : ''}" data-id="${customer.id}" onclick="selectCustomer(${customer.id})">
            <div class="customer-avatar">${initials}</div>
            <div class="customer-info">
              <div class="customer-name">${fullName}</div>
              <div class="customer-email">${email}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleCustomerDropdown() {
      const menu = document.getElementById('customerDropdownMenu');
      const trigger = document.querySelector('.searchable-dropdown-trigger');
      const isOpen = menu.classList.contains('show');

      if (isOpen) {
        closeCustomerDropdown();
      } else {
        menu.classList.add('show');
        trigger.classList.add('active');
        // Focus on search input
        setTimeout(() => {
          document.getElementById('customerSearchInput').focus();
        }, 50);
      }
    }

    function closeCustomerDropdown() {
      const menu = document.getElementById('customerDropdownMenu');
      const trigger = document.querySelector('.searchable-dropdown-trigger');
      if (menu) menu.classList.remove('show');
      if (trigger) trigger.classList.remove('active');
      // Clear search
      const searchInput = document.getElementById('customerSearchInput');
      if (searchInput) {
        searchInput.value = '';
        renderCustomerDropdown(newAptCustomers);
      }
    }

    function filterCustomers(searchTerm) {
      const term = searchTerm.toLowerCase().trim();
      if (!term) {
        renderCustomerDropdown(newAptCustomers);
        return;
      }

      const filtered = newAptCustomers.filter(customer => {
        const fullName = `${customer.first_name || ''} ${customer.last_name || ''}`.toLowerCase();
        const email = (customer.email || '').toLowerCase();
        return fullName.includes(term) || email.includes(term);
      });

      renderCustomerDropdown(filtered);
    }

    function selectCustomer(customerId) {
      const customer = newAptCustomers.find(c => c.id === customerId);
      if (!customer) return;

      selectedCustomerId = customerId;

      // Update hidden input
      document.getElementById('newAptCustomer').value = customerId;

      // Update display
      const fullName = `${customer.first_name || ''} ${customer.last_name || ''}`.trim();
      const email = customer.email || '';
      const initials = fullName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

      document.getElementById('customerDropdownDisplay').innerHTML = `
        <div class="selected-customer">
          <div class="customer-avatar">${initials}</div>
          <div class="customer-info">
            <div class="customer-name">${fullName}</div>
            <div class="customer-email">${email}</div>
          </div>
        </div>
      `;

      closeCustomerDropdown();
    }

    function resetCustomerDropdown() {
      selectedCustomerId = null;
      document.getElementById('newAptCustomer').value = '';
      document.getElementById('customerDropdownDisplay').innerHTML = '<span class="placeholder">Select customer...</span>';
      const searchInput = document.getElementById('customerSearchInput');
      if (searchInput) searchInput.value = '';
      renderCustomerDropdown(newAptCustomers);
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('customerDropdown');
      if (dropdown && !dropdown.contains(e.target)) {
        closeCustomerDropdown();
      }
    });

    function setAptType(type) {
      aptType = type;
      document.querySelectorAll('.apt-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().includes(type === 'appointment' ? 'appointment' : 'time block'));
      });
    }

    function onServiceChange() {
      const select = document.getElementById('newAptService');
      const selectedOption = select.options[select.selectedIndex];
      if (selectedOption && selectedOption.value) {
        const duration = selectedOption.dataset.duration || 60;
        const price = selectedOption.dataset.price || 0;
        const bufferBefore = selectedOption.dataset.bufferBefore || 10;
        const bufferAfter = selectedOption.dataset.bufferAfter || 10;
        document.getElementById('newAptDuration').value = duration;
        document.getElementById('newAptPrice').value = parseFloat(price).toFixed(0);
        document.getElementById('newAptBufferStart').value = bufferBefore;
        document.getElementById('newAptBufferEnd').value = bufferAfter;
        // Refresh venue availability with new duration
        onTimeOrDurationChange();
      }
    }

    // Debounce timer for venue availability check
    let venueAvailabilityTimer = null;

    function onTimeOrDurationChange() {
      // Debounce the API call
      if (venueAvailabilityTimer) {
        clearTimeout(venueAvailabilityTimer);
      }
      venueAvailabilityTimer = setTimeout(() => {
        loadNewAptVenues();
      }, 300);
    }

    function addAnotherCustomer() {
      // For now just show a message - multi-customer support can be added later
      alert('Multi-customer booking coming soon');
    }

    async function bookAppointment() {
      const token = localStorage.getItem('auth_token');
      const startsAt = document.getElementById('newAptStartsAt').value;
      const serviceId = document.getElementById('newAptService').value;
      const venueId = document.getElementById('newAptVenue').value;
      const staffId = document.getElementById('newAptStaff').value;
      const customerId = document.getElementById('newAptCustomer').value;
      const durationInput = document.getElementById('newAptDuration').value;
      const priceInput = document.getElementById('newAptPrice').value;
      const note = document.getElementById('newAptNote').value;

      // Validate mandatory fields
      const errors = [];

      if (!serviceId) {
        errors.push('Service is required');
      }

      if (!venueId) {
        errors.push('Venue is required');
      }

      if (!customerId) {
        errors.push('Customer is required');
      }

      if (!durationInput || parseInt(durationInput) <= 0) {
        errors.push('Duration is required and must be a positive number');
      }

      if (priceInput === '' || priceInput === null || parseFloat(priceInput) < 0 || isNaN(parseFloat(priceInput))) {
        errors.push('Total price is required and must be a valid non-negative number');
      }

      if (!startsAt) {
        errors.push('Start time is required');
      }

      if (errors.length > 0) {
        alert('Please fix the following errors:\n\n' + errors.join('\n'));
        return;
      }

      const duration = parseInt(durationInput);
      const price = parseFloat(priceInput);

      const startTime = new Date(startsAt);
      const endTime = new Date(startTime.getTime() + duration * 60000);

      // Get service name for title
      const serviceSelect = document.getElementById('newAptService');
      const serviceName = serviceSelect.options[serviceSelect.selectedIndex]?.textContent || 'Appointment';

      const appointmentData = {
        service_type_id: serviceId,
        location_id: venueId,
        staff_id: staffId || null,
        client_id: customerId,
        title: serviceName,
        start_time: startTime.toISOString(),
        end_time: endTime.toISOString(),
        price: price,
        status: 'scheduled',
        location_type: 'in_person',
        client_notes: note
      };

      try {
        // If recurring, create multiple appointments
        if (isRecurring) {
          const repeatEvery = parseInt(document.getElementById('repeatEvery').value) || 7;
          const appointments = [appointmentData];

          if (endsMode === 'on') {
            const endDate = new Date(document.getElementById('endsOnDate').value);
            let currentDate = new Date(startTime);
            currentDate.setDate(currentDate.getDate() + repeatEvery);

            while (currentDate <= endDate) {
              const apt = { ...appointmentData };
              apt.start_time = new Date(currentDate).toISOString();
              apt.end_time = new Date(currentDate.getTime() + duration * 60000).toISOString();
              appointments.push(apt);
              currentDate.setDate(currentDate.getDate() + repeatEvery);
            }
          } else {
            const occurrences = parseInt(document.getElementById('endsAfterCount').value) || 4;
            let currentDate = new Date(startTime);

            for (let i = 1; i < occurrences; i++) {
              currentDate.setDate(currentDate.getDate() + repeatEvery);
              const apt = { ...appointmentData };
              apt.start_time = new Date(currentDate).toISOString();
              apt.end_time = new Date(currentDate.getTime() + duration * 60000).toISOString();
              appointments.push(apt);
            }
          }

          // Create all appointments
          for (const apt of appointments) {
            await fetch('/api/appointments', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(apt)
            });
          }
        } else {
          // Single appointment
          const response = await fetch('/api/appointments', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(appointmentData)
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to create appointment');
          }
        }

        closeNewAptModal();
        await loadAppointments();
      } catch (error) {
        console.error('Failed to book appointment:', error);
        alert(error.message || 'Failed to book appointment');
      }
    }

    function bookAndPay() {
      // Book the appointment first, then redirect to payment
      bookAppointment().then(() => {
        // Payment flow would go here
      });
    }
  </script>

  <!-- Appointment Detail Panel -->
  <div class="appointment-panel-overlay" id="appointmentPanelOverlay" onclick="closeAppointmentPanel()"></div>
  <div class="appointment-panel" id="appointmentPanel">
    <!-- Header -->
    <div class="panel-header">
      <div class="panel-header-left">
        <div class="panel-title" id="panelTitle">Appointment reservation</div>
        <div class="panel-id" id="panelId">ID: 0</div>
      </div>
      <div class="panel-header-right">
        <span class="panel-status-badge paid" id="panelStatusBadge">Paid</span>
        <button class="panel-close-btn" onclick="closeAppointmentPanel()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>

    <!-- Signups Section -->
    <div class="panel-signups" id="panelSignupsSection">
      <div class="panel-signups-header">
        <span class="panel-signups-badge">Signups</span>
        <span class="panel-checkin-label">
          Check-in
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </span>
      </div>
      <div class="panel-signup-card" id="panelSignupCard">
        <div class="panel-signup-avatar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
        <div class="panel-signup-info">
          <div class="panel-signup-name" id="panelClientName">No client assigned</div>
          <div class="panel-signup-email" id="panelClientEmail" style="font-size: 0.75rem; color: #6B7280; margin-top: 2px;"></div>
          <div class="panel-signup-phone" id="panelClientPhone" style="font-size: 0.75rem; color: #6B7280; margin-top: 2px;"></div>
          <div class="panel-signup-tags" id="panelPaymentTags" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
            <!-- Payment tags will be populated dynamically -->
          </div>
        </div>
        <div class="panel-signup-actions">
          <div class="panel-checkin-row">
            <div class="panel-toggle" id="panelCheckinToggle" onclick="toggleCheckin()"></div>
            <span class="panel-checkin-time" id="panelCheckinTime"></span>
          </div>
          <div class="panel-more-wrapper">
            <button class="panel-more-btn" onclick="toggleSignupMenu(event)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="12" cy="5" r="1"></circle>
                <circle cx="12" cy="19" r="1"></circle>
              </svg>
            </button>
            <div class="panel-signup-menu" id="signupMenu">
              <button class="panel-signup-menu-item" onclick="addTaskToCustomer()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <path d="M9 12l2 2 4-4"></path>
                </svg>
                Add task to customer
              </button>
              <button class="panel-signup-menu-item" onclick="sellProducts()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                  <line x1="3" y1="6" x2="21" y2="6"></line>
                  <path d="M16 10a4 4 0 0 1-8 0"></path>
                </svg>
                Sell products
              </button>
              <button class="panel-signup-menu-item cancel" onclick="cancelReservation()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18"></path>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Cancel reservation
              </button>
              <button class="panel-signup-menu-item" onclick="contactCustomer()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                </svg>
                Contact customer
              </button>
            </div>
          </div>
        </div>
      </div>
      <button class="panel-add-customer" onclick="openAddCustomerModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Add customer
      </button>
    </div>

    <!-- Tabs -->
    <div class="panel-tabs">
      <button class="panel-tab active" onclick="showPanelTab('details')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="8" y1="6" x2="21" y2="6"></line>
          <line x1="8" y1="12" x2="21" y2="12"></line>
          <line x1="8" y1="18" x2="21" y2="18"></line>
          <line x1="3" y1="6" x2="3.01" y2="6"></line>
          <line x1="3" y1="12" x2="3.01" y2="12"></line>
          <line x1="3" y1="18" x2="3.01" y2="18"></line>
        </svg>
        Details
      </button>
      <button class="panel-tab" onclick="showPanelTab('timing')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        Timing
      </button>
      <button class="panel-tab" onclick="showPanelTab('note')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
        </svg>
        Note
      </button>
    </div>

    <!-- Content -->
    <div class="panel-content">
      <!-- Details Tab Content -->
      <div id="panelDetailsContent">
      <!-- Scheduled Section -->
      <div class="panel-section">
        <div class="panel-section-title">Scheduled</div>
        <div class="panel-info-row">
          <div class="panel-info-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </div>
          <div class="panel-info-content">
            <div class="panel-info-label" id="panelDateTime">--</div>
            <div class="panel-info-sublabel" id="panelDuration">--</div>
          </div>
        </div>
      </div>

      <!-- Practitioner & Venue Section -->
      <div class="panel-section">
        <div class="panel-section-title">Practitioner & Venue</div>
        <div class="panel-practitioner-row">
          <div class="panel-practitioner-item">
            <div class="panel-info-icon gray">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
            <a href="#" class="panel-info-link" id="panelStaffName">Not assigned</a>
          </div>
          <div class="panel-practitioner-item">
            <div class="panel-info-icon gray">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
            </div>
            <span class="panel-info-label" id="panelLocation">In Person</span>
          </div>
        </div>
      </div>

      <!-- Pricing Section -->
      <div class="panel-section">
        <div class="panel-section-title">Pricing</div>
        <div class="panel-pricing-row">
          <div class="panel-info-icon green">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
          </div>
          <div class="panel-info-content">
            <div class="panel-price-label">Total price</div>
            <div class="panel-price-value" id="panelPrice">ZAR 0.00 <span class="panel-price-credits">or 0 credits</span></div>
            <div class="panel-price-actions">
              <span class="panel-price-type">Flat price</span>
              <button class="panel-copy-link-btn" onclick="copyPaymentLink(event)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg>
                Copy reservation payment link
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Service & Board Section -->
      <div class="panel-section">
        <div class="panel-section-title">Service & Board</div>
        <div class="panel-service-row panel-service-row-clickable" onclick="navigateToSchedule()">
          <div class="panel-service-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          </div>
          <div class="panel-info-content">
            <span class="panel-service-name" id="panelServiceName">Service</span>
            <div class="panel-service-board">on <span id="panelBoardName">Expand Health</span></div>
          </div>
        </div>
      </div>

      </div><!-- End Details Tab Content -->

      <!-- Timing Tab Content -->
      <div id="panelTimingContent" style="display: none; padding: 16px 0;">
        <!-- Reservation Preview Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <div style="font-size: 0.875rem; font-weight: 500; color: #374151;">Reservation preview</div>
          <svg viewBox="0 0 24 24" fill="none" stroke="#9CA3AF" stroke-width="2" style="width: 16px; height: 16px;">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>

        <!-- Timeline Container -->
        <div style="display: flex; gap: 16px;">
          <!-- Left Labels -->
          <div style="display: flex; flex-direction: column; gap: 0; font-size: 0.75rem; color: #6B7280; min-width: 140px;">
            <div style="display: flex; align-items: center; height: 40px;">
              <div>
                <div>Buffer/overlap at start</div>
                <div id="panelBufferStart" style="color: #9CA3AF;">Add Buffer time 10m</div>
              </div>
            </div>
            <div style="display: flex; align-items: center; height: 60px;">
              <div>
                <div>Duration</div>
                <div id="panelDurationValue" style="font-weight: 600; color: #374151;">38m</div>
              </div>
            </div>
            <div style="display: flex; align-items: center; height: 40px;">
              <div>
                <div>Buffer/overlap at end</div>
                <div id="panelBufferEnd" style="color: #9CA3AF;">Add Buffer time 10m</div>
              </div>
            </div>
          </div>

          <!-- Visual Timeline -->
          <div style="flex: 1; display: flex; flex-direction: column; position: relative;">
            <!-- Buffer Start (striped) -->
            <div id="panelBufferStartVisual" style="height: 40px; background: repeating-linear-gradient(45deg, #E5E7EB, #E5E7EB 4px, #F3F4F6 4px, #F3F4F6 8px); border-radius: 4px 4px 0 0;"></div>

            <!-- Main Appointment Block -->
            <div id="panelAppointmentBlock" style="height: 60px; background: #0D9488; border-radius: 0; padding: 8px 12px; color: white; display: flex; flex-direction: column; justify-content: center;">
              <div style="display: flex; align-items: center; gap: 6px; font-size: 0.75rem; font-weight: 600;">
                <span style="width: 8px; height: 8px; background: #4ADE80; border-radius: 50%;"></span>
                <span id="panelBlockServiceName">HBOT1 30 min</span>
              </div>
              <div style="font-size: 0.6875rem; opacity: 0.9; margin-top: 2px;">
                <span id="panelBlockCustomer"> Customer</span> 
                <span id="panelBlockLocation"> Location</span>
              </div>
              <div style="font-size: 0.6875rem; opacity: 0.9;">
                <span id="panelBlockStaff"> Staff</span>
              </div>
              <div style="font-size: 0.6875rem; opacity: 0.9;">
                <span id="panelBlockTime"> 9:00 AM-9:38 AM</span>
              </div>
            </div>

            <!-- Buffer End (striped) -->
            <div id="panelBufferEndVisual" style="height: 40px; background: repeating-linear-gradient(45deg, #E5E7EB, #E5E7EB 4px, #F3F4F6 4px, #F3F4F6 8px); border-radius: 0 0 4px 4px;"></div>

            <!-- Time Labels on Right -->
            <div style="position: absolute; right: -50px; top: 0; font-size: 0.6875rem; color: #9CA3AF;" id="panelTimeStart">9:15 AM</div>
            <div style="position: absolute; right: -50px; bottom: 0; font-size: 0.6875rem; color: #9CA3AF;" id="panelTimeEnd">9:53 AM</div>
          </div>
        </div>

        <!-- Created Section -->
        <div class="panel-section" style="margin-top: 24px;">
          <div class="panel-section-title">Created</div>
          <div class="panel-info-row">
            <div class="panel-info-icon gray">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
            </div>
            <div class="panel-info-content">
              <div class="panel-info-sublabel" id="panelCreatedAt">--</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Note Tab Content -->
      <div id="panelNoteContent" style="display: none; padding: 16px 0;">
        <div class="panel-section">
          <div class="panel-section-title">Appointment Note</div>
          <textarea id="panelNoteText" placeholder="Add a note for this appointment..." style="width: 100%; min-height: 150px; padding: 12px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 0.875rem; resize: vertical; font-family: inherit;"></textarea>
          <button onclick="saveAppointmentNote()" style="margin-top: 12px; padding: 8px 16px; background: #0F766E; color: white; border: none; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">Save Note</button>
        </div>
      </div>
    </div>

    <!-- Panel Footer -->
    <div class="panel-footer">
      <div class="panel-footer-top">
        <button class="panel-btn panel-btn-secondary" onclick="addToCalendar()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          Add to calendar
        </button>
        <button class="panel-btn panel-btn-secondary" onclick="sendPaymentLink()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
          </svg>
          Send payment link
        </button>
      </div>
      <div class="panel-footer-bottom">
        <button class="panel-btn panel-btn-cancel" onclick="cancelAppointment()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Cancel
        </button>
        <button class="panel-btn panel-btn-edit" onclick="openEditAppointmentModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
          </svg>
          Edit
        </button>
        <button class="panel-btn panel-btn-pay" id="panelPaidBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
            <line x1="1" y1="10" x2="23" y2="10"></line>
          </svg>
          Pay
        </button>
      </div>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div class="add-customer-modal-overlay" id="addCustomerModalOverlay" onclick="closeAddCustomerModal()"></div>
  <div class="add-customer-modal" id="addCustomerModal">
    <div class="add-customer-modal-header">
      <h3>Add customer</h3>
      <span class="modal-limit-badge" id="modalLimitBadge" style="display: none;">Over limit</span>
      <div class="modal-header-spacer"></div>
      <button class="modal-close-btn" onclick="closeAddCustomerModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="add-customer-modal-body">
      <label class="modal-label">Customer</label>
      <div class="customer-dropdown-container">
        <div class="customer-dropdown-row">
          <div class="customer-dropdown" id="addCustDropdown" onclick="toggleAddCustDropdown()">
            <div class="customer-dropdown-selected" id="addCustDropdownSelected">
              <span class="dropdown-placeholder">Select customer...</span>
            </div>
            <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <button class="modal-add-new-btn" onclick="openCreateCustomerModal()" title="Create new customer">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
        </div>
        <div class="customer-dropdown-menu" id="addCustDropdownMenu">
          <div class="customer-search-wrapper">
            <svg class="customer-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" class="customer-search-input" id="addCustSearchInput" placeholder="Search customers..." oninput="filterAddCustList()" onclick="event.stopPropagation()">
          </div>
          <div class="customer-list" id="addCustList">
            <!-- Customer items will be populated dynamically -->
          </div>
        </div>
      </div>
      <input type="hidden" id="customerSelect" value="">
      <div class="modal-actions-row">
        <label class="modal-checkbox-label">
          <input type="checkbox" id="sendConfirmation" checked>
          <span>Send confirmation</span>
        </label>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" onclick="closeAddCustomerModal()">Cancel</button>
          <button class="modal-btn modal-btn-add" onclick="assignCustomer()">Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Customer Modal -->
  <div class="create-customer-modal-overlay" id="createCustomerModalOverlay" onclick="closeCreateCustomerModal()"></div>
  <div class="create-customer-modal" id="createCustomerModal">
    <div class="create-customer-modal-header">
      <h3>Create a new customer</h3>
      <button class="modal-close-btn" onclick="closeCreateCustomerModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="create-customer-modal-body">
      <div class="form-group">
        <label class="form-label">First name</label>
        <input type="text" id="newCustomerFirstName" class="form-input" placeholder="">
      </div>
      <div class="form-group">
        <label class="form-label">Last name</label>
        <input type="text" id="newCustomerLastName" class="form-input" placeholder="">
      </div>
      <div class="form-group">
        <label class="form-label">E-mail</label>
        <input type="email" id="newCustomerEmail" class="form-input" placeholder="">
      </div>
      <div class="form-group">
        <label class="form-label">Phone number</label>
        <div class="phone-input-row">
          <select id="newCustomerCountryCode" class="country-code-select">
            <option value="+1"> +1</option>
            <option value="+27" selected> +27</option>
            <option value="+44"> +44</option>
            <option value="+49"> +49</option>
            <option value="+33"> +33</option>
            <option value="+61"> +61</option>
            <option value="+91"> +91</option>
          </select>
          <input type="tel" id="newCustomerPhone" class="form-input phone-input" placeholder="">
        </div>
      </div>
    </div>
    <div class="create-customer-modal-footer">
      <button class="modal-btn modal-btn-cancel" onclick="closeCreateCustomerModal()">Cancel</button>
      <button class="modal-btn modal-btn-create" onclick="createNewCustomer()">Create</button>
    </div>
  </div>

  <!-- Edit Appointment Modal -->
  <div class="edit-apt-modal-overlay" id="editAptModalOverlay" onclick="closeEditAppointmentModal()"></div>
  <div class="edit-apt-modal" id="editAptModal">
    <div class="edit-apt-modal-header">
      <h3>Edit appointment reservation</h3>
      <button class="modal-close-btn" onclick="closeEditAppointmentModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="edit-apt-modal-body">
      <!-- Board (read-only) -->
      <div class="edit-apt-form-row">
        <label class="edit-apt-form-label">Board</label>
        <div class="edit-apt-form-value" id="editAptBoard">Expand Health</div>
      </div>

      <!-- Starts at -->
      <div class="edit-apt-form-row">
        <label class="edit-apt-form-label">Starts at</label>
        <div class="edit-apt-form-control">
          <input type="datetime-local" class="edit-apt-form-input" id="editAptStartsAt">
        </div>
      </div>

      <!-- Service -->
      <div class="edit-apt-form-row">
        <label class="edit-apt-form-label">Service</label>
        <div class="edit-apt-form-control">
          <select class="edit-apt-form-select" id="editAptService">
            <option value="">Select service...</option>
          </select>
        </div>
      </div>
      <div class="edit-apt-form-hint">Reservation with paid deposits or paid attendees can't have service changed</div>

      <!-- Staff -->
      <div class="edit-apt-form-row">
        <label class="edit-apt-form-label">Staff</label>
        <div class="edit-apt-form-control">
          <select class="edit-apt-form-select" id="editAptStaff">
            <option value="">Select staff...</option>
          </select>
        </div>
      </div>

      <!-- Venue -->
      <div class="edit-apt-form-row">
        <label class="edit-apt-form-label">Venue</label>
        <div class="edit-apt-form-control">
          <select class="edit-apt-form-select" id="editAptVenue">
            <option value="">Select venue...</option>
            <option value="event-space">Event Space</option>
            <option value="consultation-room">Consultation Room</option>
            <option value="treatment-room">Treatment Room</option>
          </select>
        </div>
      </div>

      <!-- Pay rate -->
      <div class="edit-apt-form-row">
        <label class="edit-apt-form-label">Pay rate</label>
        <div class="edit-apt-form-control edit-apt-form-control-with-btn">
          <select class="edit-apt-form-select" id="editAptPayRate">
            <option value="">Pay rate not specified</option>
          </select>
          <button class="edit-apt-add-btn" type="button">+</button>
        </div>
      </div>

      <!-- Duration & Buffers -->
      <div class="edit-apt-form-row">
        <label class="edit-apt-form-label">Duration &<br>Buffers/Overlaps</label>
        <div class="edit-apt-form-control">
          <div class="edit-apt-duration-row">
            <div class="edit-apt-duration-field">
              <input type="number" class="edit-apt-form-input edit-apt-duration-input" id="editAptBufferStart" value="5" min="0">
              <span class="edit-apt-duration-label">Buffer at start</span>
            </div>
            <div class="edit-apt-duration-field">
              <input type="number" class="edit-apt-form-input edit-apt-duration-input" id="editAptDuration" value="45" min="1">
              <span class="edit-apt-duration-label">Duration</span>
            </div>
            <div class="edit-apt-duration-field">
              <input type="number" class="edit-apt-form-input edit-apt-duration-input" id="editAptBufferEnd" value="5" min="0">
              <span class="edit-apt-duration-label">Buffer at end</span>
            </div>
            <span class="edit-apt-duration-unit">minutes</span>
          </div>
        </div>
      </div>

      <!-- Total price -->
      <div class="edit-apt-form-row">
        <label class="edit-apt-form-label">Total price</label>
        <div class="edit-apt-form-control">
          <div class="edit-apt-price-row">
            <span class="edit-apt-currency">ZAR</span>
            <input type="number" class="edit-apt-form-input edit-apt-price-input" id="editAptPrice" value="0" min="0" step="0.01">
          </div>
        </div>
      </div>
      <div class="edit-apt-form-hint">You can charge the customer or send a payment link once the appointment is created.</div>

      <!-- Additional note -->
      <div class="edit-apt-form-row edit-apt-form-row-top">
        <label class="edit-apt-form-label">Additional note</label>
        <div class="edit-apt-form-control">
          <textarea class="edit-apt-form-textarea" id="editAptNotes" rows="3" placeholder=""></textarea>
        </div>
      </div>
    </div>
    <div class="edit-apt-modal-footer">
      <button class="edit-apt-btn edit-apt-btn-cancel" onclick="closeEditAppointmentModal()">Cancel</button>
      <button class="edit-apt-btn edit-apt-btn-save" onclick="saveAppointmentChanges()">Save changes</button>
    </div>
  </div>

  <!-- New Appointment Modal -->
  <div class="new-apt-modal-overlay" id="newAptModalOverlay" onclick="closeNewAptModal()"></div>
  <div class="new-apt-modal" id="newAptModal">
    <div class="new-apt-modal-header">
      <h3>Add new</h3>
      <button class="modal-close-btn" onclick="closeNewAptModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="new-apt-modal-body">
      <!-- Appointment / Time Block Toggle -->
      <div class="apt-type-toggle">
        <button class="apt-type-btn active" onclick="setAptType('appointment')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          Appointment
        </button>
        <button class="apt-type-btn" onclick="setAptType('timeblock')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          Time block
        </button>
      </div>

      <!-- Board -->
      <div class="apt-form-row">
        <label class="apt-form-label">Board</label>
        <div class="apt-form-control">
          <select class="apt-form-select" id="newAptBoard">
            <option value="expand-health">Expand Health</option>
          </select>
        </div>
      </div>

      <!-- Starts at -->
      <div class="apt-form-row">
        <label class="apt-form-label">Starts at</label>
        <div class="apt-form-control">
          <input type="datetime-local" class="apt-form-input" id="newAptStartsAt" onchange="onTimeOrDurationChange()">
        </div>
      </div>

      <!-- Book recurring -->
      <div class="apt-form-row">
        <label class="apt-form-label">Book recurring</label>
        <div class="apt-form-control">
          <div class="apt-toggle-row">
            <div class="apt-toggle" id="recurringToggle" onclick="toggleRecurring()"></div>
            <span class="apt-toggle-label" id="recurringLabel">No</span>
          </div>
        </div>
      </div>

      <!-- Recurring Options (hidden by default) -->
      <div class="recurring-options" id="recurringOptions">
        <!-- Repeat every -->
        <div class="apt-form-row">
          <label class="apt-form-label">Repeat every</label>
          <div class="apt-form-control">
            <div class="repeat-every-row">
              <input type="number" class="apt-form-input repeat-input" id="repeatEvery" value="7" min="1">
              <span class="repeat-unit">days</span>
            </div>
          </div>
        </div>

        <!-- Ends -->
        <div class="apt-form-row" style="align-items: flex-start;">
          <label class="apt-form-label" style="padding-top: 10px;">Ends</label>
          <div class="apt-form-control">
            <div class="ends-options">
              <div class="ends-option">
                <button type="button" class="ends-radio-btn active" id="endsOnBtn" onclick="setEndsMode('on')">
                  <div class="radio-dot"></div>
                </button>
                <span class="ends-label">On</span>
                <input type="date" class="apt-form-input ends-date-input" id="endsOnDate">
              </div>
              <div class="ends-option">
                <button type="button" class="ends-radio-btn" id="endsAfterBtn" onclick="setEndsMode('after')">
                  <div class="radio-dot"></div>
                </button>
                <span class="ends-label">After</span>
                <input type="number" class="apt-form-input ends-count-input" id="endsAfterCount" value="4" min="1">
                <span class="ends-unit">OCCURRENCES</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Service -->
      <div class="apt-form-row">
        <label class="apt-form-label">Service</label>
        <div class="apt-form-control">
          <select class="apt-form-select" id="newAptService" onchange="onServiceChange()">
            <option value="">Select...</option>
          </select>
        </div>
      </div>

      <!-- Staff -->
      <div class="apt-form-row">
        <label class="apt-form-label">Staff</label>
        <div class="apt-form-control">
          <select class="apt-form-select" id="newAptStaff">
            <option value="">Select...</option>
          </select>
        </div>
      </div>

      <!-- Venue -->
      <div class="apt-form-row">
        <label class="apt-form-label">Venue</label>
        <div class="apt-form-control">
          <select class="apt-form-select" id="newAptVenue">
            <option value="">Select...</option>
          </select>
        </div>
      </div>

      <!-- Pay rate -->
      <div class="apt-form-row">
        <label class="apt-form-label">Pay rate</label>
        <div class="apt-form-control">
          <div class="customer-row">
            <select class="apt-form-select" id="newAptPayRate">
              <option value="">Pay rate not specified</option>
              <option value="50-50">50 50</option>
              <option value="60-percent">60% per ticket</option>
              <option value="fixed-1500">Fixed Fee R1500</option>
              <option value="fixed-600">Fixed Fee R600</option>
            </select>
            <button class="add-customer-btn" title="Add pay rate">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Customer -->
      <div class="apt-form-row">
        <label class="apt-form-label">Customer</label>
        <div class="apt-form-control">
          <div class="customer-row">
            <!-- Hidden select for form value -->
            <input type="hidden" id="newAptCustomer" value="">

            <!-- Searchable Dropdown -->
            <div class="searchable-dropdown" id="customerDropdown">
              <div class="searchable-dropdown-trigger" onclick="toggleCustomerDropdown()">
                <span class="placeholder" id="customerDropdownDisplay">Select customer...</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </div>
              <div class="searchable-dropdown-menu" id="customerDropdownMenu">
                <div class="searchable-dropdown-search">
                  <input type="text" id="customerSearchInput" placeholder="Search customers..." oninput="filterCustomers(this.value)">
                </div>
                <div class="searchable-dropdown-list" id="customerDropdownList">
                  <!-- Customers will be populated here -->
                </div>
              </div>
            </div>

            <button class="add-customer-btn" title="Add new customer" onclick="openCreateCustomerModal()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Add Customer Button -->
      <button class="add-more-customer-btn" onclick="addAnotherCustomer()">+ Add customer</button>

      <!-- Duration & Buffers/Overlaps -->
      <div class="apt-form-row">
        <label class="apt-form-label">Duration &<br>Buffers/Overlaps</label>
        <div class="apt-form-control">
          <div class="duration-buffers-row">
            <div class="buffer-field">
              <input type="number" id="newAptBufferStart" value="10" min="0" step="5">
              <span class="buffer-label">Buffer at start</span>
            </div>
            <div class="buffer-field">
              <input type="number" id="newAptDuration" value="60" min="5" step="5" onchange="onTimeOrDurationChange()">
              <span class="buffer-label">Duration</span>
            </div>
            <div class="buffer-field">
              <input type="number" id="newAptBufferEnd" value="10" min="0" step="5">
              <span class="buffer-label">Buffer at end</span>
            </div>
            <span class="buffer-unit">minutes</span>
          </div>
        </div>
      </div>

      <!-- Total price -->
      <div class="apt-form-row">
        <label class="apt-form-label">Total price</label>
        <div class="apt-form-control">
          <div class="price-input-row">
            <span class="price-currency">ZAR</span>
            <input type="number" id="newAptPrice" value="0" min="0" step="1">
          </div>
          <div class="price-note">You can charge the customer or send a payment link once the appointment is created.</div>
        </div>
      </div>

      <!-- Additional note -->
      <div class="apt-form-row" style="align-items: flex-start;">
        <label class="apt-form-label" style="padding-top: 10px;">Additional note</label>
        <div class="apt-form-control">
          <textarea class="apt-form-textarea" id="newAptNote" placeholder=""></textarea>
        </div>
      </div>
    </div>

    <div class="new-apt-modal-footer">
      <label class="send-confirmation-check">
        <input type="checkbox" id="sendConfirmation" checked>
        Send confirmation
      </label>
      <div class="modal-footer-buttons">
        <button class="apt-btn apt-btn-cancel" onclick="closeNewAptModal()">Cancel</button>
        <button class="apt-btn apt-btn-book-pay" onclick="bookAndPay()">Book & Pay</button>
        <button class="apt-btn apt-btn-book" onclick="bookAppointment()">Book</button>
      </div>
    </div>
  </div>

  <!-- Clock Status Toast -->
  <div class="clock-status-toast clocked-out" id="clockStatusToast">
    <div class="clock-status-icon clocked-out">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
    <span class="clock-status-text">Clocked out!</span>
    <button class="clock-status-close" onclick="hideClockToast()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>

  <!-- Cancel Reservation Modal -->
  <div class="cancel-modal-overlay" id="cancelModalOverlay" onclick="closeCancelModal()"></div>
  <div class="cancel-modal" id="cancelModal">
    <div class="cancel-modal-header">
      <h3>Cancel reservation</h3>
      <button class="cancel-modal-close" onclick="closeCancelModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="cancel-modal-body">
      <p class="cancel-modal-question">Are you sure you want to cancel this reservation?</p>
      <div class="cancel-modal-options">
        <label class="cancel-option">
          <div class="cancel-toggle">
            <input type="checkbox" id="cancelCreditCustomer">
            <span class="toggle-slider"></span>
          </div>
          <span class="cancel-option-text">Credit the customer (nothing to credit back)</span>
        </label>
        <label class="cancel-option">
          <div class="cancel-toggle">
            <input type="checkbox" id="cancelSendEmail" checked>
            <span class="toggle-slider"></span>
          </div>
          <span class="cancel-option-text">Send email notification to the customer</span>
        </label>
        <label class="cancel-option">
          <div class="cancel-toggle">
            <input type="checkbox" id="cancelLateCancellation">
            <span class="toggle-slider"></span>
          </div>
          <span class="cancel-option-text">Late cancellation</span>
        </label>
      </div>
    </div>
    <div class="cancel-modal-footer">
      <button class="cancel-modal-btn cancel-modal-btn-close" onclick="closeCancelModal()">Close</button>
      <button class="cancel-modal-btn cancel-modal-btn-confirm" onclick="confirmCancelAppointment()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        Cancel reservation
      </button>
    </div>
  </div>

  <!-- Success Toast Notification -->
  <div class="success-toast" id="successToast">
    <div class="success-toast-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
    <span class="success-toast-text" id="successToastText">Appointment reservation deleted successfully!</span>
    <button class="success-toast-close" onclick="hideSuccessToast()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>

  <style>
    /* Cancel Modal Styles */
    .cancel-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
    }

    .cancel-modal-overlay.show {
      display: block;
    }

    .cancel-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 10001;
      width: 450px;
      max-width: 90vw;
    }

    .cancel-modal.show {
      display: block;
    }

    .cancel-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
    }

    .cancel-modal-header h3 {
      margin: 0;
      font-size: 1.125rem;
      font-weight: 600;
      color: #111827;
    }

    .cancel-modal-close {
      background: none;
      border: none;
      padding: 4px;
      cursor: pointer;
      color: #6b7280;
      border-radius: 4px;
    }

    .cancel-modal-close:hover {
      background: #f3f4f6;
      color: #374151;
    }

    .cancel-modal-close svg {
      width: 20px;
      height: 20px;
    }

    .cancel-modal-body {
      padding: 24px;
    }

    .cancel-modal-question {
      margin: 0 0 20px 0;
      font-size: 0.9375rem;
      color: #374151;
    }

    .cancel-modal-options {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .cancel-option {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }

    .cancel-toggle {
      position: relative;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }

    .cancel-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #e5e7eb;
      border-radius: 24px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .cancel-toggle input:checked + .toggle-slider {
      background: #7c3aed;
    }

    .cancel-toggle input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }

    .cancel-option-text {
      font-size: 0.9375rem;
      color: #374151;
    }

    .cancel-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
    }

    .cancel-modal-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.15s;
    }

    .cancel-modal-btn-close {
      background: white;
      border: 1px solid #d1d5db;
      color: #374151;
    }

    .cancel-modal-btn-close:hover {
      background: #f9fafb;
    }

    .cancel-modal-btn-confirm {
      background: #ef4444;
      border: none;
      color: white;
    }

    .cancel-modal-btn-confirm:hover {
      background: #dc2626;
    }

    .cancel-modal-btn-confirm svg {
      width: 16px;
      height: 16px;
    }

    /* Success Toast Styles */
    .success-toast {
      display: none;
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      padding: 16px 20px;
      z-index: 10002;
      align-items: center;
      gap: 12px;
      border-left: 4px solid #10b981;
      animation: slideIn 0.3s ease-out;
    }

    .success-toast.show {
      display: flex;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .success-toast-icon {
      width: 24px;
      height: 24px;
      background: #10b981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .success-toast-icon svg {
      width: 14px;
      height: 14px;
      color: white;
    }

    .success-toast-text {
      font-size: 0.9375rem;
      color: #374151;
    }

    .success-toast-close {
      background: none;
      border: none;
      padding: 4px;
      cursor: pointer;
      color: #9ca3af;
      margin-left: 8px;
    }

    .success-toast-close:hover {
      color: #6b7280;
    }

    .success-toast-close svg {
      width: 16px;
      height: 16px;
    }
  </style>

  <script>
    // Cancel Modal Functions
    function openCancelModal() {
      // Reset checkboxes
      document.getElementById('cancelCreditCustomer').checked = false;
      document.getElementById('cancelSendEmail').checked = true;
      document.getElementById('cancelLateCancellation').checked = false;

      document.getElementById('cancelModalOverlay').classList.add('show');
      document.getElementById('cancelModal').classList.add('show');
    }

    function closeCancelModal() {
      document.getElementById('cancelModalOverlay').classList.remove('show');
      document.getElementById('cancelModal').classList.remove('show');
    }

    async function confirmCancelAppointment() {
      if (!selectedAppointment) return;

      const creditCustomer = document.getElementById('cancelCreditCustomer').checked;
      const sendEmail = document.getElementById('cancelSendEmail').checked;
      const lateCancellation = document.getElementById('cancelLateCancellation').checked;

      try {
        const response = await apiRequest(`/api/appointments/${selectedAppointment.id}/cancel`, {
          method: 'POST',
          body: JSON.stringify({
            reason: 'Cancelled by staff',
            credit_customer: creditCustomer,
            send_notification: sendEmail,
            late_cancellation: lateCancellation
          })
        });

        if (response) {
          closeCancelModal();
          closeAppointmentPanel();
          showSuccessToast('Appointment reservation deleted successfully!');
          await loadAppointments();
        }
      } catch (error) {
        console.error('Failed to cancel appointment:', error);
        alert('Failed to cancel appointment');
      }
    }

    // Success Toast Functions
    function showSuccessToast(message) {
      const toast = document.getElementById('successToast');
      const textEl = document.getElementById('successToastText');
      textEl.textContent = message;
      toast.classList.add('show');

      // Auto-hide after 5 seconds
      setTimeout(() => {
        hideSuccessToast();
      }, 5000);
    }

    function hideSuccessToast() {
      document.getElementById('successToast').classList.remove('show');
    }
  </script>
</body>
</html>
